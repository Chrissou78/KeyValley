<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Token Presale - Kea Valley</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#D4AF37',
                        'primary-dark': '#B8960C',
                        'primary-light': '#E5C76B',
                        'background-dark': '#0a0a0a',
                        'surface': '#121212',
                        'surface-light': '#1a1a1a'
                    },
                    fontFamily: {
                        'serif': ['Cormorant Garamond', 'serif'],
                        'sans': ['Montserrat', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0a0a0a;
            color: #ffffff;
            font-family: 'Montserrat', sans-serif;
        }
        .glass-card {
            background: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(212, 175, 55, 0.1);
        }
        .glass-nav {
            background-color: rgba(18, 18, 18, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
        }
        .gold-text {
            color: #D4AF37;
        }
        .gold-gradient {
            background: linear-gradient(135deg, #D4AF37 0%, #F4E5B0 50%, #D4AF37 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .btn-primary {
            background: linear-gradient(135deg, #D4AF37 0%, #B8960C 100%);
            color: #0a0a0a;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #E5C76B 0%, #D4AF37 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(212, 175, 55, 0.3);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .input-field {
            background-color: #1a1a1a !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff !important;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            border-color: #D4AF37;
            outline: none;
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }
        /* Fix autofill background */
        .input-field:-webkit-autofill,
        .input-field:-webkit-autofill:hover,
        .input-field:-webkit-autofill:focus,
        .input-field:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #1a1a1a inset !important;
            -webkit-text-fill-color: #ffffff !important;
            caret-color: #ffffff !important;
            transition: background-color 5000s ease-in-out 0s;
        }
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #1a1a1a inset !important;
            -webkit-text-fill-color: #ffffff !important;
            caret-color: #ffffff !important;
            transition: background-color 5000s ease-in-out 0s;
        }
        /* Force input background */
        input[type="number"] {
            background-color: #1a1a1a !important;
            color: #ffffff !important;
        }
        .payment-option {
            background: rgba(26, 26, 26, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .payment-option:hover {
            border-color: rgba(212, 175, 55, 0.5);
        }
        .payment-option.selected {
            border-color: #D4AF37;
            background: rgba(212, 175, 55, 0.1);
        }
        .progress-bar {
            background: linear-gradient(90deg, #D4AF37 0%, #E5C76B 100%);
            transition: width 0.5s ease;
        }
        .overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .fee-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(212, 175, 55, 0.2);
            color: #D4AF37;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="glass-nav fixed top-0 left-0 right-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="/" class="flex items-center space-x-3">
                    <img src="/logo.png" alt="Kea Valley" class="h-10 w-auto">
                    <span class="font-serif text-xl font-semibold gold-text">Kea Valley</span>
                </a>
                <nav class="hidden md:flex items-center space-x-8">
                    <a href="/" class="text-gray-300 hover:text-primary transition-colors">Home</a>
                    <a href="/claim" class="text-gray-300 hover:text-primary transition-colors">Claim Tokens</a>
                    <a href="/profile" class="text-gray-300 hover:text-primary transition-colors">Profile</a>
                </nav>
                <div id="wallet-section">
                    <button id="connect-wallet-btn" onclick="connectWallet()" class="btn-primary px-6 py-2 rounded-lg text-sm">
                        Connect Wallet
                    </button>
                    <div id="wallet-connected" class="hidden flex items-center space-x-3">
                        <span id="wallet-address" class="text-gray-300 text-sm"></span>
                        <button onclick="disconnectWallet()" class="text-gray-400 hover:text-primary transition-colors">
                            <span class="material-symbols-outlined">logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-24 pb-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-4xl mx-auto">
            <!-- Presale Header -->
            <div class="text-center mb-12">
                <h1 class="font-serif text-4xl md:text-5xl font-bold gold-gradient mb-4">VIP Token Presale</h1>
                <p class="text-gray-400 text-lg max-w-2xl mx-auto">
                    Acquire VIP tokens at the presale price and become part of the exclusive Kea Valley community.
                </p>
            </div>

            <!-- Progress Section -->
            <div class="glass-card rounded-2xl p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-400">Presale Progress</span>
                    <span id="progress-text" class="gold-text font-semibold">0 / 1,000,000 VIP</span>
                </div>
                <div class="w-full bg-surface-light rounded-full h-3 overflow-hidden">
                    <div id="progress-bar" class="progress-bar h-full rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-4 text-sm">
                    <span class="text-gray-500">Token Price: <span class="gold-text">â‚¬1.00</span></span>
                    <span id="remaining-text" class="text-gray-500">Remaining: <span class="text-white">1,000,000 VIP</span></span>
                </div>
            </div>

            <!-- Purchase Card -->
            <div class="glass-card rounded-2xl p-8">
                <!-- Token Amount Input -->
                <div class="mb-8">
                    <label class="block text-gray-300 text-sm font-medium mb-3">Token Amount</label>
                    <div class="relative">
                        <input type="number" id="token-amount" min="10" max="10000" value="100" 
                            class="input-field w-full pl-4 pr-20 py-4 rounded-xl text-lg"
                            oninput="updateTotals()"
                            style="background-color: #1a1a1a !important; color: #ffffff !important;">
                        <span class="absolute right-12 top-1/2 -translate-y-1/2 gold-text font-semibold pointer-events-none">VIP</span>
                    </div>
                    <p class="text-gray-500 text-sm mt-2">Min: 10 VIP | Max: 10,000 VIP</p>
                </div>

                <!-- Payment Method Selection -->
                <div class="mb-8">
                    <label class="block text-gray-300 text-sm font-medium mb-3">Payment Method</label>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="payment-option rounded-xl p-4 text-center selected" data-method="POL" onclick="selectPayment('POL')">
                            <div class="text-2xl mb-2">ðŸ’œ</div>
                            <div class="font-semibold text-white">POL</div>
                            <div class="text-gray-500 text-xs mt-1">Polygon Native</div>
                            <div class="fee-badge mt-2">1.5% fee</div>
                        </div>
                        <div class="payment-option rounded-xl p-4 text-center" data-method="USDC" onclick="selectPayment('USDC')">
                            <div class="text-2xl mb-2">ðŸ’µ</div>
                            <div class="font-semibold text-white">USDC</div>
                            <div class="text-gray-500 text-xs mt-1">Stablecoin</div>
                            <div class="fee-badge mt-2">1.5% fee</div>
                        </div>
                        <div class="payment-option rounded-xl p-4 text-center" data-method="Card" onclick="selectPayment('Card')">
                            <div class="text-2xl mb-2">ðŸ’³</div>
                            <div class="font-semibold text-white">Card</div>
                            <div class="text-gray-500 text-xs mt-1">Credit/Debit</div>
                            <div class="fee-badge mt-2">4% fee</div>
                        </div>
                    </div>
                </div>

                <!-- Balance Display -->
                <div id="balance-section" class="mb-8 hidden">
                    <div class="flex items-center justify-between p-4 bg-surface-light rounded-xl">
                        <span class="text-gray-400">Your Balance:</span>
                        <span id="balance-display" class="font-semibold text-white">--</span>
                    </div>
                </div>

                <!-- Total Section - All in EUR with USD equivalent -->
                <div class="border-t border-white/10 pt-6 mb-8">
                    <div class="space-y-3">
                        <div class="flex justify-between text-gray-400">
                            <span>Tokens</span>
                            <span id="totalTokensDisplay" class="text-white">100 VIP</span>
                        </div>
                        <div class="flex justify-between text-gray-400">
                            <span>Token Price</span>
                            <span class="text-white">â‚¬1.00 / VIP</span>
                        </div>
                        <div class="flex justify-between text-gray-400">
                            <span>Subtotal</span>
                            <span id="subtotalEUR" class="text-white">â‚¬100.00</span>
                        </div>
                        <div class="flex justify-between text-gray-400">
                            <span>Payment Fee (<span id="feePercent">1.5</span>%)</span>
                            <span id="feeAmountEUR" class="text-white">â‚¬1.50</span>
                        </div>
                        <div class="flex justify-between text-lg font-semibold border-t border-white/10 pt-3">
                            <span class="gold-text">Total</span>
                            <span class="gold-text">
                                <span id="totalEUR">â‚¬101.50</span>
                                <span id="totalUSD" class="text-sm text-gray-400 ml-2">($120.79)</span>
                            </span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>You Pay (approx)</span>
                            <span id="cryptoEquivalent">~1006.6 POL</span>
                        </div>
                    </div>
                </div>

                <!-- SEPA Info -->
                <div class="mb-8 p-4 bg-surface-light rounded-xl border border-white/5">
                    <div class="flex items-start space-x-3">
                        <span class="material-symbols-outlined text-primary">account_balance</span>
                        <div>
                            <p class="text-gray-300 text-sm">
                                <strong>Prefer bank transfer?</strong> Direct SEPA transfers are available. 
                                <a href="mailto:julie.meyer@vivapartners.net?subject=VIP%20Presale%20-%20SEPA%20Transfer%20Request" class="gold-text hover:underline">Contact us</a> for bank details.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Buy Button -->
                <button id="buy-button" onclick="executePurchase()" class="btn-primary w-full py-4 rounded-xl text-lg font-semibold" disabled>
                    Connect Wallet to Purchase
                </button>

                <!-- Referral Code Section -->
                <div id="referral-section" class="mt-6 hidden">
                    <div class="flex items-center space-x-2 p-3 bg-surface-light rounded-xl">
                        <span class="material-symbols-outlined text-primary">card_giftcard</span>
                        <span class="text-gray-400 text-sm">Referral Code:</span>
                        <span id="referral-code" class="gold-text font-semibold"></span>
                    </div>
                </div>
            </div>

            <!-- Token Info -->
            <div class="mt-8 text-center">
                <a href="https://polygonscan.com/token/0x6860c34db140DB7B589DaDA38859a1d3736bbE3F" target="_blank" 
                    class="inline-flex items-center space-x-2 text-gray-400 hover:text-primary transition-colors">
                    <span class="material-symbols-outlined">open_in_new</span>
                    <span>View Contract on Polygonscan</span>
                </a>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-surface py-12 md:py-16 border-t border-white/5">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center space-x-3 mb-6 md:mb-0">
                    <img src="/logo.png" alt="Kea Valley" class="h-8 w-auto">
                    <span class="font-serif text-lg gold-text">Kea Valley</span>
                </div>
                <div class="text-gray-500 text-sm">
                    Â© 2025 Kea Valley. All rights reserved.
                </div>
            </div>
        </div>
    </footer>

    <!-- Connect Wallet Overlay -->
    <div id="connect-overlay" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <span class="material-symbols-outlined text-5xl gold-text mb-4">account_balance_wallet</span>
            <h3 class="text-2xl font-serif font-bold mb-4">Connect Your Wallet</h3>
            <p class="text-gray-400 mb-6">Please connect your WalletTwo wallet to participate in the presale.</p>
            <button onclick="redirectToWalletTwo()" class="btn-primary w-full py-3 rounded-xl font-semibold mb-3">
                Connect with WalletTwo
            </button>
            <button onclick="hideConnectOverlay()" class="text-gray-400 hover:text-white transition-colors">
                Cancel
            </button>
        </div>
    </div>

    <!-- Presale Inactive Overlay -->
    <div id="presale-inactive-overlay" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <span class="material-symbols-outlined text-5xl text-yellow-500 mb-4">schedule</span>
            <h3 class="text-2xl font-serif font-bold mb-4">Presale Not Active</h3>
            <p class="text-gray-400 mb-6">The presale is currently not active. Please check back later or follow our announcements.</p>
            <a href="/" class="btn-primary inline-block px-8 py-3 rounded-xl font-semibold">
                Return Home
            </a>
        </div>
    </div>

    <!-- Processing Overlay -->
    <div id="processing-overlay" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <div class="animate-spin w-16 h-16 border-4 border-primary border-t-transparent rounded-full mx-auto mb-6"></div>
            <h3 class="text-2xl font-serif font-bold mb-4">Processing Purchase</h3>
            <p id="processing-message" class="text-gray-400">Verifying your payment...</p>
        </div>
    </div>

    <!-- Result Overlay -->
    <div id="result-overlay" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <span id="result-icon" class="material-symbols-outlined text-5xl mb-4"></span>
            <h3 id="result-title" class="text-2xl font-serif font-bold mb-4"></h3>
            <p id="result-message" class="text-gray-400 mb-6"></p>
            <div id="result-details" class="text-left mb-6 hidden">
                <div class="bg-surface-light rounded-xl p-4 space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Tokens:</span>
                        <span id="result-tokens" class="text-white font-semibold"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Payment TX:</span>
                        <a id="result-payment-tx" href="#" target="_blank" class="gold-text hover:underline truncate ml-2"></a>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Mint TX:</span>
                        <a id="result-mint-tx" href="#" target="_blank" class="gold-text hover:underline truncate ml-2"></a>
                    </div>
                </div>
            </div>
            <button onclick="hideResultOverlay()" class="btn-primary w-full py-3 rounded-xl font-semibold">
                Continue
            </button>
        </div>
    </div>

    <!-- Stripe Modal -->
    <div id="stripe-modal" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-serif font-bold">Complete Payment</h3>
                <button onclick="closeStripeModal()" class="text-gray-400 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            
            <!-- Order Summary -->
            <div class="bg-surface-light rounded-xl p-4 mb-6">
                <h4 class="text-sm text-gray-400 mb-3">Order Summary</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">VIP Tokens</span>
                        <span id="stripe-tokens" class="text-white">100 VIP</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Subtotal</span>
                        <span id="stripe-subtotal" class="text-white">â‚¬100.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Payment Fee (4%)</span>
                        <span id="stripe-fee" class="text-white">â‚¬4.00</span>
                    </div>
                    <div class="flex justify-between font-semibold border-t border-white/10 pt-2 mt-2">
                        <span class="gold-text">Total</span>
                        <span id="stripe-total" class="gold-text">â‚¬104.00</span>
                    </div>
                </div>
            </div>

            <form id="stripe-form">
                <div id="card-element" class="input-field p-4 rounded-xl mb-4"></div>
                <div id="card-errors" class="text-red-500 text-sm mb-4 hidden"></div>
                <button type="submit" id="stripe-submit" class="btn-primary w-full py-3 rounded-xl font-semibold">
                    Pay â‚¬<span id="stripe-amount">104.00</span>
                </button>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            tokenAddress: '0x6860c34db140DB7B589DaDA38859a1d3736bbE3F',
            tokenName: 'Kea Valley VIP',
            tokenSymbol: 'VIP',
            tokenDecimals: 18,
            chainId: 137,
            rpcUrl: 'https://polygon-rpc.com',
            explorer: 'https://polygonscan.com',
            usdcAddress: '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359',
            usdcDecimals: 6,
            walletTwoOrigin: 'https://wallet.wallettwo.com',
            minterWallet: '0xdD4104A780142EfB9566659f26d3317714a81510',
            // Presale defaults (overridden by API)
            totalTokens: 1000000,
            tokensSold: 0,
            tokenPriceEUR: 1.00,
            eurUsdRate: 1.19,
            polPrice: 0.12,
            presaleEnabled: true,
            presaleWallet: null,
            minPurchase: 10,
            maxPurchase: 10000,
            // Fees
            cryptoFeePercent: 1.5,
            cardFeePercent: 4
        };

        let currentWallet = null;
        let selectedPayment = 'POL';
        let balances = { POL: 0, USDC: 0 };
        let stripe = null;
        let cardElement = null;
        let sessionData = null;

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            await loadPresaleConfig();
            checkWalletConnection();
            checkUrlParams();
            updateTotals();
        });

        async function loadPresaleConfig() {
            try {
                const response = await fetch('/api/presale/config');
                if (response.ok) {
                    const data = await response.json();
                    CONFIG.totalTokens = data.totalTokens || CONFIG.totalTokens;
                    CONFIG.tokensSold = data.tokensSold || 0;
                    CONFIG.tokenPriceEUR = data.tokenPrice || CONFIG.tokenPriceEUR;
                    CONFIG.eurUsdRate = data.eurUsdRate || CONFIG.eurUsdRate;
                    CONFIG.polPrice = data.polPrice || CONFIG.polPrice;
                    CONFIG.presaleEnabled = data.presaleEnabled !== false;
                    CONFIG.presaleWallet = data.presaleWallet || CONFIG.presaleWallet;
                    CONFIG.minPurchase = data.minPurchase || CONFIG.minPurchase;
                    CONFIG.maxPurchase = data.maxPurchase || CONFIG.maxPurchase;
                    CONFIG.stripePublicKey = data.stripePublicKey;  // ADD THIS
                    
                    updateProgress();
                    initStripe();  // INIT STRIPE AFTER CONFIG LOADS
                }
            } catch (error) {
                console.error('Failed to load presale config:', error);
            }

            if (!CONFIG.presaleEnabled) {
                document.getElementById('presale-inactive-overlay').classList.remove('hidden');
            }
        }

        function initStripe() {
            if (!CONFIG.stripePublicKey) {
                console.log('âš ï¸ Stripe key not loaded yet');
                return;
            }
            
            if (typeof Stripe !== 'undefined') {
                stripe = Stripe(CONFIG.stripePublicKey);
                const elements = stripe.elements();
                
                // Clear any existing content
                const cardContainer = document.getElementById('card-element');
                if (cardContainer) {
                    cardContainer.innerHTML = '';
                }
                
                cardElement = elements.create('card', {
                    hidePostalCode: true,
                    style: {
                        base: {
                            color: '#ffffff',
                            fontFamily: 'Montserrat, sans-serif',
                            fontSize: '16px',
                            '::placeholder': { color: '#6b7280' }
                        },
                        invalid: { color: '#ef4444' }
                    }
                });
                cardElement.mount('#card-element');
                
                // Disable submit button initially
                const submitBtn = document.getElementById('stripe-submit');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                
                // Listen for card changes
                cardElement.on('change', (event) => {
                    const submitBtn = document.getElementById('stripe-submit');
                    const errorDisplay = document.getElementById('card-errors');
                    
                    if (event.error) {
                        if (errorDisplay) {
                            errorDisplay.textContent = event.error.message;
                            errorDisplay.classList.remove('hidden');
                        }
                        if (submitBtn) {
                            submitBtn.disabled = true;
                            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        }
                    } else {
                        if (errorDisplay) {
                            errorDisplay.textContent = '';
                            errorDisplay.classList.add('hidden');
                        }
                        
                        if (submitBtn) {
                            if (event.complete) {
                                // Card is complete and valid - enable button
                                submitBtn.disabled = false;
                                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                            } else {
                                // Card is incomplete - keep disabled
                                submitBtn.disabled = true;
                                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                            }
                        }
                    }
                });                
                console.log('âœ… Stripe initialized with key:', CONFIG.stripePublicKey.slice(0, 12) + '...');
            }
        }
        // ============================================
        // WALLET CONNECTION
        // ============================================
        function checkWalletConnection() {
            // Try both sessionStorage and localStorage
            let profile = sessionStorage.getItem('keavalley_profile') || localStorage.getItem('keavalley_profile');
            
            console.log('ðŸ” Checking wallet connection...');
            
            if (profile) {
                try {
                    sessionData = JSON.parse(profile);
                    // Check ALL possible key names
                    const wallet = sessionData.wallet || sessionData.walletAddress || sessionData.address || sessionData.wallet_address;
                    
                    if (wallet) {
                        currentWallet = wallet.toLowerCase();
                        showWalletConnected();
                        loadBalances();
                        checkReferralCode();
                        console.log('âœ… Wallet connected:', currentWallet);
                        return;
                    }
                } catch (e) {
                    console.error('âŒ Failed to parse session:', e);
                }
            }
            
            console.log('âŒ No wallet found in storage');
        }

        function connectWallet() {
            document.getElementById('connect-overlay').classList.remove('hidden');
        }

        function hideConnectOverlay() {
            document.getElementById('connect-overlay').classList.add('hidden');
        }

        function redirectToWalletTwo() {
            const redirectUri = encodeURIComponent(window.location.href);
            window.location.href = `${CONFIG.walletTwoOrigin}/auth/login?companyId=6a27c2f8-894c-46c7-bf9f-f5af11d4e092&action=signature&message=VIP_PRESALE&redirect_uri=${redirectUri}`;
        }

        function showWalletConnected() {
            document.getElementById('connect-wallet-btn').classList.add('hidden');
            document.getElementById('wallet-connected').classList.remove('hidden');
            document.getElementById('wallet-address').textContent = 
                currentWallet.slice(0, 6) + '...' + currentWallet.slice(-4);
            document.getElementById('balance-section').classList.remove('hidden');
            updateBuyButton();
        }

        function disconnectWallet() {
            sessionStorage.removeItem('keavalley_profile');
            localStorage.removeItem('keavalley_profile');
            currentWallet = null;
            sessionData = null;
            document.getElementById('connect-wallet-btn').classList.remove('hidden');
            document.getElementById('wallet-connected').classList.add('hidden');
            document.getElementById('balance-section').classList.add('hidden');
            updateBuyButton();
        }

        async function loadBalances() {
            if (!currentWallet) return;

            // List of fallback RPCs
            const rpcUrls = [
                'https://polygon-bor-rpc.publicnode.com',
                'https://polygon.llamarpc.com',
                'https://rpc.ankr.com/polygon',
                'https://polygon-rpc.com',
                'https://polygon-mainnet.g.alchemy.com/v2/IoufBRdGO6MKWC6pxqbZW'
            ];

            for (const rpcUrl of rpcUrls) {
                try {
                    console.log(`ðŸ”„ Trying RPC: ${rpcUrl}`);
                    const provider = new ethers.JsonRpcProvider(rpcUrl);
                    
                    // POL Balance
                    const polBalance = await provider.getBalance(currentWallet);
                    balances.POL = parseFloat(ethers.formatEther(polBalance));

                    // USDC Balance
                    const usdcContract = new ethers.Contract(
                        CONFIG.usdcAddress,
                        ['function balanceOf(address) view returns (uint256)'],
                        provider
                    );
                    const usdcBalance = await usdcContract.balanceOf(currentWallet);
                    balances.USDC = parseFloat(ethers.formatUnits(usdcBalance, CONFIG.usdcDecimals));

                    console.log(`âœ… Balances loaded - POL: ${balances.POL}, USDC: ${balances.USDC}`);
                    updateBalanceDisplay();
                    return; // Success, exit loop
                    
                } catch (error) {
                    console.warn(`âš ï¸ RPC ${rpcUrl} failed:`, error.message);
                    continue; // Try next RPC
                }
            }
            
            console.error('âŒ All RPCs failed to load balances');
            // Set default values so UI doesn't break
            balances.POL = 0;
            balances.USDC = 0;
            updateBalanceDisplay();
        }

        function updateBalanceDisplay() {
            const display = document.getElementById('balance-display');
            if (selectedPayment === 'POL') {
                display.textContent = `${balances.POL.toFixed(4)} POL`;
            } else if (selectedPayment === 'USDC') {
                display.textContent = `${balances.USDC.toFixed(2)} USDC`;
            } else {
                display.textContent = '--';
            }
        }

        // ============================================
        // PAYMENT SELECTION
        // ============================================
        function selectPayment(method) {
            selectedPayment = method;
            document.querySelectorAll('.payment-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.method === method);
            });
            updateBalanceDisplay();
            updateTotals();
            updateBuyButton();
        }

        // ============================================
        // CALCULATIONS - All in EUR with USD equivalent
        // ============================================
        function updateTotals() {
            const tokenAmount = parseInt(document.getElementById('token-amount').value) || 0;
            const baseEUR = tokenAmount * CONFIG.tokenPriceEUR;
            
            // Fee based on payment method
            const feePercent = selectedPayment === 'Card' ? CONFIG.cardFeePercent : CONFIG.cryptoFeePercent;
            const feeEUR = baseEUR * (feePercent / 100);
            const totalEUR = baseEUR + feeEUR;
            const totalUSD = totalEUR * CONFIG.eurUsdRate;

            // Update display - All in EUR
            document.getElementById('totalTokensDisplay').textContent = `${tokenAmount.toLocaleString()} VIP`;
            document.getElementById('subtotalEUR').textContent = `â‚¬${baseEUR.toFixed(2)}`;
            document.getElementById('feePercent').textContent = feePercent.toFixed(1);
            document.getElementById('feeAmountEUR').textContent = `â‚¬${feeEUR.toFixed(2)}`;
            document.getElementById('totalEUR').textContent = `â‚¬${totalEUR.toFixed(2)}`;
            document.getElementById('totalUSD').textContent = `($${totalUSD.toFixed(2)})`;

            // Crypto equivalent (what they actually pay)
            if (selectedPayment === 'POL') {
                const polAmount = totalUSD / CONFIG.polPrice;
                document.getElementById('cryptoEquivalent').textContent = `~${polAmount.toFixed(2)} POL`;
            } else if (selectedPayment === 'USDC') {
                document.getElementById('cryptoEquivalent').textContent = `~${totalUSD.toFixed(2)} USDC`;
            } else {
                document.getElementById('cryptoEquivalent').textContent = `â‚¬${totalEUR.toFixed(2)}`;
            }

            updateBuyButton();
        }

        function updateBuyButton() {
            const btn = document.getElementById('buy-button');
            const tokenAmount = parseInt(document.getElementById('token-amount').value) || 0;

            if (!currentWallet) {
                btn.textContent = 'Connect Wallet to Purchase';
                btn.disabled = true;
                return;
            }

            if (!CONFIG.presaleEnabled) {
                btn.textContent = 'Presale Not Active';
                btn.disabled = true;
                return;
            }

            if (tokenAmount < CONFIG.minPurchase) {
                btn.textContent = `Minimum ${CONFIG.minPurchase} VIP`;
                btn.disabled = true;
                return;
            }

            if (tokenAmount > CONFIG.maxPurchase) {
                btn.textContent = `Maximum ${CONFIG.maxPurchase} VIP`;
                btn.disabled = true;
                return;
            }

            const baseEUR = tokenAmount * CONFIG.tokenPriceEUR;
            const feePercent = selectedPayment === 'Card' ? CONFIG.cardFeePercent : CONFIG.cryptoFeePercent;
            const totalEUR = baseEUR * (1 + feePercent / 100);
            const totalUSD = totalEUR * CONFIG.eurUsdRate;

            if (selectedPayment === 'Card') {
                btn.textContent = `Pay â‚¬${totalEUR.toFixed(2)}`;
                btn.disabled = false;
            } else if (selectedPayment === 'POL') {
                const requiredPOL = totalUSD / CONFIG.polPrice;
                if (balances.POL >= requiredPOL) {
                    btn.textContent = `Pay ~${requiredPOL.toFixed(2)} POL`;
                    btn.disabled = false;
                } else {
                    btn.textContent = 'Insufficient POL Balance';
                    btn.disabled = true;
                }
            } else if (selectedPayment === 'USDC') {
                if (balances.USDC >= totalUSD) {
                    btn.textContent = `Pay ~${totalUSD.toFixed(2)} USDC`;
                    btn.disabled = false;
                } else {
                    btn.textContent = 'Insufficient USDC Balance';
                    btn.disabled = true;
                }
            }
        }

        function updateProgress() {
            const percent = (CONFIG.tokensSold / CONFIG.totalTokens) * 100;
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').textContent = 
                `${CONFIG.tokensSold.toLocaleString()} / ${CONFIG.totalTokens.toLocaleString()} VIP`;
            document.getElementById('remaining-text').innerHTML = 
                `Remaining: <span class="text-white">${(CONFIG.totalTokens - CONFIG.tokensSold).toLocaleString()} VIP</span>`;
        }

        // ============================================
        // PURCHASE EXECUTION
        // ============================================
        async function executePurchase() {
            if (!currentWallet) {
                connectWallet();
                return;
            }

            if (!CONFIG.presaleEnabled) {
                showResult('error', 'Presale Not Active', 'The presale is currently not available.');
                return;
            }

            const tokenAmount = parseInt(document.getElementById('token-amount').value) || 0;

            if (tokenAmount < CONFIG.minPurchase || tokenAmount > CONFIG.maxPurchase) {
                showResult('error', 'Invalid Amount', `Please enter between ${CONFIG.minPurchase} and ${CONFIG.maxPurchase} VIP tokens.`);
                return;
            }

            const baseEUR = tokenAmount * CONFIG.tokenPriceEUR;
            const feePercent = selectedPayment === 'Card' ? CONFIG.cardFeePercent : CONFIG.cryptoFeePercent;
            const feeEUR = baseEUR * (feePercent / 100);
            const totalEUR = baseEUR + feeEUR;
            const totalUSD = totalEUR * CONFIG.eurUsdRate;

            // Store pending purchase
            const pendingPurchase = {
                walletAddress: currentWallet,
                tokenAmount,
                baseEUR,
                feeEUR,
                totalEUR,
                totalUSD,
                paymentMethod: selectedPayment,
                timestamp: Date.now()
            };
            localStorage.setItem('pendingPurchase', JSON.stringify(pendingPurchase));

            if (selectedPayment === 'Card') {
                if (!stripe) {
                    showResult('error', 'Payment Error', 'Card payments are not configured. Please try crypto payment or contact us for SEPA transfer.');
                    return;
                }
                openStripeCheckout(tokenAmount, baseEUR, feeEUR, totalEUR);
            } else {
                // Crypto payment via WalletTwo multi-transaction
                executeCryptoPurchase(tokenAmount, totalUSD, baseEUR, feeEUR);
            }
        }

        function executeCryptoPurchase(tokenAmount, totalUSD, baseEUR, feeEUR) {
            const baseUSD = baseEUR * CONFIG.eurUsdRate;
            const feeUSD = feeEUR * CONFIG.eurUsdRate;

            if (!CONFIG.presaleWallet) {
                showResult('error', 'Configuration Error', 'Presale wallet not configured. Please contact support.');
                return;
            }

            let transactions = [];
            const externalId = `presale-${Date.now()}`;
            const redirectUri = encodeURIComponent(`${window.location.origin}/presale?purchase=complete`);

            if (selectedPayment === 'USDC') {
                // USDC: 6 decimals
                const baseUsdcAmount = Math.floor(baseUSD * 1e6);
                const feeUsdcAmount = Math.ceil(feeUSD * 1e6);

                transactions = [
                    {
                        type: 'erc20_transfer',
                        token: CONFIG.usdcAddress,
                        to: CONFIG.presaleWallet,
                        amount: baseUsdcAmount.toString(),
                        description: `VIP Presale: ${baseUSD.toFixed(2)} USDC`
                    },
                    {
                        type: 'erc20_transfer',
                        token: CONFIG.usdcAddress,
                        to: CONFIG.minterWallet,
                        amount: feeUsdcAmount.toString(),
                        description: `Platform fee: ${feeUSD.toFixed(2)} USDC`
                    }
                ];
            } else {
                // POL: 18 decimals
                const basePOL = baseUSD / CONFIG.polPrice;
                const feePOL = feeUSD / CONFIG.polPrice;
                const baseWei = BigInt(Math.floor(basePOL * 1e18)).toString();
                const feeWei = BigInt(Math.ceil(feePOL * 1e18)).toString();

                transactions = [
                    {
                        type: 'native_transfer',
                        to: CONFIG.presaleWallet,
                        amount: baseWei,
                        description: `VIP Presale: ${basePOL.toFixed(4)} POL`
                    },
                    {
                        type: 'native_transfer',
                        to: CONFIG.minterWallet,
                        amount: feeWei,
                        description: `Platform fee: ${feePOL.toFixed(4)} POL`
                    }
                ];
            }

            // Redirect to WalletTwo for multi-transaction
            const txData = encodeURIComponent(JSON.stringify({
                chainId: CONFIG.chainId,
                transactions,
                metadata: {
                    type: 'presale_purchase',
                    tokenAmount,
                    totalUSD,
                    baseEUR,
                    feeEUR,
                    paymentMethod: selectedPayment
                }
            }));

            window.location.href = `${CONFIG.walletTwoOrigin}/transaction/multi?data=${txData}&external_id=${externalId}&redirect_uri=${redirectUri}`;
        }

        // ============================================
        // STRIPE CHECKOUT
        // ============================================
        function openStripeCheckout(tokenAmount, baseEUR, feeEUR, totalEUR) {
            // Update modal content
            const setTextContent = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            setTextContent('stripe-tokens', `${tokenAmount} VIP`);
            setTextContent('stripe-subtotal', `â‚¬${baseEUR.toFixed(2)}`);
            setTextContent('stripe-fee', `â‚¬${feeEUR.toFixed(2)}`);
            setTextContent('stripe-total', `â‚¬${totalEUR.toFixed(2)}`);
            setTextContent('stripe-amount', totalEUR.toFixed(2));

            // ALWAYS disable submit button when opening modal
            const submitBtn = document.getElementById('stripe-submit');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            // Clear any previous errors
            const errorDisplay = document.getElementById('card-errors');
            if (errorDisplay) {
                errorDisplay.textContent = '';
                errorDisplay.classList.add('hidden');
            }
            
            // Clear the card element
            if (cardElement) {
                cardElement.clear();
            }

            // Show modal
            document.getElementById('stripe-modal').classList.remove('hidden');

            // Create payment intent (but don't enable button - card change event will do that)
            createPaymentIntent(tokenAmount, totalEUR);
        }

        async function createPaymentIntent(tokenAmount, totalEUR) {
            try {
                const response = await fetch('/api/presale/create-payment-intent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        walletAddress: currentWallet,
                        tokenAmount,
                        totalEUR,
                        email: sessionData?.email
                    })
                });

                if (!response.ok) throw new Error('Failed to create payment intent');

                const data = await response.json();
                localStorage.setItem('stripePaymentData', JSON.stringify({
                    clientSecret: data.clientSecret,
                    paymentIntentId: data.paymentIntentId,
                    tokenAmount,
                    totalEUR
                }));

            } catch (error) {
                console.error('Payment intent error:', error);
                showResult('error', 'Payment Error', 'Failed to initialize payment. Please try again.');
                closeStripeModal();
            }
        }

        function closeStripeModal() {
            document.getElementById('stripe-modal').classList.add('hidden');
        }

        // Stripe form submission
        document.getElementById('stripe-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('stripe-submit');
            
            // Don't proceed if button is disabled
            if (submitBtn.disabled) {
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            const paymentData = JSON.parse(localStorage.getItem('stripePaymentData') || '{}');

            if (!paymentData.clientSecret) {
                document.getElementById('card-errors').textContent = 'Payment not initialized. Please try again.';
                document.getElementById('card-errors').classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = `Pay â‚¬${paymentData.totalEUR?.toFixed(2) || '0.00'}`;
                return;
            }

            try {
                const { error, paymentIntent } = await stripe.confirmCardPayment(
                    paymentData.clientSecret,
                    { payment_method: { card: cardElement } }
                );

                if (error) {
                    document.getElementById('card-errors').textContent = error.message;
                    document.getElementById('card-errors').classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    submitBtn.textContent = `Pay â‚¬${paymentData.totalEUR?.toFixed(2) || '0.00'}`;
                } else if (paymentIntent.status === 'succeeded') {
                    closeStripeModal();
                    showProcessing('Verifying payment and minting tokens...');
                    verifyStripePayment(paymentIntent.id, paymentData.tokenAmount);
                }
            } catch (error) {
                console.error('Stripe error:', error);
                document.getElementById('card-errors').textContent = error.message;
                document.getElementById('card-errors').classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                submitBtn.textContent = `Pay â‚¬${paymentData.totalEUR?.toFixed(2) || '0.00'}`;
            }
        });

        async function verifyStripePayment(paymentIntentId, tokenAmount) {
            try {
                showProcessing('Payment received! Minting your tokens...');
                
                let attempts = 0;
                const maxAttempts = 60;
                
                while (attempts < maxAttempts) {
                    try {
                        const response = await fetch(`/api/presale/purchase-status/${paymentIntentId}`);
                        if (response.ok) {
                            const data = await response.json();
                            console.log(`ðŸ”„ Poll ${attempts + 1}: ${data.status}`);
                            
                            if (data.status === 'completed' && data.mintTxHash) {
                                hideProcessing();
                                showResult('success', 'Purchase Complete!', 
                                    `Successfully purchased ${tokenAmount} VIP tokens!`,
                                    { tokens: tokenAmount, mintTx: data.mintTxHash }
                                );
                                localStorage.removeItem('pendingPurchase');
                                localStorage.removeItem('stripePaymentData');
                                loadPresaleConfig();
                                return;
                            }
                            
                            if (data.status === 'mint_failed' || data.status === 'failed') {
                                hideProcessing();
                                showResult('error', 'Minting Failed', data.error || 'Please contact presale@kea-valley.com');
                                return;
                            }
                        }
                    } catch (e) {
                        console.warn('Poll error:', e);
                    }
                    
                    attempts++;
                    await new Promise(r => setTimeout(r, 1000));
                }
                
                hideProcessing();
                showResult('info', 'Processing', 'Payment received. Tokens will arrive shortly. Check your profile in a few minutes.');
                localStorage.removeItem('pendingPurchase');
                localStorage.removeItem('stripePaymentData');
                
            } catch (error) {
                hideProcessing();
                showResult('error', 'Error', error.message);
            }
        }
        // ============================================
        // URL PARAMS & CRYPTO VERIFICATION
        // ============================================
        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            
            if (params.get('purchase') === 'complete') {
                const txHash = params.get('tx_hash');
                if (txHash) {
                    showProcessing('Verifying crypto payment...');
                    verifyCryptoPayment(txHash);
                }
            }

            // Check for referral code in URL
            const ref = params.get('ref');
            if (ref) {
                localStorage.setItem('referralCode', ref);
            }
        }

        async function verifyCryptoPayment(txHash) {
            try {
                const pendingPurchase = JSON.parse(localStorage.getItem('pendingPurchase') || '{}');

                const response = await fetch('/api/presale/verify-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        txHash,
                        walletAddress: currentWallet || pendingPurchase.walletAddress,
                        tokenAmount: pendingPurchase.tokenAmount,
                        totalEUR: pendingPurchase.totalEUR,
                        totalUSD: pendingPurchase.totalUSD,
                        paymentMethod: pendingPurchase.paymentMethod,
                        referrerCode: localStorage.getItem('referralCode')
                    })
                });

                const data = await response.json();
                hideProcessing();

                if (data.success) {
                    showResult('success', 'Purchase Complete!',
                        data.message || `Successfully purchased ${pendingPurchase.tokenAmount} VIP tokens!`,
                        { 
                            tokens: pendingPurchase.tokenAmount, 
                            paymentTx: txHash, 
                            mintTx: data.mintTxHash 
                        }
                    );
                    localStorage.removeItem('pendingPurchase');
                    localStorage.removeItem('referralCode');
                    loadPresaleConfig();
                } else {
                    showResult('error', 'Verification Failed', data.error || 'Please contact support.');
                }

                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);

            } catch (error) {
                hideProcessing();
                showResult('error', 'Verification Error', error.message);
            }
        }

        // ============================================
        // REFERRAL
        // ============================================
        async function checkReferralCode() {
            const savedCode = localStorage.getItem('referralCode');
            if (savedCode && currentWallet) {
                try {
                    const response = await fetch(`/api/referral/validate/${savedCode}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.valid) {
                            document.getElementById('referral-section').classList.remove('hidden');
                            document.getElementById('referral-code').textContent = savedCode;
                        }
                    }
                } catch (e) {
                    console.error('Referral validation failed:', e);
                }
            }
        }

        // ============================================
        // UI HELPERS
        // ============================================
        function showProcessing(message) {
            document.getElementById('processing-message').textContent = message;
            document.getElementById('processing-overlay').classList.remove('hidden');
        }

        function hideProcessing() {
            document.getElementById('processing-overlay').classList.add('hidden');
        }

        function showResult(type, title, message, details = null) {
            const icon = document.getElementById('result-icon');
            icon.textContent = type === 'success' ? 'check_circle' : 'error';
            icon.className = `material-symbols-outlined text-5xl mb-4 ${type === 'success' ? 'text-green-500' : 'text-red-500'}`;
            
            document.getElementById('result-title').textContent = title;
            document.getElementById('result-message').textContent = message;

            if (details) {
                document.getElementById('result-details').classList.remove('hidden');
                document.getElementById('result-tokens').textContent = `${details.tokens} VIP`;
                
                if (details.paymentTx) {
                    document.getElementById('result-payment-tx').href = `${CONFIG.explorer}/tx/${details.paymentTx}`;
                    document.getElementById('result-payment-tx').textContent = details.paymentTx.slice(0, 10) + '...';
                }
                if (details.mintTx) {
                    document.getElementById('result-mint-tx').href = `${CONFIG.explorer}/tx/${details.mintTx}`;
                    document.getElementById('result-mint-tx').textContent = details.mintTx.slice(0, 10) + '...';
                }
            } else {
                document.getElementById('result-details').classList.add('hidden');
            }

            document.getElementById('result-overlay').classList.remove('hidden');
        }

        function hideResultOverlay() {
            document.getElementById('result-overlay').classList.add('hidden');
        }
    </script>
</body>
</html>
