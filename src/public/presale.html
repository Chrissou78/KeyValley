<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Token Presale - Kea Valley</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#D4AF37',
                        'primary-dark': '#B8960C',
                        'primary-light': '#E5C76B',
                        'background-dark': '#0a0a0a',
                        'surface': '#121212',
                        'surface-light': '#1a1a1a'
                    },
                    fontFamily: {
                        'serif': ['Cormorant Garamond', 'serif'],
                        'sans': ['Montserrat', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0a0a0a; color: #ffffff; font-family: 'Montserrat', sans-serif; }
        .glass-card { background: rgba(18, 18, 18, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(212, 175, 55, 0.1); }
        .glass-nav { background-color: rgba(18, 18, 18, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(212, 175, 55, 0.1); }
        .gold-text { color: #D4AF37; }
        .gold-gradient { background: linear-gradient(135deg, #D4AF37 0%, #F4E5B0 50%, #D4AF37 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .btn-primary { background: linear-gradient(135deg, #D4AF37 0%, #B8960C 100%); color: #0a0a0a; font-weight: 600; transition: all 0.3s ease; }
        .btn-primary:hover:not(:disabled) { background: linear-gradient(135deg, #E5C76B 0%, #D4AF37 100%); transform: translateY(-2px); box-shadow: 0 10px 40px rgba(212, 175, 55, 0.3); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .input-field { background-color: #1a1a1a !important; border: 1px solid rgba(255, 255, 255, 0.1); color: #ffffff !important; transition: all 0.3s ease; }
        .input-field:focus { border-color: #D4AF37; outline: none; box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2); }
        .input-field:-webkit-autofill { -webkit-box-shadow: 0 0 0 30px #1a1a1a inset !important; -webkit-text-fill-color: #ffffff !important; }
        .payment-option { background: rgba(26, 26, 26, 0.6); border: 2px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; cursor: pointer; }
        .payment-option:hover { border-color: rgba(212, 175, 55, 0.5); }
        .payment-option.selected { border-color: #D4AF37; background: rgba(212, 175, 55, 0.1); }
        .progress-bar { background: linear-gradient(90deg, #D4AF37 0%, #E5C76B 100%); transition: width 0.5s ease; }
        .overlay { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fee-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; background: rgba(212, 175, 55, 0.2); color: #D4AF37; }
        #card-element, .StripeElement { background-color: #1a1a1a !important; }
    </style>
</head>
<body class="min-h-screen">
    <header class="glass-nav fixed top-0 left-0 right-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="/" class="flex items-center space-x-3">
                    <img src="/logo.png" alt="Kea Valley" class="h-10 w-auto">
                    <span class="font-serif text-xl font-semibold gold-text">Kea Valley</span>
                </a>
                <nav class="hidden md:flex items-center space-x-8">
                    <a href="/" class="text-gray-300 hover:text-primary transition-colors">Home</a>
                    <a href="/claim" class="text-gray-300 hover:text-primary transition-colors">Claim Tokens</a>
                    <a href="/profile" class="text-gray-300 hover:text-primary transition-colors">Profile</a>
                </nav>
                <div id="wallet-section">
                    <button id="connect-wallet-btn" onclick="connectWallet()" class="btn-primary px-6 py-2 rounded-lg text-sm">Connect Wallet</button>
                    <div id="wallet-connected" class="hidden flex items-center space-x-3">
                        <span id="wallet-address" class="text-gray-300 text-sm"></span>
                        <button onclick="disconnectWallet()" class="text-gray-400 hover:text-primary transition-colors">
                            <span class="material-symbols-outlined">logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="pt-24 pb-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-4xl mx-auto">
            <div class="text-center mb-12">
                <h1 class="font-serif text-4xl md:text-5xl font-bold gold-gradient mb-4">VIP Token Presale</h1>
                <p class="text-gray-400 text-lg max-w-2xl mx-auto">Acquire VIP tokens at the presale price and become part of the exclusive Kea Valley community.</p>
            </div>

            <div class="glass-card rounded-2xl p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-400">Presale Progress</span>
                    <span id="progress-pct" class="gold-text font-semibold">0%</span>
                </div>
                <div class="w-full bg-surface-light rounded-full h-3 overflow-hidden">
                    <div id="progress-bar" class="progress-bar h-full rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-4 text-sm">
                    <span id="progress-raised" class="text-white font-semibold">€0.00</span>
                    <span id="progress-target" class="text-gray-500">€500,000</span>
                </div>
                <div class="text-center mt-3 text-xs text-gray-500">
                    <span id="tokens-sold">0</span> VIP tokens minted - Token Price: <span class="gold-text">€1.00</span>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-8">
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-3">
                        <label class="block text-gray-300 text-sm font-medium">Investment Amount</label>
                        <div id="bonus-badge" class="hidden"></div>
                    </div>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-white/60 font-semibold pointer-events-none">€</span>
                        <input type="number" id="eur-amount" min="10" step="1" value="100" class="input-field w-full pl-10 pr-20 py-4 rounded-xl text-lg" oninput="updateTotals()">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-white/40 font-semibold pointer-events-none">EUR</span>
                    </div>
                    <div class="flex justify-between mt-2">
                        <p class="text-gray-500 text-sm">Min: €<span id="min-purchase-display">10</span></p>
                        <p class="gold-text text-sm font-medium">= <span id="token-amount-display">100</span> VIP</p>
                    </div>
                </div>

                <div id="bonus-tiers-info" class="mb-6 p-4 bg-green-500/10 border border-green-500/20 rounded-xl hidden">
                    <h4 class="text-green-400 font-semibold text-sm mb-2">?? Volume Bonuses</h4>
                    <div id="bonus-tiers-list" class="text-sm text-white/70 space-y-1"></div>
                </div>

                <div class="mb-8">
                    <label class="block text-gray-300 text-sm font-medium mb-3">Payment Method</label>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="payment-option rounded-xl p-4 text-center selected" data-method="POL" onclick="selectPayment('POL')">
                            <div class="text-2xl mb-2">??</div>
                            <div class="font-semibold text-white">POL</div>
                            <div class="text-gray-500 text-xs mt-1">Polygon Native</div>
                            <div class="fee-badge mt-2">1.5% fee</div>
                        </div>
                        <div class="payment-option rounded-xl p-4 text-center" data-method="USDC" onclick="selectPayment('USDC')">
                            <div class="text-2xl mb-2">??</div>
                            <div class="font-semibold text-white">USDC</div>
                            <div class="text-gray-500 text-xs mt-1">Stablecoin</div>
                            <div class="fee-badge mt-2">1.5% fee</div>
                        </div>
                        <div class="payment-option rounded-xl p-4 text-center" data-method="Card" onclick="selectPayment('Card')">
                            <div class="text-2xl mb-2">??</div>
                            <div class="font-semibold text-white">Card</div>
                            <div class="text-gray-500 text-xs mt-1">Credit/Debit</div>
                            <div class="fee-badge mt-2">4% fee</div>
                        </div>
                    </div>
                </div>

                <div id="balance-section" class="mb-8 hidden">
                    <div class="flex items-center justify-between p-4 bg-surface-light rounded-xl">
                        <span class="text-gray-400">Your Balance:</span>
                        <span id="balance-display" class="font-semibold text-white">--</span>
                    </div>
                </div>

                <div class="border-t border-white/10 pt-6 mb-8">
                    <div class="space-y-3">
                        <div class="flex justify-between text-gray-400"><span>Tokens</span><span id="totalTokensDisplay" class="text-white">100 VIP</span></div>
                        <div class="flex justify-between text-gray-400"><span>Token Price</span><span class="text-white">€1.00 / VIP</span></div>
                        <div class="flex justify-between text-gray-400"><span>Subtotal</span><span id="subtotalEUR" class="text-white">€100.00</span></div>
                        <div class="flex justify-between text-gray-400"><span>Payment Fee (<span id="feePercent">1.5</span>%)</span><span id="feeAmountEUR" class="text-white">€1.50</span></div>
                        <div class="flex justify-between text-lg font-semibold border-t border-white/10 pt-3">
                            <span class="gold-text">Total</span>
                            <span class="gold-text"><span id="totalEUR">€101.50</span><span id="totalUSD" class="text-sm text-gray-400 ml-2">(\$120.79)</span></span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-500"><span>You Pay (approx)</span><span id="cryptoEquivalent">~846.5 POL</span></div>
                    </div>
                </div>

                <div class="mb-8 p-4 bg-surface-light rounded-xl border border-white/5">
                    <div class="flex items-start space-x-3">
                        <span class="material-symbols-outlined text-primary">account_balance</span>
                        <div><p class="text-gray-300 text-sm"><strong>Prefer bank transfer?</strong> Direct SEPA transfers are available. <a href="mailto:julie.meyer@vivapartners.net?subject=VIP%20Presale%20-%20SEPA%20Transfer%20Request" class="gold-text hover:underline">Contact us</a> for bank details.</p></div>
                    </div>
                </div>

                <button id="buy-button" onclick="executePurchase()" class="btn-primary w-full py-4 rounded-xl text-lg font-semibold" disabled>Connect Wallet to Purchase</button>

                <div id="referral-section" class="mt-6 hidden">
                    <div class="flex items-center space-x-2 p-3 bg-surface-light rounded-xl">
                        <span class="material-symbols-outlined text-primary">card_giftcard</span>
                        <span class="text-gray-400 text-sm">Referral Code:</span>
                        <span id="referral-code" class="gold-text font-semibold"></span>
                    </div>
                </div>
            </div>

            <div class="mt-8 text-center">
                <a href="https://polygonscan.com/token/0x6860c34db140DB7B589DaDA38859a1d3736bbE3F" target="_blank" class="inline-flex items-center space-x-2 text-gray-400 hover:text-primary transition-colors">
                    <span class="material-symbols-outlined">open_in_new</span>
                    <span>View Contract on Polygonscan</span>
                </a>
            </div>
        </div>
    </main>

    <footer class="bg-surface py-12 md:py-16 border-t border-white/5">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center space-x-3 mb-6 md:mb-0">
                    <img src="/logo.png" alt="Kea Valley" class="h-8 w-auto">
                    <span class="font-serif text-lg gold-text">Kea Valley</span>
                </div>
                <div class="text-gray-500 text-sm">© 2025 Kea Valley. All rights reserved.</div>
            </div>
        </div>
    </footer>

    <div id="connect-overlay" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <span class="material-symbols-outlined text-5xl gold-text mb-4">account_balance_wallet</span>
            <h3 class="text-2xl font-serif font-bold mb-4">Connect Your Wallet</h3>
            <p class="text-gray-400 mb-6">Please connect your WalletTwo wallet to participate in the presale.</p>
            <button onclick="redirectToWalletTwo()" class="btn-primary w-full py-3 rounded-xl font-semibold mb-3">Connect with WalletTwo</button>
            <button onclick="hideConnectOverlay()" class="text-gray-400 hover:text-white transition-colors">Cancel</button>
        </div>
    </div>

    <div id="presale-inactive-overlay" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <span class="material-symbols-outlined text-5xl text-yellow-500 mb-4">schedule</span>
            <h3 class="text-2xl font-serif font-bold mb-4">Presale Not Active</h3>
            <p class="text-gray-400 mb-6">The presale is currently not active. Please check back later.</p>
            <a href="/" class="btn-primary inline-block px-8 py-3 rounded-xl font-semibold">Return Home</a>
        </div>
    </div>

    <div id="processing-overlay" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <div class="animate-spin w-16 h-16 border-4 border-primary border-t-transparent rounded-full mx-auto mb-6"></div>
            <h3 class="text-2xl font-serif font-bold mb-4">Processing Purchase</h3>
            <p id="processing-message" class="text-gray-400">Verifying your payment...</p>
        </div>
    </div>

    <div id="result-overlay" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <span id="result-icon" class="material-symbols-outlined text-5xl mb-4"></span>
            <h3 id="result-title" class="text-2xl font-serif font-bold mb-4"></h3>
            <p id="result-message" class="text-gray-400 mb-6"></p>
            <div id="result-details" class="text-left mb-6 hidden">
                <div class="bg-surface-light rounded-xl p-4 space-y-3">
                    <div class="flex justify-between"><span class="text-gray-400">Tokens:</span><span id="result-tokens" class="text-white font-semibold"></span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Payment TX:</span><a id="result-payment-tx" href="#" target="_blank" class="gold-text hover:underline truncate ml-2"></a></div>
                    <div class="flex justify-between"><span class="text-gray-400">Mint TX:</span><a id="result-mint-tx" href="#" target="_blank" class="gold-text hover:underline truncate ml-2"></a></div>
                </div>
            </div>
            <button onclick="hideResultOverlay()" class="btn-primary w-full py-3 rounded-xl font-semibold">Continue</button>
        </div>
    </div>

    <div id="stripe-modal" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-serif font-bold">Complete Payment</h3>
                <button onclick="closeStripeModal()" class="text-gray-400 hover:text-white"><span class="material-symbols-outlined">close</span></button>
            </div>
            <div class="bg-surface-light rounded-xl p-4 mb-6">
                <h4 class="text-sm text-gray-400 mb-3">Order Summary</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between"><span class="text-gray-400">VIP Tokens</span><span id="stripe-tokens" class="text-white">100 VIP</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Subtotal</span><span id="stripe-subtotal" class="text-white">€100.00</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Payment Fee (4%)</span><span id="stripe-fee" class="text-white">€4.00</span></div>
                    <div class="flex justify-between font-semibold border-t border-white/10 pt-2 mt-2"><span class="gold-text">Total</span><span id="stripe-total" class="gold-text">€104.00</span></div>
                </div>
            </div>
            <form id="stripe-form">
                <div id="card-element" class="input-field p-4 rounded-xl mb-4"></div>
                <div id="card-errors" class="text-red-500 text-sm mb-4 hidden"></div>
                <button type="submit" id="stripe-submit" class="btn-primary w-full py-3 rounded-xl font-semibold">Pay €<span id="stripe-amount">104.00</span></button>
            </form>
        </div>
    </div>

    <script>
    const CONFIG = {
        tokenAddress: '0x6860c34db140DB7B589DaDA38859a1d3736bbE3F',
        tokenName: 'Kea Valley VIP',
        tokenSymbol: 'VIP',
        tokenDecimals: 18,
        chainId: 137,
        rpcUrl: 'https://polygon-rpc.com',
        explorer: 'https://polygonscan.com',
        usdcAddress: '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359',
        usdcDecimals: 6,
        walletTwoOrigin: 'https://wallet.wallettwo.com',
        minterWallet: '0xdD4104A780142EfB9566659f26d3317714a81510',
        totalTokens: 1000000,
        tokensSold: 0,
        tokenPriceEUR: 1.00,
        eurUsdRate: 1.19,
        polPrice: 0.12,
        presaleEnabled: true,
        presaleWallet: null,
        minPurchase: 10,
        maxPurchase: 100000,
        cryptoFeePercent: 1.5,
        cardFeePercent: 4,
        bonusTiers: []
    };

    let currentWallet = null;
    let selectedPayment = 'POL';
    let balances = { POL: 0, USDC: 0 };
    let stripe = null;
    let cardElement = null;
    let sessionData = null;

    function safeEl(id) { return document.getElementById(id); }
    function safeText(id, text) { const e = safeEl(id); if (e) e.textContent = text; }
    function safeHtml(id, html) { const e = safeEl(id); if (e) e.innerHTML = html; }
    function safeStyle(id, prop, val) { const e = safeEl(id); if (e && e.style) e.style[prop] = val; }
    function safeClass(id, action, cls) { const e = safeEl(id); if (e) e.classList[action](cls); }

    document.addEventListener('DOMContentLoaded', async () => {
        console.log('DOM loaded');
        await loadPresaleConfig();
        checkWalletConnection();
        checkUrlParams();
    });

    async function loadPresaleConfig() {
        try {
            const [configRes, tiersRes] = await Promise.all([
                fetch('/api/presale/config'),
                fetch('/api/presale/bonus-tiers').catch(() => ({ json: () => ({ tiers: [] }) }))
            ]);
            const config = await configRes.json();
            const tiersData = await tiersRes.json();
            
            CONFIG.totalTokens = config.totalTokens || 1000000;
            CONFIG.tokensSold = config.tokensSold || 0;
            CONFIG.tokenPriceEUR = config.tokenPrice || 1.00;
            CONFIG.eurUsdRate = config.eurUsdRate || 1.19;
            CONFIG.polPrice = config.polPrice || 0.12;
            CONFIG.presaleEnabled = config.presaleEnabled !== false;
            CONFIG.presaleWallet = config.presaleWallet || '';
            CONFIG.minPurchase = config.minPurchase || 10;
            CONFIG.stripePublicKey = config.stripePublicKey || '';
            CONFIG.eurRaised = config.eurRaised || 0;
            CONFIG.saleTargetEUR = config.saleTargetEUR || 500000;
            CONFIG.bonusTiers = tiersData.tiers || [];
            
            console.log('Config loaded:', CONFIG);
            updateProgress();
            updateTotals();
            displayBonusTiers();
            initStripe();
            
            if (!CONFIG.presaleEnabled) safeClass('presale-inactive-overlay', 'remove', 'hidden');
        } catch (error) {
            console.error('Failed to load config:', error);
        }
    }

    function updateProgress() {
        const eurRaised = CONFIG.eurRaised || 0;
        const targetEUR = CONFIG.saleTargetEUR || 500000;
        const progressPct = targetEUR > 0 ? ((eurRaised / targetEUR) * 100) : 0;
        
        safeStyle('progress-bar', 'width', Math.min(progressPct, 100) + '%');
        safeText('progress-pct', progressPct.toFixed(2) + '%');
        safeText('progress-raised', '€' + eurRaised.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        safeText('progress-target', '€' + targetEUR.toLocaleString());
        safeText('tokens-sold', (CONFIG.tokensSold || 0).toLocaleString());
    }

    function displayBonusTiers() {
        if (CONFIG.bonusTiers && CONFIG.bonusTiers.length > 0) {
            safeClass('bonus-tiers-info', 'remove', 'hidden');
            const html = CONFIG.bonusTiers
                .sort((a, b) => parseFloat(a.min_eur) - parseFloat(b.min_eur))
                .map(t => '<div>€' + parseFloat(t.min_eur).toLocaleString() + '+ ? <span class="text-green-400">+' + t.bonus_percent + '% bonus</span></div>')
                .join('');
            safeHtml('bonus-tiers-list', html);
        } else {
            safeClass('bonus-tiers-info', 'add', 'hidden');
        }
    }

    function initStripe() {
        if (!CONFIG.stripePublicKey || typeof Stripe === 'undefined') {
            console.log('Stripe not configured');
            return;
        }
        stripe = Stripe(CONFIG.stripePublicKey);
        const elements = stripe.elements();
        const container = safeEl('card-element');
        if (container) container.innerHTML = '';
        
        cardElement = elements.create('card', {
            hidePostalCode: true,
            style: {
                base: { color: '#ffffff', fontFamily: 'Montserrat, sans-serif', fontSize: '16px', '::placeholder': { color: '#6b7280' }, iconColor: '#D4AF37' },
                invalid: { color: '#ef4444' },
                complete: { color: '#D4AF37' }
            }
        });
        cardElement.mount('#card-element');
        
        const btn = safeEl('stripe-submit');
        if (btn) { btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed'); }
        
        cardElement.on('change', (event) => {
            const btn = safeEl('stripe-submit');
            const err = safeEl('card-errors');
            if (event.error) {
                if (err) { err.textContent = event.error.message; err.classList.remove('hidden'); }
                if (btn) { btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed'); }
            } else {
                if (err) { err.textContent = ''; err.classList.add('hidden'); }
                if (btn) {
                    if (event.complete) { btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed'); }
                    else { btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed'); }
                }
            }
        });

        const form = safeEl('stripe-form');
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = safeEl('stripe-submit');
                if (btn) { btn.disabled = true; btn.textContent = 'Processing...'; }
                
                const paymentData = JSON.parse(localStorage.getItem('stripePaymentData') || '{}');
                if (!paymentData.clientSecret) {
                    showResult('error', 'Payment Error', 'Payment session expired.');
                    closeStripeModal();
                    return;
                }
                
                try {
                    const { error, paymentIntent } = await stripe.confirmCardPayment(paymentData.clientSecret, {
                        payment_method: { card: cardElement, billing_details: { email: sessionData?.email } }
                    });
                    
                    if (error) {
                        const err = safeEl('card-errors');
                        if (err) { err.textContent = error.message; err.classList.remove('hidden'); }
                        if (btn) { btn.disabled = false; btn.textContent = 'Pay €' + (safeEl('stripe-amount')?.textContent || '0'); }
                        return;
                    }
                    
                    if (paymentIntent.status === 'succeeded') {
                        closeStripeModal();
                        showProcessing('Payment successful! Minting tokens...');
                        verifyStripePayment(paymentIntent.id, paymentData.tokenAmount);
                    }
                } catch (err) {
                    console.error('Stripe error:', err);
                    showResult('error', 'Payment Failed', err.message);
                    closeStripeModal();
                }
            });
        }
        console.log('Stripe initialized');
    }

    function closeStripeModal() {
        safeClass('stripe-modal', 'add', 'hidden');
        localStorage.removeItem('stripePaymentData');
        if (cardElement) try { cardElement.clear(); } catch(e) {}
        const err = safeEl('card-errors');
        if (err) { err.textContent = ''; err.classList.add('hidden'); }
        const btn = safeEl('stripe-submit');
        if (btn) { btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed'); }
    }

    function checkWalletConnection() {
        console.log('Checking wallet...');
        const params = new URLSearchParams(window.location.search);
        const walletFromUrl = params.get('wlt') || params.get('wallet') || params.get('address');
        
        if (walletFromUrl) {
            console.log('Wallet from URL:', walletFromUrl);
            currentWallet = walletFromUrl.toLowerCase();
            sessionData = { wallet: currentWallet, userId: params.get('usr'), timestamp: Date.now() };
            localStorage.setItem('keavalley_profile', JSON.stringify(sessionData));
            sessionStorage.setItem('keavalley_profile', JSON.stringify(sessionData));
            window.history.replaceState({}, document.title, window.location.pathname);
            showWalletConnected();
            loadBalances();
            checkReferralCode();
            return;
        }
        
        const profileStr = sessionStorage.getItem('keavalley_profile') || localStorage.getItem('keavalley_profile');
        if (profileStr) {
            try {
                sessionData = JSON.parse(profileStr);
                console.log('Session:', sessionData);
                const wallet = sessionData.wallet || sessionData.walletAddress || sessionData.address || sessionData.wlt;
                if (wallet) {
                    const age = Date.now() - (sessionData.timestamp || 0);
                    if (age > 86400000) {
                        console.log('Session expired');
                        localStorage.removeItem('keavalley_profile');
                        sessionStorage.removeItem('keavalley_profile');
                        currentWallet = null;
                        updateBuyButton();
                        return;
                    }
                    currentWallet = wallet.toLowerCase();
                    console.log('Wallet from storage:', currentWallet);
                    showWalletConnected();
                    loadBalances();
                    checkReferralCode();
                    return;
                }
            } catch (e) {
                console.error('Parse error:', e);
                localStorage.removeItem('keavalley_profile');
                sessionStorage.removeItem('keavalley_profile');
            }
        }
        console.log('No wallet found');
        currentWallet = null;
        updateBuyButton();
    }

    function connectWallet() { safeClass('connect-overlay', 'remove', 'hidden'); }
    function hideConnectOverlay() { safeClass('connect-overlay', 'add', 'hidden'); }
    
    function redirectToWalletTwo() {
        const redirectUri = encodeURIComponent(window.location.origin + '/presale');
        window.location.href = CONFIG.walletTwoOrigin + '/auth/login?companyId=6a27c2f8-894c-46c7-bf9f-f5af11d4e092&action=signature&message=VIP_PRESALE&redirect_uri=' + redirectUri;
    }

    function showWalletConnected() {
        if (!currentWallet) { console.log('No wallet to show'); return; }
        safeClass('connect-wallet-btn', 'add', 'hidden');
        safeClass('wallet-connected', 'remove', 'hidden');
        safeText('wallet-address', currentWallet.slice(0, 6) + '...' + currentWallet.slice(-4));
        safeClass('balance-section', 'remove', 'hidden');
        updateBuyButton();
    }

    function disconnectWallet() {
        sessionStorage.removeItem('keavalley_profile');
        localStorage.removeItem('keavalley_profile');
        currentWallet = null;
        sessionData = null;
        safeClass('connect-wallet-btn', 'remove', 'hidden');
        safeClass('wallet-connected', 'add', 'hidden');
        safeClass('balance-section', 'add', 'hidden');
        updateBuyButton();
    }

    async function loadBalances() {
        if (!currentWallet) return;
        const rpcs = ['https://polygon-bor-rpc.publicnode.com', 'https://polygon.llamarpc.com', 'https://polygon-rpc.com'];
        for (const rpc of rpcs) {
            try {
                const provider = new ethers.JsonRpcProvider(rpc);
                const polBal = await provider.getBalance(currentWallet);
                balances.POL = parseFloat(ethers.formatEther(polBal));
                const usdc = new ethers.Contract(CONFIG.usdcAddress, ['function balanceOf(address) view returns (uint256)'], provider);
                const usdcBal = await usdc.balanceOf(currentWallet);
                balances.USDC = parseFloat(ethers.formatUnits(usdcBal, 6));
                console.log('Balances:', balances);
                updateBalanceDisplay();
                updateBuyButton();
                return;
            } catch (e) { console.warn('RPC failed:', rpc); }
        }
        balances = { POL: 0, USDC: 0 };
        updateBalanceDisplay();
        updateBuyButton();
    }

    function updateBalanceDisplay() {
        if (selectedPayment === 'POL') safeText('balance-display', balances.POL.toFixed(4) + ' POL');
        else if (selectedPayment === 'USDC') safeText('balance-display', balances.USDC.toFixed(2) + ' USDC');
        else safeText('balance-display', '--');
    }

    function selectPayment(method) {
        selectedPayment = method;
        document.querySelectorAll('.payment-option').forEach(el => {
            el.classList.toggle('selected', el.dataset.method === method);
        });
        updateBalanceDisplay();
        updateTotals();
        updateBuyButton();
    }

    function updateTotals() {
        const eurInput = safeEl('eur-amount');
        const eurAmount = eurInput ? (parseFloat(eurInput.value) || 0) : 0;
        const tokenPrice = CONFIG.tokenPriceEUR || 1.00;
        const baseTokens = Math.floor(eurAmount / tokenPrice);
        
        let bonusPercent = 0, bonusTokens = 0;
        if (CONFIG.bonusTiers && CONFIG.bonusTiers.length > 0) {
            const tier = [...CONFIG.bonusTiers].filter(t => parseFloat(t.min_eur) <= eurAmount).sort((a,b) => parseFloat(b.min_eur) - parseFloat(a.min_eur))[0];
            if (tier) { bonusPercent = parseFloat(tier.bonus_percent); bonusTokens = Math.floor(baseTokens * bonusPercent / 100); }
        }
        const totalTokens = baseTokens + bonusTokens;
        
        if (bonusTokens > 0) {
            safeHtml('token-amount-display', totalTokens.toLocaleString() + ' <span class="text-green-400 text-xs">(+' + bonusTokens + ' bonus)</span>');
        } else {
            safeText('token-amount-display', totalTokens.toLocaleString());
        }
        
        safeText('min-purchase-display', (CONFIG.minPurchase || 10).toLocaleString());
        
        const badge = safeEl('bonus-badge');
        if (badge) {
            if (bonusPercent > 0) { badge.innerHTML = '<span class="bg-green-500/20 text-green-400 px-2 py-1 rounded-full text-xs">+' + bonusPercent + '% BONUS</span>'; badge.classList.remove('hidden'); }
            else { badge.classList.add('hidden'); }
        }
        
        if (eurInput && eurAmount < CONFIG.minPurchase && eurAmount > 0) eurInput.classList.add('border-red-500');
        else if (eurInput) eurInput.classList.remove('border-red-500');
        
        const feePercent = selectedPayment === 'Card' ? CONFIG.cardFeePercent : CONFIG.cryptoFeePercent;
        const feeEUR = eurAmount * (feePercent / 100);
        const totalEUR = eurAmount + feeEUR;
        const totalUSD = totalEUR * CONFIG.eurUsdRate;
        const polAmount = totalUSD / CONFIG.polPrice;
        
        safeText('totalTokensDisplay', totalTokens.toLocaleString() + ' VIP');
        safeText('subtotalEUR', '€' + eurAmount.toFixed(2));
        safeText('feePercent', feePercent.toString());
        safeText('feeAmountEUR', '€' + feeEUR.toFixed(2));
        safeText('totalEUR', '€' + totalEUR.toFixed(2));
        safeText('totalUSD', '(\$' + totalUSD.toFixed(2) + ')');
        
        if (selectedPayment === 'POL') safeText('cryptoEquivalent', '~' + polAmount.toFixed(2) + ' POL');
        else if (selectedPayment === 'USDC') safeText('cryptoEquivalent', '~' + totalUSD.toFixed(2) + ' USDC');
        else safeText('cryptoEquivalent', '€' + totalEUR.toFixed(2));
        
        window.currentPurchase = { eurAmount, baseTokens, bonusTokens, totalTokens, bonusPercent, feeEUR, totalEUR, totalUSD, polAmount };
        updateBuyButton();
    }

    function updateBuyButton() {
        const btn = safeEl('buy-button');
        if (!btn) return;
        
        const eurInput = safeEl('eur-amount');
        const eurAmount = eurInput ? (parseFloat(eurInput.value) || 0) : 0;
        const purchase = window.currentPurchase || {};

        if (!currentWallet) { btn.textContent = 'Connect Wallet to Purchase'; btn.disabled = true; return; }
        if (!CONFIG.presaleEnabled) { btn.textContent = 'Presale Not Active'; btn.disabled = true; return; }
        if (eurAmount < CONFIG.minPurchase) { btn.textContent = 'Minimum €' + CONFIG.minPurchase; btn.disabled = true; return; }

        const totalEUR = purchase.totalEUR || 0;
        const totalUSD = purchase.totalUSD || 0;

        if (selectedPayment === 'Card') { btn.textContent = 'Pay €' + totalEUR.toFixed(2); btn.disabled = false; }
        else if (selectedPayment === 'POL') {
            const req = purchase.polAmount || 0;
            if (balances.POL >= req) { btn.textContent = 'Pay ~' + req.toFixed(2) + ' POL'; btn.disabled = false; }
            else { btn.textContent = 'Insufficient POL Balance'; btn.disabled = true; }
        }
        else if (selectedPayment === 'USDC') {
            if (balances.USDC >= totalUSD) { btn.textContent = 'Pay ~' + totalUSD.toFixed(2) + ' USDC'; btn.disabled = false; }
            else { btn.textContent = 'Insufficient USDC Balance'; btn.disabled = true; }
        }
    }

    async function executePurchase() {
        if (!currentWallet) { connectWallet(); return; }
        if (!CONFIG.presaleEnabled) { showResult('error', 'Presale Not Active', 'The presale is not available.'); return; }

        const purchase = window.currentPurchase || {};
        const eurAmount = purchase.eurAmount || 0;
        const baseTokens = purchase.baseTokens || 0;
        const totalTokens = purchase.totalTokens || 0;

        if (eurAmount < CONFIG.minPurchase) { showResult('error', 'Invalid Amount', 'Minimum purchase is €' + CONFIG.minPurchase); return; }

        const pending = { walletAddress: currentWallet, tokenAmount: baseTokens, expectedTotal: totalTokens, bonusPercent: purchase.bonusPercent, baseEUR: eurAmount, feeEUR: purchase.feeEUR, totalEUR: purchase.totalEUR, totalUSD: purchase.totalUSD, paymentMethod: selectedPayment, timestamp: Date.now() };
        localStorage.setItem('pendingPurchase', JSON.stringify(pending));

        if (selectedPayment === 'Card') {
            if (!stripe) { showResult('error', 'Payment Error', 'Card payments not configured.'); return; }
            openStripeCheckout(baseTokens, eurAmount, purchase.feeEUR, purchase.totalEUR);
        } else {
            executeCryptoPurchase(baseTokens, purchase.totalUSD, eurAmount, purchase.feeEUR);
        }
    }

    function executeCryptoPurchase(tokenAmount, totalUSD, baseEUR, feeEUR) {
        if (!CONFIG.presaleWallet) { showResult('error', 'Error', 'Presale wallet not configured.'); return; }
        const baseUSD = baseEUR * CONFIG.eurUsdRate;
        const feeUSD = feeEUR * CONFIG.eurUsdRate;
        let transactions = [];
        const externalId = 'presale-' + Date.now();
        const redirectUri = encodeURIComponent(window.location.origin + '/presale?purchase=complete');

        if (selectedPayment === 'USDC') {
            transactions = [
                { type: 'erc20_transfer', token: CONFIG.usdcAddress, to: CONFIG.presaleWallet, amount: Math.floor(baseUSD * 1e6).toString(), description: 'VIP Presale' },
                { type: 'erc20_transfer', token: CONFIG.usdcAddress, to: CONFIG.minterWallet, amount: Math.ceil(feeUSD * 1e6).toString(), description: 'Platform fee' }
            ];
        } else {
            const basePOL = baseUSD / CONFIG.polPrice;
            const feePOL = feeUSD / CONFIG.polPrice;
            transactions = [
                { type: 'native_transfer', to: CONFIG.presaleWallet, amount: BigInt(Math.floor(basePOL * 1e18)).toString(), description: 'VIP Presale' },
                { type: 'native_transfer', to: CONFIG.minterWallet, amount: BigInt(Math.ceil(feePOL * 1e18)).toString(), description: 'Platform fee' }
            ];
        }
        const txData = encodeURIComponent(JSON.stringify({ chainId: CONFIG.chainId, transactions, metadata: { type: 'presale_purchase', tokenAmount, totalUSD, baseEUR, feeEUR, paymentMethod: selectedPayment } }));
        window.location.href = CONFIG.walletTwoOrigin + '/transaction/multi?data=' + txData + '&external_id=' + externalId + '&redirect_uri=' + redirectUri;
    }

    function openStripeCheckout(tokenAmount, baseEUR, feeEUR, totalEUR) {
        const purchase = window.currentPurchase || {};
        const totalTokens = purchase.totalTokens || tokenAmount;
        const bonusTokens = purchase.bonusTokens || 0;
        
        if (bonusTokens > 0) safeHtml('stripe-tokens', totalTokens + ' VIP <span class="text-green-400 text-xs">(+' + bonusTokens + ' bonus)</span>');
        else safeText('stripe-tokens', totalTokens + ' VIP');
        safeText('stripe-subtotal', '€' + baseEUR.toFixed(2));
        safeText('stripe-fee', '€' + feeEUR.toFixed(2));
        safeText('stripe-total', '€' + totalEUR.toFixed(2));
        safeText('stripe-amount', totalEUR.toFixed(2));

        const btn = safeEl('stripe-submit');
        if (btn) { btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed'); }
        const err = safeEl('card-errors');
        if (err) { err.textContent = ''; err.classList.add('hidden'); }
        if (cardElement) cardElement.clear();

        safeClass('stripe-modal', 'remove', 'hidden');
        createPaymentIntent(tokenAmount, totalEUR);
    }

    async function createPaymentIntent(tokenAmount, totalEUR) {
        try {
            const purchase = window.currentPurchase || {};
            const res = await fetch('/api/presale/create-payment-intent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ walletAddress: currentWallet, tokenAmount, totalEUR, baseAmount: purchase.eurAmount, feeAmount: purchase.feeEUR, email: sessionData?.email })
            });
            if (!res.ok) throw new Error('Failed to create payment intent');
            const data = await res.json();
            localStorage.setItem('stripePaymentData', JSON.stringify({ clientSecret: data.clientSecret, paymentIntentId: data.paymentIntentId, tokenAmount, totalEUR, expectedTotalTokens: purchase.totalTokens }));
        } catch (e) {
            console.error('Payment intent error:', e);
            showResult('error', 'Payment Error', 'Failed to initialize payment.');
            closeStripeModal();
        }
    }

    async function verifyStripePayment(paymentIntentId, tokenAmount) {
        showProcessing('Payment received! Minting tokens...');
        let attempts = 0;
        while (attempts < 60) {
            try {
                const res = await fetch('/api/presale/purchase-status/' + paymentIntentId);
                if (res.ok) {
                    const data = await res.json();
                    if (data.status === 'completed' && data.mintTxHash) {
                        hideProcessing();
                        showResult('success', 'Purchase Complete!', 'Successfully purchased ' + (data.totalTokens || tokenAmount) + ' VIP tokens!', { tokens: data.totalTokens || tokenAmount, mintTx: data.mintTxHash });
                        localStorage.removeItem('pendingPurchase');
                        localStorage.removeItem('stripePaymentData');
                        loadPresaleConfig();
                        return;
                    }
                    if (data.status === 'failed' || data.status === 'mint_failed') {
                        hideProcessing();
                        showResult('error', 'Failed', data.error || 'Contact support.');
                        return;
                    }
                }
            } catch (e) {}
            attempts++;
            await new Promise(r => setTimeout(r, 1000));
        }
        hideProcessing();
        showResult('info', 'Processing', 'Payment received. Tokens will arrive shortly.');
    }

    function checkUrlParams() {
        const params = new URLSearchParams(window.location.search);
        if (params.get('purchase') === 'complete') {
            const txHash = params.get('tx_hash');
            if (txHash) { showProcessing('Verifying payment...'); verifyCryptoPayment(txHash); }
        }
        const ref = params.get('ref');
        if (ref) localStorage.setItem('referralCode', ref);
    }

    async function verifyCryptoPayment(txHash) {
        try {
            const pending = JSON.parse(localStorage.getItem('pendingPurchase') || '{}');
            const res = await fetch('/api/presale/verify-payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ txHash, walletAddress: currentWallet || pending.walletAddress, tokenAmount: pending.tokenAmount, totalEUR: pending.totalEUR, totalUSD: pending.totalUSD, paymentMethod: pending.paymentMethod, referrerCode: localStorage.getItem('referralCode') })
            });
            const data = await res.json();
            hideProcessing();
            if (data.success) {
                showResult('success', 'Purchase Complete!', data.message || 'Tokens purchased!', { tokens: data.totalTokens || pending.tokenAmount, paymentTx: txHash, mintTx: data.mintTxHash });
                localStorage.removeItem('pendingPurchase');
                localStorage.removeItem('referralCode');
                loadPresaleConfig();
            } else {
                showResult('error', 'Verification Failed', data.error || 'Contact support.');
            }
            window.history.replaceState({}, document.title, window.location.pathname);
        } catch (e) {
            hideProcessing();
            showResult('error', 'Error', e.message);
        }
    }

    async function checkReferralCode() {
        const code = localStorage.getItem('referralCode');
        if (code && currentWallet) {
            try {
                const res = await fetch('/api/referral/validate/' + code);
                if (res.ok) {
                    const data = await res.json();
                    if (data.valid) { safeClass('referral-section', 'remove', 'hidden'); safeText('referral-code', code); }
                }
            } catch (e) {}
        }
    }

    function showProcessing(msg) { safeText('processing-message', msg); safeClass('processing-overlay', 'remove', 'hidden'); }
    function hideProcessing() { safeClass('processing-overlay', 'add', 'hidden'); }

    function showResult(type, title, message, details = null) {
        const icon = safeEl('result-icon');
        if (icon) {
            icon.textContent = type === 'success' ? 'check_circle' : (type === 'info' ? 'info' : 'error');
            icon.className = 'material-symbols-outlined text-5xl mb-4 ' + (type === 'success' ? 'text-green-500' : (type === 'info' ? 'text-blue-500' : 'text-red-500'));
        }
        safeText('result-title', title);
        safeText('result-message', message);
        
        const detailsEl = safeEl('result-details');
        if (details && detailsEl) {
            detailsEl.classList.remove('hidden');
            safeText('result-tokens', details.tokens + ' VIP');
            if (details.paymentTx) { const el = safeEl('result-payment-tx'); if (el) { el.href = CONFIG.explorer + '/tx/' + details.paymentTx; el.textContent = details.paymentTx.slice(0, 10) + '...'; } }
            if (details.mintTx) { const el = safeEl('result-mint-tx'); if (el) { el.href = CONFIG.explorer + '/tx/' + details.mintTx; el.textContent = details.mintTx.slice(0, 10) + '...'; } }
        } else if (detailsEl) { detailsEl.classList.add('hidden'); }
        safeClass('result-overlay', 'remove', 'hidden');
    }

    function hideResultOverlay() { safeClass('result-overlay', 'add', 'hidden'); }

    window.addEventListener('message', (event) => {
        if (!event.origin.includes('wallettwo.com')) return;
        const data = event.data;
        if (data && (data.type === 'wallet_login' || data.wallet || data.wlt)) {
            const wallet = data.wallet || data.wlt || data.address;
            if (wallet) {
                currentWallet = wallet.toLowerCase();
                sessionData = { wallet: currentWallet, userId: data.user, email: data.email, timestamp: Date.now() };
                localStorage.setItem('keavalley_profile', JSON.stringify(sessionData));
                sessionStorage.setItem('keavalley_profile', JSON.stringify(sessionData));
                showWalletConnected();
                loadBalances();
                checkReferralCode();
            }
        }
    });
    </script>
</body>
</html>