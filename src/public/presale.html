<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Token Presale - Kea Valley</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#D4AF37',
                        'primary-dark': '#B8960C',
                        'primary-light': '#E5C76B',
                        'background-dark': '#0a0a0a',
                        'surface': '#121212',
                        'surface-light': '#1a1a1a'
                    },
                    fontFamily: {
                        'serif': ['Cormorant Garamond', 'serif'],
                        'sans': ['Montserrat', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0a0a0a;
            color: #ffffff;
            font-family: 'Montserrat', sans-serif;
        }
        .glass-card {
            background: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(212, 175, 55, 0.1);
        }
        .glass-nav {
            background-color: rgba(18, 18, 18, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
        }
        .gold-text {
            color: #D4AF37;
        }
        .gold-gradient {
            background: linear-gradient(135deg, #D4AF37 0%, #F4E5B0 50%, #D4AF37 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .btn-primary {
            background: linear-gradient(135deg, #D4AF37 0%, #B8960C 100%);
            color: #0a0a0a;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #E5C76B 0%, #D4AF37 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(212, 175, 55, 0.3);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .input-field {
            background-color: #1a1a1a !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff !important;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            border-color: #D4AF37;
            outline: none;
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }
        /* Fix autofill background */
        .input-field:-webkit-autofill,
        .input-field:-webkit-autofill:hover,
        .input-field:-webkit-autofill:focus,
        .input-field:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #1a1a1a inset !important;
            -webkit-text-fill-color: #ffffff !important;
            caret-color: #ffffff !important;
            transition: background-color 5000s ease-in-out 0s;
        }
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #1a1a1a inset !important;
            -webkit-text-fill-color: #ffffff !important;
            caret-color: #ffffff !important;
            transition: background-color 5000s ease-in-out 0s;
        }
        /* Force input background */
        input[type="number"] {
            background-color: #1a1a1a !important;
            color: #ffffff !important;
        }
        .payment-option {
            background: rgba(26, 26, 26, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .payment-option:hover {
            border-color: rgba(212, 175, 55, 0.5);
        }
        .payment-option.selected {
            border-color: #D4AF37;
            background: rgba(212, 175, 55, 0.1);
        }
        .progress-bar {
            background: linear-gradient(90deg, #D4AF37 0%, #E5C76B 100%);
            transition: width 0.5s ease;
        }
        .overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .fee-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(212, 175, 55, 0.2);
            color: #D4AF37;
        }
        
        /* Stripe card element dark theme */
        #card-element {
            background-color: #1a1a1a !important;
        }
        .StripeElement {
            background-color: #1a1a1a !important;
        }
        .StripeElement--focus {
            border-color: #D4AF37;
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }
        .StripeElement--invalid {
            border-color: #ef4444;
        }
        .StripeElement--complete {
            border-color: #D4AF37;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="glass-nav fixed top-0 left-0 right-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="/" class="flex items-center space-x-3">
                    <img src="/logo.png" alt="Kea Valley" class="h-10 w-auto">
                    <span class="font-serif text-xl font-semibold gold-text">Kea Valley</span>
                </a>
                <nav class="hidden md:flex items-center space-x-8">
                    <a href="/" class="text-gray-300 hover:text-primary transition-colors">Home</a>
                    <a href="/claim" class="text-gray-300 hover:text-primary transition-colors">Claim Tokens</a>
                    <a href="/profile" class="text-gray-300 hover:text-primary transition-colors">Profile</a>
                </nav>
                <div id="wallet-section">
                    <button id="connect-wallet-btn" onclick="connectWallet()" class="btn-primary px-6 py-2 rounded-lg text-sm">
                        Connect Wallet
                    </button>
                    <div id="wallet-connected" class="hidden flex items-center space-x-3">
                        <span id="wallet-address" class="text-gray-300 text-sm"></span>
                        <button onclick="disconnectWallet()" class="text-gray-400 hover:text-primary transition-colors">
                            <span class="material-symbols-outlined">logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-24 pb-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-4xl mx-auto">
            <!-- Presale Header -->
            <div class="text-center mb-12">
                <h1 class="font-serif text-4xl md:text-5xl font-bold gold-gradient mb-4">VIP Token Presale</h1>
                <p class="text-gray-400 text-lg max-w-2xl mx-auto">
                    Acquire VIP tokens at the presale price and become part of the exclusive Kea Valley community.
                </p>
            </div>

            <!-- Progress Section -->
            <div class="glass-card rounded-2xl p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-400">Presale Progress</span>
                    <span id="progress-pct" class="gold-text font-semibold">0%</span>
                </div>
                <div class="w-full bg-surface-light rounded-full h-3 overflow-hidden">
                    <div id="progress-bar" class="progress-bar h-full rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-4 text-sm">
                    <span id="progress-raised" class="text-white font-semibold">‚Ç¨0.00</span>
                    <span id="progress-target" class="text-gray-500">‚Ç¨500,000</span>
                </div>
                <div class="text-center mt-3 text-xs text-gray-500">
                    <span id="tokens-info"><span id="tokens-sold">0</span> VIP tokens minted ‚Ä¢ Token Price: <span class="gold-text">‚Ç¨1.00</span></span>
                </div>
            </div>

            <!-- Purchase Card -->
            <div class="glass-card rounded-2xl p-8">
                <!-- EUR Amount Input -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-3">
                        <label class="block text-gray-300 text-sm font-medium">Investment Amount</label>
                        <div id="bonus-badge" class="hidden"></div>
                    </div>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-white/60 font-semibold pointer-events-none">‚Ç¨</span>
                        <input type="number" id="eur-amount" min="10" step="1" value="100" 
                            class="input-field w-full pl-10 pr-20 py-4 rounded-xl text-lg"
                            oninput="updateTotals()"
                            style="background-color: #1a1a1a !important; color: #ffffff !important;">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-white/40 font-semibold pointer-events-none">EUR</span>
                    </div>
                    <div class="flex justify-between mt-2">
                        <p class="text-gray-500 text-sm">Min: ‚Ç¨<span id="min-purchase-display">-</span></p>
                        <p class="gold-text text-sm font-medium">= <span id="token-amount-display">-</span> VIP</p>
                    </div>
                </div>

                <!-- Bonus Tiers Info -->
                <div id="bonus-tiers-info" class="mb-6 p-4 bg-green-500/10 border border-green-500/20 rounded-xl hidden">
                    <h4 class="text-green-400 font-semibold text-sm mb-2">üéÅ Volume Bonuses</h4>
                    <div id="bonus-tiers-list" class="text-sm text-white/70 space-y-1">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Payment Method Selection -->
                <div class="mb-8">
                    <label class="block text-gray-300 text-sm font-medium mb-3">Payment Method</label>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="payment-option rounded-xl p-4 text-center selected" data-method="POL" onclick="selectPayment('POL')">
                            <div class="text-2xl mb-2">üíú</div>
                            <div class="font-semibold text-white">POL</div>
                            <div class="text-gray-500 text-xs mt-1">Polygon Native</div>
                            <div class="fee-badge mt-2">1.5% fee</div>
                        </div>
                        <div class="payment-option rounded-xl p-4 text-center" data-method="USDC" onclick="selectPayment('USDC')">
                            <div class="text-2xl mb-2">üíµ</div>
                            <div class="font-semibold text-white">USDC</div>
                            <div class="text-gray-500 text-xs mt-1">Stablecoin</div>
                            <div class="fee-badge mt-2">1.5% fee</div>
                        </div>
                        <div class="payment-option rounded-xl p-4 text-center" data-method="Card" onclick="selectPayment('Card')">
                            <div class="text-2xl mb-2">üí≥</div>
                            <div class="font-semibold text-white">Card</div>
                            <div class="text-gray-500 text-xs mt-1">Credit/Debit</div>
                            <div class="fee-badge mt-2">4% fee</div>
                        </div>
                    </div>
                </div>

                <!-- Balance Display -->
                <div id="balance-section" class="mb-8 hidden">
                    <div class="flex items-center justify-between p-4 bg-surface-light rounded-xl">
                        <span class="text-gray-400">Your Balance:</span>
                        <span id="balance-display" class="font-semibold text-white">--</span>
                    </div>
                </div>

                <!-- Total Section - All in EUR with USD equivalent -->
                <div class="border-t border-white/10 pt-6 mb-8">
                    <div class="space-y-3">
                        <div class="flex justify-between text-gray-400">
                            <span>Tokens</span>
                            <span id="totalTokensDisplay" class="text-white">100 VIP</span>
                        </div>
                        <div class="flex justify-between text-gray-400">
                            <span>Token Price</span>
                            <span class="text-white">‚Ç¨1.00 / VIP</span>
                        </div>
                        <div class="flex justify-between text-gray-400">
                            <span>Subtotal</span>
                            <span id="subtotalEUR" class="text-white">‚Ç¨100.00</span>
                        </div>
                        <div class="flex justify-between text-gray-400">
                            <span>Payment Fee (<span id="feePercent">1.5</span>%)</span>
                            <span id="feeAmountEUR" class="text-white">‚Ç¨1.50</span>
                        </div>
                        <div class="flex justify-between text-lg font-semibold border-t border-white/10 pt-3">
                            <span class="gold-text">Total</span>
                            <span class="gold-text">
                                <span id="totalEUR">‚Ç¨101.50</span>
                                <span id="totalUSD" class="text-sm text-gray-400 ml-2">($120.79)</span>
                            </span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>You Pay (approx)</span>
                            <span id="cryptoEquivalent">~1006.6 POL</span>
                        </div>
                    </div>
                </div>

                <!-- SEPA Info -->
                <div class="mb-8 p-4 bg-surface-light rounded-xl border border-white/5">
                    <div class="flex items-start space-x-3">
                        <span class="material-symbols-outlined text-primary">account_balance</span>
                        <div>
                            <p class="text-gray-300 text-sm">
                                <strong>Prefer bank transfer?</strong> Direct SEPA transfers are available. 
                                <a href="mailto:julie.meyer@vivapartners.net?subject=VIP%20Presale%20-%20SEPA%20Transfer%20Request" class="gold-text hover:underline">Contact us</a> for bank details.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Buy Button -->
                <button id="buy-button" onclick="executePurchase()" class="btn-primary w-full py-4 rounded-xl text-lg font-semibold" disabled>
                    Connect Wallet to Purchase
                </button>

                <!-- Referral Code Section -->
                <div id="referral-section" class="mt-6 hidden">
                    <div class="flex items-center space-x-2 p-3 bg-surface-light rounded-xl">
                        <span class="material-symbols-outlined text-primary">card_giftcard</span>
                        <span class="text-gray-400 text-sm">Referral Code:</span>
                        <span id="referral-code" class="gold-text font-semibold"></span>
                    </div>
                </div>
            </div>

            <!-- Token Info -->
            <div class="mt-8 text-center">
                <a href="https://polygonscan.com/token/0x6860c34db140DB7B589DaDA38859a1d3736bbE3F" target="_blank" 
                    class="inline-flex items-center space-x-2 text-gray-400 hover:text-primary transition-colors">
                    <span class="material-symbols-outlined">open_in_new</span>
                    <span>View Contract on Polygonscan</span>
                </a>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-surface py-12 md:py-16 border-t border-white/5">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center space-x-3 mb-6 md:mb-0">
                    <img src="/logo.png" alt="Kea Valley" class="h-8 w-auto">
                    <span class="font-serif text-lg gold-text">Kea Valley</span>
                </div>
                <div class="text-gray-500 text-sm">
                    ¬© 2025 Kea Valley. All rights reserved.
                </div>
            </div>
        </div>
    </footer>

    <!-- Connect Wallet Overlay -->
    <div id="connect-overlay" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <span class="material-symbols-outlined text-5xl gold-text mb-4">account_balance_wallet</span>
            <h3 class="text-2xl font-serif font-bold mb-4">Connect Your Wallet</h3>
            <p class="text-gray-400 mb-6">Please connect your WalletTwo wallet to participate in the presale.</p>
            <button onclick="redirectToWalletTwo()" class="btn-primary w-full py-3 rounded-xl font-semibold mb-3">
                Connect with WalletTwo
            </button>
            <button onclick="hideConnectOverlay()" class="text-gray-400 hover:text-white transition-colors">
                Cancel
            </button>
        </div>
    </div>

    <!-- Presale Inactive Overlay -->
    <div id="presale-inactive-overlay" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <span class="material-symbols-outlined text-5xl text-yellow-500 mb-4">schedule</span>
            <h3 class="text-2xl font-serif font-bold mb-4">Presale Not Active</h3>
            <p class="text-gray-400 mb-6">The presale is currently not active. Please check back later or follow our announcements.</p>
            <a href="/" class="btn-primary inline-block px-8 py-3 rounded-xl font-semibold">
                Return Home
            </a>
        </div>
    </div>

    <!-- Processing Overlay -->
    <div id="processing-overlay" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <div class="animate-spin w-16 h-16 border-4 border-primary border-t-transparent rounded-full mx-auto mb-6"></div>
            <h3 class="text-2xl font-serif font-bold mb-4">Processing Purchase</h3>
            <p id="processing-message" class="text-gray-400">Verifying your payment...</p>
        </div>
    </div>

    <!-- Result Overlay -->
    <div id="result-overlay" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <span id="result-icon" class="material-symbols-outlined text-5xl mb-4"></span>
            <h3 id="result-title" class="text-2xl font-serif font-bold mb-4"></h3>
            <p id="result-message" class="text-gray-400 mb-6"></p>
            <div id="result-details" class="text-left mb-6 hidden">
                <div class="bg-surface-light rounded-xl p-4 space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Tokens:</span>
                        <span id="result-tokens" class="text-white font-semibold"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Payment TX:</span>
                        <a id="result-payment-tx" href="#" target="_blank" class="gold-text hover:underline truncate ml-2"></a>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Mint TX:</span>
                        <a id="result-mint-tx" href="#" target="_blank" class="gold-text hover:underline truncate ml-2"></a>
                    </div>
                </div>
            </div>
            <button onclick="hideResultOverlay()" class="btn-primary w-full py-3 rounded-xl font-semibold">
                Continue
            </button>
        </div>
    </div>

    <!-- Stripe Modal -->
    <div id="stripe-modal" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-serif font-bold">Complete Payment</h3>
                <button onclick="closeStripeModal()" class="text-gray-400 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            
            <!-- Order Summary -->
            <div class="bg-surface-light rounded-xl p-4 mb-6">
                <h4 class="text-sm text-gray-400 mb-3">Order Summary</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">VIP Tokens</span>
                        <span id="stripe-tokens" class="text-white">100 VIP</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Subtotal</span>
                        <span id="stripe-subtotal" class="text-white">‚Ç¨100.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Payment Fee (4%)</span>
                        <span id="stripe-fee" class="text-white">‚Ç¨4.00</span>
                    </div>
                    <div class="flex justify-between font-semibold border-t border-white/10 pt-2 mt-2">
                        <span class="gold-text">Total</span>
                        <span id="stripe-total" class="gold-text">‚Ç¨104.00</span>
                    </div>
                </div>
            </div>

            <form id="stripe-form">
                <div id="card-element" class="input-field p-4 rounded-xl mb-4" style="background-color: #1a1a1a;"></div>
                <div id="card-errors" class="text-red-500 text-sm mb-4 hidden"></div>
                <button type="submit" id="stripe-submit" class="btn-primary w-full py-3 rounded-xl font-semibold">
                    Pay ‚Ç¨<span id="stripe-amount">104.00</span>
                </button>
            </form>
        </div>
    </div>

    <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    const CONFIG = {
        tokenAddress: '0x6860c34db140DB7B589DaDA38859a1d3736bbE3F',
        tokenName: 'Kea Valley VIP',
        tokenSymbol: 'VIP',
        tokenDecimals: 18,
        chainId: 137,
        rpcUrl: 'https://polygon-rpc.com',
        explorer: 'https://polygonscan.com',
        usdcAddress: '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359',
        usdcDecimals: 6,
        walletTwoOrigin: 'https://wallet.wallettwo.com',
        minterWallet: '0xdD4104A780142EfB9566659f26d3317714a81510',
        // Presale defaults (overridden by API)
        totalTokens: 1000000,
        tokensSold: 0,
        tokenPriceEUR: 1.00,
        eurUsdRate: 1.19,
        polPrice: 0.12,
        presaleEnabled: true,
        presaleWallet: null,
        minPurchase: 10,
        maxPurchase: 100000,
        // Fees
        cryptoFeePercent: 1.5,
        cardFeePercent: 4,
        // Bonus tiers
        bonusTiers: []
    };

    let currentWallet = null;
    let selectedPayment = 'POL';
    let balances = { POL: 0, USDC: 0 };
    let stripe = null;
    let cardElement = null;
    let sessionData = null;

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', async () => {
        await loadPresaleConfig();
        checkWalletConnection();
        checkUrlParams();
    });

    async function loadPresaleConfig() {
        try {
            // Load config and bonus tiers in parallel
            const [configRes, tiersRes] = await Promise.all([
                fetch('/api/presale/config'),
                fetch('/api/presale/bonus-tiers').catch(() => ({ json: () => ({ tiers: [] }) }))
            ]);
            
            const config = await configRes.json();
            const tiersData = await tiersRes.json();
            
            // Update CONFIG with DB values
            CONFIG.totalTokens = config.totalTokens || 1000000;
            CONFIG.tokensSold = config.tokensSold || 0;
            CONFIG.tokenPriceEUR = config.tokenPrice || 1.00;
            CONFIG.eurUsdRate = config.eurUsdRate || 1.19;
            CONFIG.polPrice = config.polPrice || 0.12;
            CONFIG.presaleEnabled = config.presaleEnabled !== false;
            CONFIG.presaleWallet = config.presaleWallet || '';
            CONFIG.minPurchase = config.minPurchase || 10;
            CONFIG.stripePublicKey = config.stripePublicKey || '';
            CONFIG.eurRaised = config.eurRaised || 0;
            CONFIG.saleTargetEUR = config.saleTargetEUR || 500000;
            CONFIG.bonusTiers = tiersData.tiers || [];
            
            console.log('‚úÖ Config loaded:', CONFIG);
            
            // Update UI
            updateProgress();
            updateTotals();
            displayBonusTiers();
            initStripe();
            
            // Handle presale disabled
            if (!CONFIG.presaleEnabled) {
                document.getElementById('presale-inactive-overlay')?.classList.remove('hidden');
            }
            
        } catch (error) {
            console.error('‚ùå Failed to load presale config:', error);
        }
    }

    function closeStripeModal() {
        document.getElementById('stripe-modal').classList.add('hidden');
        
        // Clear any stored payment data
        localStorage.removeItem('stripePaymentData');
        
        // Reset card element if exists
        if (cardElement) {
            cardElement.clear();
        }
        
        // Reset error display
        const errorDisplay = document.getElementById('card-errors');
        if (errorDisplay) {
            errorDisplay.textContent = '';
            errorDisplay.classList.add('hidden');
        }
        
        // Reset submit button
        const submitBtn = document.getElementById('stripe-submit');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    function displayBonusTiers() {
        const container = document.getElementById('bonus-tiers-info');
        const list = document.getElementById('bonus-tiers-list');
        
        if (!container || !list) return;
        
        if (CONFIG.bonusTiers && CONFIG.bonusTiers.length > 0) {
            container.classList.remove('hidden');
            list.innerHTML = CONFIG.bonusTiers
                .sort((a, b) => parseFloat(a.min_eur) - parseFloat(b.min_eur))
                .map(t => `<div>‚Ç¨${parseFloat(t.min_eur).toLocaleString()}+ ‚Üí <span class="text-green-400">+${t.bonus_percent}% bonus</span></div>`)
                .join('');
        } else {
            container.classList.add('hidden');
        }
    }

    function initStripe() {
        if (!CONFIG.stripePublicKey) {
            console.log('‚ö†Ô∏è Stripe key not loaded yet');
            return;
        }
        
        if (typeof Stripe !== 'undefined') {
            stripe = Stripe(CONFIG.stripePublicKey);
            const elements = stripe.elements();
            
            const cardContainer = document.getElementById('card-element');
            if (cardContainer) {
                cardContainer.innerHTML = '';
            }
            
            cardElement = elements.create('card', {
                hidePostalCode: true,
                disableLink: true,
                style: {
                    base: {
                        color: '#ffffff',
                        fontFamily: 'Montserrat, sans-serif',
                        fontSize: '16px',
                        backgroundColor: '#1a1a1a',
                        '::placeholder': { color: '#6b7280' },
                        iconColor: '#D4AF37'
                    },
                    invalid: { color: '#ef4444', iconColor: '#ef4444' },
                    complete: { color: '#D4AF37', iconColor: '#D4AF37' }
                }
            });
            cardElement.mount('#card-element');
            
            const submitBtn = document.getElementById('stripe-submit');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            cardElement.on('change', (event) => {
                const submitBtn = document.getElementById('stripe-submit');
                const errorDisplay = document.getElementById('card-errors');
                
                if (event.error) {
                    if (errorDisplay) {
                        errorDisplay.textContent = event.error.message;
                        errorDisplay.classList.remove('hidden');
                    }
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                } else {
                    if (errorDisplay) {
                        errorDisplay.textContent = '';
                        errorDisplay.classList.add('hidden');
                    }
                    if (submitBtn) {
                        if (event.complete) {
                            submitBtn.disabled = false;
                            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        } else {
                            submitBtn.disabled = true;
                            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        }
                    }
                }
            });
            
            // ‚úÖ MOVE THE FORM HANDLER HERE - inside initStripe()
            const stripeForm = document.getElementById('stripe-form');
            if (stripeForm) {
                stripeForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const submitBtn = document.getElementById('stripe-submit');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Processing...';
                    }
                    
                    const paymentData = JSON.parse(localStorage.getItem('stripePaymentData') || '{}');
                    
                    if (!paymentData.clientSecret) {
                        showResult('error', 'Payment Error', 'Payment session expired. Please try again.');
                        closeStripeModal();
                        return;
                    }
                    
                    try {
                        const { error, paymentIntent } = await stripe.confirmCardPayment(paymentData.clientSecret, {
                            payment_method: {
                                card: cardElement,
                                billing_details: {
                                    email: sessionData?.email
                                }
                            }
                        });
                        
                        if (error) {
                            const errorDisplay = document.getElementById('card-errors');
                            if (errorDisplay) {
                                errorDisplay.textContent = error.message;
                                errorDisplay.classList.remove('hidden');
                            }
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.textContent = `Pay ‚Ç¨${document.getElementById('stripe-amount')?.textContent || '0.00'}`;
                            }
                            return;
                        }
                        
                        if (paymentIntent.status === 'succeeded') {
                            closeStripeModal();
                            showProcessing('Payment successful! Minting your tokens...');
                            verifyStripePayment(paymentIntent.id, paymentData.tokenAmount);
                        }
                        
                    } catch (err) {
                        console.error('Stripe error:', err);
                        showResult('error', 'Payment Failed', err.message);
                        closeStripeModal();
                    }
                });
            }
            
            console.log('‚úÖ Stripe initialized');
        }
    }


    // ============================================
    // WALLET CONNECTION
    // ============================================
    function checkWalletConnection() {
        console.log('üîç Checking wallet connection...');
        
        // Check URL params first (from WalletTwo redirect)
        const params = new URLSearchParams(window.location.search);
        const walletFromUrl = params.get('wlt') || params.get('wallet') || params.get('address');
        
        if (walletFromUrl) {
            console.log('‚úÖ Found wallet in URL:', walletFromUrl);
            currentWallet = walletFromUrl.toLowerCase();
            
            sessionData = {
                wallet: currentWallet,
                userId: params.get('usr') || params.get('user'),
                timestamp: Date.now()
            };
            
            localStorage.setItem('keavalley_profile', JSON.stringify(sessionData));
            sessionStorage.setItem('keavalley_profile', JSON.stringify(sessionData));
            
            // Clean URL but keep other params
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.delete('wlt');
            newUrl.searchParams.delete('wallet');
            newUrl.searchParams.delete('address');
            newUrl.searchParams.delete('usr');
            newUrl.searchParams.delete('user');
            newUrl.searchParams.delete('code');
            newUrl.searchParams.delete('signature');
            window.history.replaceState({}, document.title, newUrl.pathname + newUrl.search);
            
            showWalletConnected();
            loadBalances();
            checkReferralCode();
            return;
        }
        
        // Check storage
        let profile = sessionStorage.getItem('keavalley_profile') || localStorage.getItem('keavalley_profile');
        
        if (profile) {
            try {
                sessionData = JSON.parse(profile);
                console.log('üì¶ Session data found:', sessionData);
                
                const wallet = sessionData.wallet 
                    || sessionData.walletAddress 
                    || sessionData.address 
                    || sessionData.wallet_address
                    || sessionData.wlt;
                
                if (wallet) {
                    const age = Date.now() - (sessionData.timestamp || 0);
                    if (age > 24 * 60 * 60 * 1000) {
                        console.log('‚ö†Ô∏è Session expired');
                        localStorage.removeItem('keavalley_profile');
                        sessionStorage.removeItem('keavalley_profile');
                        currentWallet = null;
                        updateBuyButton();
                        return;
                    }
                    
                    // ‚úÖ SET currentWallet BEFORE calling showWalletConnected
                    currentWallet = wallet.toLowerCase();
                    console.log('‚úÖ currentWallet set to:', currentWallet);
                    
                    showWalletConnected();
                    loadBalances();
                    checkReferralCode();
                    return;
                }
            } catch (e) {
                console.error('‚ùå Failed to parse session:', e);
            }
        }
        
        console.log('‚ùå No wallet found');
        currentWallet = null;
        updateBuyButton();
    }

    // Listen for WalletTwo messages
    window.addEventListener('message', (event) => {
        if (!event.origin.includes('wallettwo.com')) return;
        
        const data = event.data;
        console.log('üì® WalletTwo message:', data);
        
        if (data && (data.type === 'wallet_login' || data.event === 'wallet_login')) {
            const wallet = data.wallet || data.wlt || data.address;
            
            if (wallet) {
                currentWallet = wallet.toLowerCase();
                
                sessionData = {
                    wallet: currentWallet,
                    userId: data.user || data.usr,
                    email: data.email,
                    name: data.name,
                    timestamp: Date.now()
                };
                
                localStorage.setItem('keavalley_profile', JSON.stringify(sessionData));
                sessionStorage.setItem('keavalley_profile', JSON.stringify(sessionData));
                
                showWalletConnected();
                loadBalances();
                checkReferralCode();
            }
        }
    });

    function connectWallet() {
        document.getElementById('connect-overlay').classList.remove('hidden');
    }

    function hideConnectOverlay() {
        document.getElementById('connect-overlay').classList.add('hidden');
    }

    function redirectToWalletTwo() {
        const redirectUri = encodeURIComponent(window.location.origin + '/presale');
        window.location.href = `${CONFIG.walletTwoOrigin}/auth/login?companyId=6a27c2f8-894c-46c7-bf9f-f5af11d4e092&action=signature&message=VIP_PRESALE&redirect_uri=${redirectUri}`;
    }

    function showWalletConnected() {
        console.log('showWalletConnected called, currentWallet:', currentWallet);
        
        document.getElementById('connect-wallet-btn').classList.add('hidden');
        document.getElementById('wallet-connected').classList.remove('hidden');
        document.getElementById('wallet-address').textContent = 
            currentWallet.slice(0, 6) + '...' + currentWallet.slice(-4);
        document.getElementById('balance-section').classList.remove('hidden');
        
        // Force update buy button after a small delay to ensure state is set
        setTimeout(() => {
            updateBuyButton();
        }, 100);
    }

    function disconnectWallet() {
        sessionStorage.removeItem('keavalley_profile');
        localStorage.removeItem('keavalley_profile');
        currentWallet = null;
        sessionData = null;
        document.getElementById('connect-wallet-btn').classList.remove('hidden');
        document.getElementById('wallet-connected').classList.add('hidden');
        document.getElementById('balance-section').classList.add('hidden');
        updateBuyButton();
    }

    async function loadBalances() {
        if (!currentWallet) return;

        const rpcUrls = [
            'https://polygon-bor-rpc.publicnode.com',
            'https://polygon.llamarpc.com',
            'https://rpc.ankr.com/polygon',
            'https://polygon-rpc.com'
        ];

        for (const rpcUrl of rpcUrls) {
            try {
                console.log(`üîÑ Trying RPC: ${rpcUrl}`);
                const provider = new ethers.JsonRpcProvider(rpcUrl);
                
                const polBalance = await provider.getBalance(currentWallet);
                balances.POL = parseFloat(ethers.formatEther(polBalance));

                const usdcContract = new ethers.Contract(
                    CONFIG.usdcAddress,
                    ['function balanceOf(address) view returns (uint256)'],
                    provider
                );
                const usdcBalance = await usdcContract.balanceOf(currentWallet);
                balances.USDC = parseFloat(ethers.formatUnits(usdcBalance, CONFIG.usdcDecimals));

                console.log(`‚úÖ Balances - POL: ${balances.POL}, USDC: ${balances.USDC}`);
                updateBalanceDisplay();
                updateBuyButton();
                return;
                
            } catch (error) {
                console.warn(`‚ö†Ô∏è RPC ${rpcUrl} failed:`, error.message);
                continue;
            }
        }
        
        console.error('‚ùå All RPCs failed');
        balances.POL = 0;
        balances.USDC = 0;
        updateBalanceDisplay();
        updateBuyButton();
    }

    function updateBalanceDisplay() {
        const display = document.getElementById('balance-display');
        if (selectedPayment === 'POL') {
            display.textContent = `${balances.POL.toFixed(4)} POL`;
        } else if (selectedPayment === 'USDC') {
            display.textContent = `${balances.USDC.toFixed(2)} USDC`;
        } else {
            display.textContent = '--';
        }
    }

    // ============================================
    // PAYMENT SELECTION
    // ============================================
    function selectPayment(method) {
        selectedPayment = method;
        document.querySelectorAll('.payment-option').forEach(el => {
            el.classList.toggle('selected', el.dataset.method === method);
        });
        updateBalanceDisplay();
        updateTotals();
        updateBuyButton();
    }

    // ============================================
    // CALCULATIONS
    // ============================================
    function updateTotals() {
        const eurInput = document.getElementById('eur-amount');
        const eurAmount = parseFloat(eurInput?.value) || 0;
        
        const tokenPrice = CONFIG.tokenPriceEUR || 1.00;
        const minPurchase = CONFIG.minPurchase || 10;
        const baseTokens = Math.floor(eurAmount / tokenPrice);
        
        // Calculate bonus
        let bonusPercent = 0;
        let bonusTokens = 0;
        
        if (CONFIG.bonusTiers && CONFIG.bonusTiers.length > 0) {
            const matchingTier = [...CONFIG.bonusTiers]
                .filter(t => parseFloat(t.min_eur) <= eurAmount)
                .sort((a, b) => parseFloat(b.min_eur) - parseFloat(a.min_eur))[0];
            
            if (matchingTier) {
                bonusPercent = parseFloat(matchingTier.bonus_percent);
                bonusTokens = Math.floor(baseTokens * bonusPercent / 100);
            }
        }
        
        const totalTokens = baseTokens + bonusTokens;
        
        // Update token display
        const tokenDisplay = document.getElementById('token-amount-display');
        if (tokenDisplay) {
            if (bonusTokens > 0) {
                tokenDisplay.innerHTML = `${totalTokens.toLocaleString()} <span class="text-green-400 text-xs">(+${bonusTokens} bonus)</span>`;
            } else {
                tokenDisplay.textContent = totalTokens.toLocaleString();
            }
        }
        
        // Update min purchase display
        const minDisplay = document.getElementById('min-purchase-display');
        if (minDisplay) minDisplay.textContent = minPurchase.toLocaleString();
        
        // Show bonus badge
        const bonusBadge = document.getElementById('bonus-badge');
        if (bonusBadge) {
            if (bonusPercent > 0) {
                bonusBadge.innerHTML = `<span class="bg-green-500/20 text-green-400 px-2 py-1 rounded-full text-xs">+${bonusPercent}% BONUS</span>`;
                bonusBadge.classList.remove('hidden');
            } else {
                bonusBadge.classList.add('hidden');
            }
        }
        
        // Validate minimum
        if (eurAmount < minPurchase && eurAmount > 0) {
            eurInput?.classList.add('border-red-500');
        } else {
            eurInput?.classList.remove('border-red-500');
        }
        
        // Calculate fees
        const feePercent = selectedPayment === 'Card' ? CONFIG.cardFeePercent : CONFIG.cryptoFeePercent;
        const feeEUR = eurAmount * (feePercent / 100);
        const totalEUR = eurAmount + feeEUR;
        const totalUSD = totalEUR * CONFIG.eurUsdRate;
        const polAmount = totalUSD / CONFIG.polPrice;
        
        // Update displays
        document.getElementById('totalTokensDisplay').textContent = `${totalTokens.toLocaleString()} VIP`;
        document.getElementById('subtotalEUR').textContent = `‚Ç¨${eurAmount.toFixed(2)}`;
        document.getElementById('feePercent').textContent = feePercent;
        document.getElementById('feeAmountEUR').textContent = `‚Ç¨${feeEUR.toFixed(2)}`;
        document.getElementById('totalEUR').textContent = `‚Ç¨${totalEUR.toFixed(2)}`;
        document.getElementById('totalUSD').textContent = `($${totalUSD.toFixed(2)})`;
        
        // Crypto equivalent
        if (selectedPayment === 'POL') {
            document.getElementById('cryptoEquivalent').textContent = `~${polAmount.toFixed(2)} POL`;
        } else if (selectedPayment === 'USDC') {
            document.getElementById('cryptoEquivalent').textContent = `~${totalUSD.toFixed(2)} USDC`;
        } else {
            document.getElementById('cryptoEquivalent').textContent = `‚Ç¨${totalEUR.toFixed(2)}`;
        }
        
        // Store for purchase
        window.currentPurchase = {
            eurAmount,
            baseTokens,
            bonusTokens,
            totalTokens,
            bonusPercent,
            feeEUR,
            totalEUR,
            totalUSD,
            polAmount
        };
        
        // Update buy button
        updateBuyButton();
    }

    function updateBuyButton() {
        const btn = document.getElementById('buy-button');
        if (!btn) return;
        
        console.log('updateBuyButton called:', {
            currentWallet,
            presaleEnabled: CONFIG.presaleEnabled,
            selectedPayment
        });
        
        const eurAmount = parseFloat(document.getElementById('eur-amount')?.value) || 0;
        const purchase = window.currentPurchase || {};

        if (!currentWallet) {
            console.log('‚ùå No wallet - showing connect button');
            btn.textContent = 'Connect Wallet to Purchase';
            btn.disabled = true;
            return;
        }

        if (!CONFIG.presaleEnabled) {
            btn.textContent = 'Presale Not Active';
            btn.disabled = true;
            return;
        }

        if (eurAmount < CONFIG.minPurchase) {
            btn.textContent = `Minimum ‚Ç¨${CONFIG.minPurchase}`;
            btn.disabled = true;
            return;
        }

        const totalEUR = purchase.totalEUR || 0;
        const totalUSD = purchase.totalUSD || 0;

        if (selectedPayment === 'Card') {
            btn.textContent = `Pay ‚Ç¨${totalEUR.toFixed(2)}`;
            btn.disabled = false;
        } else if (selectedPayment === 'POL') {
            const requiredPOL = purchase.polAmount || 0;
            if (balances.POL >= requiredPOL) {
                btn.textContent = `Pay ~${requiredPOL.toFixed(2)} POL`;
                btn.disabled = false;
            } else {
                btn.textContent = 'Insufficient POL Balance';
                btn.disabled = true;
            }
        } else if (selectedPayment === 'USDC') {
            if (balances.USDC >= totalUSD) {
                btn.textContent = `Pay ~${totalUSD.toFixed(2)} USDC`;
                btn.disabled = false;
            } else {
                btn.textContent = 'Insufficient USDC Balance';
                btn.disabled = true;
            }
        }
    }

    function updateProgress() {
        const eurRaised = CONFIG.eurRaised || 0;
        const targetEUR = CONFIG.saleTargetEUR || 500000;
        const progressPct = targetEUR > 0 ? ((eurRaised / targetEUR) * 100) : 0;
        
        document.getElementById('progress-bar').style.width = `${Math.min(progressPct, 100)}%`;
        document.getElementById('progress-pct').textContent = progressPct.toFixed(2) + '%';
        document.getElementById('progress-raised').textContent = '‚Ç¨' + eurRaised.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('progress-target').textContent = '‚Ç¨' + targetEUR.toLocaleString();
        document.getElementById('tokens-sold').textContent = (CONFIG.tokensSold || 0).toLocaleString();
    }

    // ============================================
    // PURCHASE EXECUTION
    // ============================================
    async function executePurchase() {
        if (!currentWallet) {
            connectWallet();
            return;
        }

        if (!CONFIG.presaleEnabled) {
            showResult('error', 'Presale Not Active', 'The presale is currently not available.');
            return;
        }

        const purchase = window.currentPurchase || {};
        const eurAmount = purchase.eurAmount || 0;
        const baseTokens = purchase.baseTokens || 0;  // ‚úÖ Use baseTokens, not totalTokens
        const totalTokens = purchase.totalTokens || 0; // For display only

        if (eurAmount < CONFIG.minPurchase) {
            showResult('error', 'Invalid Amount', `Minimum purchase is ‚Ç¨${CONFIG.minPurchase}.`);
            return;
        }

        // Store pending purchase - send BASE tokens, server will add bonus
        const pendingPurchase = {
            walletAddress: currentWallet,
            tokenAmount: baseTokens,        // ‚úÖ FIXED: Send base tokens only
            expectedTotal: totalTokens,     // For reference/display
            bonusPercent: purchase.bonusPercent,
            baseEUR: eurAmount,
            feeEUR: purchase.feeEUR,
            totalEUR: purchase.totalEUR,
            totalUSD: purchase.totalUSD,
            paymentMethod: selectedPayment,
            timestamp: Date.now()
        };
        localStorage.setItem('pendingPurchase', JSON.stringify(pendingPurchase));

        if (selectedPayment === 'Card') {
            if (!stripe) {
                showResult('error', 'Payment Error', 'Card payments are not configured. Please try crypto payment.');
                return;
            }
            // ‚úÖ Pass baseTokens to Stripe, not totalTokens
            openStripeCheckout(baseTokens, eurAmount, purchase.feeEUR, purchase.totalEUR);
        } else {
            // ‚úÖ Pass baseTokens to crypto purchase
            executeCryptoPurchase(baseTokens, purchase.totalUSD, eurAmount, purchase.feeEUR);
        }
    }

    function executeCryptoPurchase(tokenAmount, totalUSD, baseEUR, feeEUR) {
        const baseUSD = baseEUR * CONFIG.eurUsdRate;
        const feeUSD = feeEUR * CONFIG.eurUsdRate;

        if (!CONFIG.presaleWallet) {
            showResult('error', 'Configuration Error', 'Presale wallet not configured.');
            return;
        }

        let transactions = [];
        const externalId = `presale-${Date.now()}`;
        const redirectUri = encodeURIComponent(`${window.location.origin}/presale?purchase=complete`);

        if (selectedPayment === 'USDC') {
            const baseUsdcAmount = Math.floor(baseUSD * 1e6);
            const feeUsdcAmount = Math.ceil(feeUSD * 1e6);

            transactions = [
                {
                    type: 'erc20_transfer',
                    token: CONFIG.usdcAddress,
                    to: CONFIG.presaleWallet,
                    amount: baseUsdcAmount.toString(),
                    description: `VIP Presale: ${baseUSD.toFixed(2)} USDC`
                },
                {
                    type: 'erc20_transfer',
                    token: CONFIG.usdcAddress,
                    to: CONFIG.minterWallet,
                    amount: feeUsdcAmount.toString(),
                    description: `Platform fee: ${feeUSD.toFixed(2)} USDC`
                }
            ];
        } else {
            const basePOL = baseUSD / CONFIG.polPrice;
            const feePOL = feeUSD / CONFIG.polPrice;
            const baseWei = BigInt(Math.floor(basePOL * 1e18)).toString();
            const feeWei = BigInt(Math.ceil(feePOL * 1e18)).toString();

            transactions = [
                {
                    type: 'native_transfer',
                    to: CONFIG.presaleWallet,
                    amount: baseWei,
                    description: `VIP Presale: ${basePOL.toFixed(4)} POL`
                },
                {
                    type: 'native_transfer',
                    to: CONFIG.minterWallet,
                    amount: feeWei,
                    description: `Platform fee: ${feePOL.toFixed(4)} POL`
                }
            ];
        }

        const txData = encodeURIComponent(JSON.stringify({
            chainId: CONFIG.chainId,
            transactions,
            metadata: {
                type: 'presale_purchase',
                tokenAmount,           // ‚úÖ Base tokens only
                totalUSD,
                baseEUR,
                feeEUR,
                paymentMethod: selectedPayment
            }
        }));

        window.location.href = `${CONFIG.walletTwoOrigin}/transaction/multi?data=${txData}&external_id=${externalId}&redirect_uri=${redirectUri}`;
    }

    // ============================================
    // STRIPE CHECKOUT
    // ============================================
    function openStripeCheckout(tokenAmount, baseEUR, feeEUR, totalEUR) {
        // Calculate what user will receive (for display)
        const purchase = window.currentPurchase || {};
        const totalTokens = purchase.totalTokens || tokenAmount;
        const bonusTokens = purchase.bonusTokens || 0;
        
        // Show total tokens user will receive (with bonus)
        if (bonusTokens > 0) {
            document.getElementById('stripe-tokens').innerHTML = `${totalTokens} VIP <span class="text-green-400 text-xs">(+${bonusTokens} bonus)</span>`;
        } else {
            document.getElementById('stripe-tokens').textContent = `${totalTokens} VIP`;
        }
        
        document.getElementById('stripe-subtotal').textContent = `‚Ç¨${baseEUR.toFixed(2)}`;
        document.getElementById('stripe-fee').textContent = `‚Ç¨${feeEUR.toFixed(2)}`;
        document.getElementById('stripe-total').textContent = `‚Ç¨${totalEUR.toFixed(2)}`;
        document.getElementById('stripe-amount').textContent = totalEUR.toFixed(2);

        const submitBtn = document.getElementById('stripe-submit');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
        
        const errorDisplay = document.getElementById('card-errors');
        if (errorDisplay) {
            errorDisplay.textContent = '';
            errorDisplay.classList.add('hidden');
        }
        
        if (cardElement) cardElement.clear();

        document.getElementById('stripe-modal').classList.remove('hidden');
        
        // ‚úÖ Pass base tokens to payment intent
        createPaymentIntent(tokenAmount, totalEUR);
    }

    async function createPaymentIntent(tokenAmount, totalEUR) {
        try {
            const purchase = window.currentPurchase || {};
            
            const response = await fetch('/api/presale/create-payment-intent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    walletAddress: currentWallet,
                    tokenAmount,          // ‚úÖ Base tokens - server adds bonus
                    totalEUR,
                    baseAmount: purchase.eurAmount,  // ‚úÖ Add base EUR for bonus calculation
                    feeAmount: purchase.feeEUR,
                    email: sessionData?.email
                })
            });

            if (!response.ok) throw new Error('Failed to create payment intent');

            const data = await response.json();
            localStorage.setItem('stripePaymentData', JSON.stringify({
                clientSecret: data.clientSecret,
                paymentIntentId: data.paymentIntentId,
                tokenAmount,              // Base tokens
                totalEUR,
                expectedTotalTokens: purchase.totalTokens  // For display after purchase
            }));

        } catch (error) {
            console.error('Payment intent error:', error);
            showResult('error', 'Payment Error', 'Failed to initialize payment.');
            closeStripeModal();
        }
    }

    async function verifyStripePayment(paymentIntentId, tokenAmount) {
        try {
            showProcessing('Payment received! Minting your tokens...');
            
            const paymentData = JSON.parse(localStorage.getItem('stripePaymentData') || '{}');
            let attempts = 0;
            const maxAttempts = 60;
            
            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(`/api/presale/purchase-status/${paymentIntentId}`);
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`üîÑ Poll ${attempts + 1}: ${data.status}`);
                        
                        if (data.status === 'completed' && data.mintTxHash) {
                            hideProcessing();
                            
                            // Show actual tokens minted (base + bonus from server)
                            const tokensReceived = data.totalTokens || data.tokenAmount || tokenAmount;
                            const bonusTokens = data.bonusTokens || 0;
                            
                            let message = `Successfully purchased ${tokensReceived} VIP tokens!`;
                            if (bonusTokens > 0) {
                                message = `Successfully purchased ${tokensReceived} VIP tokens (includes +${bonusTokens} bonus)!`;
                            }
                            
                            showResult('success', 'Purchase Complete!', message,
                                { tokens: tokensReceived, mintTx: data.mintTxHash }
                            );
                            localStorage.removeItem('pendingPurchase');
                            localStorage.removeItem('stripePaymentData');
                            loadPresaleConfig();
                            return;
                        }
                        
                        if (data.status === 'mint_failed' || data.status === 'failed') {
                            hideProcessing();
                            showResult('error', 'Minting Failed', data.error || 'Contact support.');
                            return;
                        }
                    }
                } catch (e) {
                    console.warn('Poll error:', e);
                }
                
                attempts++;
                await new Promise(r => setTimeout(r, 1000));
            }
            
            hideProcessing();
            showResult('info', 'Processing', 'Payment received. Tokens will arrive shortly.');
            localStorage.removeItem('pendingPurchase');
            localStorage.removeItem('stripePaymentData');
            
        } catch (error) {
            hideProcessing();
            showResult('error', 'Error', error.message);
        }
    }

    async function verifyCryptoPayment(txHash) {
        try {
            const pendingPurchase = JSON.parse(localStorage.getItem('pendingPurchase') || '{}');

            const response = await fetch('/api/presale/verify-payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    txHash,
                    walletAddress: currentWallet || pendingPurchase.walletAddress,
                    tokenAmount: pendingPurchase.tokenAmount,  // ‚úÖ Now this is base tokens
                    totalEUR: pendingPurchase.totalEUR,
                    totalUSD: pendingPurchase.totalUSD,
                    paymentMethod: pendingPurchase.paymentMethod,
                    referrerCode: localStorage.getItem('referralCode')
                })
            });

            const data = await response.json();
            hideProcessing();

            if (data.success) {
                // Show actual tokens received (with bonus from server)
                const tokensReceived = data.totalTokens || pendingPurchase.expectedTotal || pendingPurchase.tokenAmount;
                const bonusTokens = data.bonusTokens || 0;
                
                let message = data.message || `Successfully purchased ${tokensReceived} VIP tokens!`;
                if (bonusTokens > 0 && !data.message) {
                    message = `Successfully purchased ${tokensReceived} VIP tokens (includes +${bonusTokens} bonus)!`;
                }
                
                showResult('success', 'Purchase Complete!', message,
                    { tokens: tokensReceived, paymentTx: txHash, mintTx: data.mintTxHash }
                );
                localStorage.removeItem('pendingPurchase');
                localStorage.removeItem('referralCode');
                loadPresaleConfig();
            } else {
                showResult('error', 'Verification Failed', data.error || 'Contact support.');
            }

            window.history.replaceState({}, document.title, window.location.pathname);

        } catch (error) {
            hideProcessing();
            showResult('error', 'Verification Error', error.message);
        }
    }
    // ============================================
    // URL PARAMS & CRYPTO VERIFICATION
    // ============================================
    function checkUrlParams() {
        const params = new URLSearchParams(window.location.search);
        
        if (params.get('purchase') === 'complete') {
            const txHash = params.get('tx_hash');
            if (txHash) {
                showProcessing('Verifying crypto payment...');
                verifyCryptoPayment(txHash);
            }
        }

        const ref = params.get('ref');
        if (ref) {
            localStorage.setItem('referralCode', ref);
        }
    }

    async function verifyCryptoPayment(txHash) {
        try {
            const pendingPurchase = JSON.parse(localStorage.getItem('pendingPurchase') || '{}');

            const response = await fetch('/api/presale/verify-payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    txHash,
                    walletAddress: currentWallet || pendingPurchase.walletAddress,
                    tokenAmount: pendingPurchase.tokenAmount,
                    totalEUR: pendingPurchase.totalEUR,
                    totalUSD: pendingPurchase.totalUSD,
                    paymentMethod: pendingPurchase.paymentMethod,
                    referrerCode: localStorage.getItem('referralCode')
                })
            });

            const data = await response.json();
            hideProcessing();

            if (data.success) {
                showResult('success', 'Purchase Complete!',
                    data.message || `Successfully purchased ${pendingPurchase.tokenAmount} VIP tokens!`,
                    { tokens: pendingPurchase.tokenAmount, paymentTx: txHash, mintTx: data.mintTxHash }
                );
                localStorage.removeItem('pendingPurchase');
                localStorage.removeItem('referralCode');
                loadPresaleConfig();
            } else {
                showResult('error', 'Verification Failed', data.error || 'Contact support.');
            }

            window.history.replaceState({}, document.title, window.location.pathname);

        } catch (error) {
            hideProcessing();
            showResult('error', 'Verification Error', error.message);
        }
    }

    // ============================================
    // REFERRAL
    // ============================================
    async function checkReferralCode() {
        const savedCode = localStorage.getItem('referralCode');
        if (savedCode && currentWallet) {
            try {
                const response = await fetch(`/api/referral/validate/${savedCode}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.valid) {
                        document.getElementById('referral-section').classList.remove('hidden');
                        document.getElementById('referral-code').textContent = savedCode;
                    }
                }
            } catch (e) {
                console.error('Referral validation failed:', e);
            }
        }
    }

    // ============================================
    // UI HELPERS
    // ============================================
    function showProcessing(message) {
        document.getElementById('processing-message').textContent = message;
        document.getElementById('processing-overlay').classList.remove('hidden');
    }

    function hideProcessing() {
        document.getElementById('processing-overlay').classList.add('hidden');
    }

    function showResult(type, title, message, details = null) {
        const icon = document.getElementById('result-icon');
        icon.textContent = type === 'success' ? 'check_circle' : (type === 'info' ? 'info' : 'error');
        icon.className = `material-symbols-outlined text-5xl mb-4 ${
            type === 'success' ? 'text-green-500' : (type === 'info' ? 'text-blue-500' : 'text-red-500')
        }`;
        
        document.getElementById('result-title').textContent = title;
        document.getElementById('result-message').textContent = message;

        if (details) {
            document.getElementById('result-details').classList.remove('hidden');
            document.getElementById('result-tokens').textContent = `${details.tokens} VIP`;
            
            if (details.paymentTx) {
                document.getElementById('result-payment-tx').href = `${CONFIG.explorer}/tx/${details.paymentTx}`;
                document.getElementById('result-payment-tx').textContent = details.paymentTx.slice(0, 10) + '...';
            }
            if (details.mintTx) {
                document.getElementById('result-mint-tx').href = `${CONFIG.explorer}/tx/${details.mintTx}`;
                document.getElementById('result-mint-tx').textContent = details.mintTx.slice(0, 10) + '...';
            }
        } else {
            document.getElementById('result-details').classList.add('hidden');
        }

        document.getElementById('result-overlay').classList.remove('hidden');
    }

    function hideResultOverlay() {
        document.getElementById('result-overlay').classList.add('hidden');
    }
</script>
</body>
</html>
