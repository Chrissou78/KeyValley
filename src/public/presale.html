<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Presale | Kea Valley</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#ee9d2b",
                        "primary-light": "#fbdea6",
                        "background-dark": "#0a0a0a",
                        "surface": "#121212",
                    },
                    fontFamily: {
                        "sans": ["Manrope", "sans-serif"],
                        "serif": ["Playfair Display", "serif"],
                    },
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Manrope', sans-serif; background: #0a0a0a; }
        h1, h2, h3, .font-serif { font-family: 'Playfair Display', serif; }
        
        .gold-glow:hover {
            box-shadow: 0 0 30px rgba(238, 157, 43, 0.4);
        }
        
        .glass-card {
            background: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #ee9d2b 0%, #fbdea6 100%);
            box-shadow: 0 0 20px rgba(238, 157, 43, 0.5);
        }
        
        .token-input::-webkit-inner-spin-button,
        .token-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .token-input {
            -moz-appearance: textfield;
        }
        
        .payment-option {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .payment-option:hover {
            border-color: rgba(238, 157, 43, 0.5);
            background: rgba(238, 157, 43, 0.05);
        }
        
        .payment-option.selected {
            border-color: #ee9d2b;
            background: rgba(238, 157, 43, 0.1);
        }
        
        .payment-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(238, 157, 43, 0.3); }
            50% { box-shadow: 0 0 40px rgba(238, 157, 43, 0.6); }
        }
        
        .live-indicator {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        .not-connected-overlay {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .currency-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="min-h-screen text-white">
    
    <!-- Header -->
    <header class="fixed top-0 w-full z-50 backdrop-blur-xl bg-black/70 border-b border-white/5">
        <div class="max-w-7xl mx-auto px-6 lg:px-12 flex items-center justify-between h-16">
            <a href="/" class="flex items-center gap-3 group">
                <div class="size-8 text-primary transition-transform duration-500 group-hover:rotate-180">
                    <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M44 4H30.6666V17.3334H17.3334V30.6666H4V44H44V4Z" fill="currentColor"></path>
                    </svg>
                </div>
                <span class="text-lg font-serif font-bold tracking-widest uppercase">Kea Valley</span>
            </a>
            <nav class="flex items-center gap-6">
                <a href="/" class="text-sm text-gray-400 hover:text-primary transition-colors">Home</a>
                <a href="/profile" class="text-sm text-gray-400 hover:text-primary transition-colors">Profile</a>
                <a href="/claim" class="text-sm text-gray-400 hover:text-primary transition-colors">Claim</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-24 pb-16 px-6">
        <div class="max-w-6xl mx-auto">
            
            <!-- Hero Section -->
            <div class="text-center mb-12">
                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-primary/10 border border-primary/30 mb-6">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-primary text-sm font-bold uppercase tracking-widest">Presale Live</span>
                </div>
                <h1 class="text-4xl md:text-6xl font-serif italic mb-4">
                    <span class="text-white">VIP Token</span>
                    <span class="text-primary"> Presale</span>
                </h1>
                <p class="text-gray-400 text-lg max-w-2xl mx-auto">
                    Get early access to VIP tokens at an exclusive presale price. Pay with crypto (POL or USDC).
                </p>
            </div>

            <!-- Main Grid -->
            <div class="grid lg:grid-cols-2 gap-8">
                
                <!-- Left: Presale Info -->
                <div class="space-y-6">
                    
                    <!-- Progress Card -->
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xs font-bold uppercase tracking-widest text-primary">Sale Progress</h3>
                            <span class="text-xs text-gray-500" id="progressPercent">0%</span>
                        </div>
                        
                        <div class="h-4 bg-surface rounded-full overflow-hidden mb-4">
                            <div id="progressBar" class="progress-bar h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        
                        <div class="flex justify-between text-sm">
                            <div>
                                <p class="text-gray-500">Sold</p>
                                <p class="text-white font-semibold" id="tokensSold">0 VIP</p>
                            </div>
                            <div class="text-right">
                                <p class="text-gray-500">Total</p>
                                <p class="text-white font-semibold" id="totalTokens">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price Info -->
                    <div class="glass-card rounded-2xl p-6">
                        <h3 class="text-xs font-bold uppercase tracking-widest text-primary mb-4">Token Price</h3>
                        
                        <div class="flex items-end gap-4 mb-4">
                            <div>
                                <p class="text-4xl font-serif text-white" id="tokenPriceEUR">€0.00</p>
                                <p class="text-gray-500 text-sm">per VIP token</p>
                            </div>
                            <div class="px-3 py-1 bg-green-500/10 border border-green-500/30 rounded text-green-400 text-xs font-bold">
                                PRESALE PRICE
                            </div>
                        </div>
                        
                        <!-- USD Equivalent -->
                        <div class="bg-surface rounded-lg p-3 mb-6">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500 text-sm">USD Equivalent</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-white font-semibold" id="tokenPriceUSD">$0.00</span>
                                    <span class="currency-badge bg-blue-500/20 text-blue-400">Live Rate</span>
                                </div>
                            </div>
                            <p class="text-gray-600 text-xs mt-1">EUR/USD: <span id="eurUsdRate">1.00</span></p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-surface rounded-lg p-4">
                                <p class="text-gray-500 text-xs mb-1">Min Purchase</p>
                                <p class="text-white font-semibold" id="minPurchase">10 VIP</p>
                            </div>
                            <div class="bg-surface rounded-lg p-4">
                                <p class="text-gray-500 text-xs mb-1">Max Purchase</p>
                                <p class="text-white font-semibold" id="maxPurchase">10,000 VIP</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Accepted Payments -->
                    <div class="glass-card rounded-2xl p-6">
                        <h3 class="text-xs font-bold uppercase tracking-widest text-primary mb-4">Accepted Payments</h3>
                        <div class="flex flex-wrap gap-3">
                            <div class="flex items-center gap-2 bg-surface rounded-lg px-4 py-2">
                                <div class="w-8 h-5 bg-purple-600 rounded flex items-center justify-center">
                                    <span class="text-white text-xs font-bold">POL</span>
                                </div>
                                <span class="text-gray-400 text-sm">Polygon</span>
                            </div>
                            <div class="flex items-center gap-2 bg-surface rounded-lg px-4 py-2">
                                <div class="w-8 h-5 bg-blue-500 rounded flex items-center justify-center">
                                    <span class="text-white text-xs font-bold">$</span>
                                </div>
                                <span class="text-gray-400 text-sm">USDC</span>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center gap-2 text-xs text-gray-500">
                            <span class="material-symbols-outlined text-sm">info</span>
                            Crypto payments converted at live EUR/USD rate
                        </div>
                    </div>
                    
                    <!-- Token Info -->
                    <div class="glass-card rounded-2xl p-6">
                        <h3 class="text-xs font-bold uppercase tracking-widest text-primary mb-4">Token Details</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between py-2 border-b border-white/5">
                                <span class="text-gray-500">Token Name</span>
                                <span class="text-white font-medium">Kea Valley VIP</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-white/5">
                                <span class="text-gray-500">Symbol</span>
                                <span class="text-white font-medium">VIP</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-white/5">
                                <span class="text-gray-500">Network</span>
                                <span class="text-white font-medium">Polygon</span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span class="text-gray-500">Contract</span>
                                <a href="https://polygonscan.com/token/0x6860c34db140DB7B589DaDA38859a1d3736bbE3F" target="_blank" 
                                   class="text-primary hover:underline font-mono text-sm">
                                    0x6860...bE3F
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right: Purchase Form -->
                <div class="glass-card rounded-2xl p-6 lg:p-8 live-indicator relative">
                    
                    <!-- Not Connected Overlay -->
                    <div id="notConnectedOverlay" class="absolute inset-0 not-connected-overlay rounded-2xl flex flex-col items-center justify-center z-10 hidden">
                        <div class="text-center px-8">
                            <div class="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-6">
                                <span class="material-symbols-outlined text-primary text-4xl">account_balance_wallet</span>
                            </div>
                            <h3 class="text-2xl font-serif text-white mb-3">Wallet Not Connected</h3>
                            <p class="text-gray-400 mb-8">Please connect your wallet from your profile to participate in the presale.</p>
                            <a href="/profile" 
                               class="inline-flex items-center gap-3 bg-primary text-background-dark px-8 py-4 rounded-xl font-bold uppercase tracking-widest text-sm gold-glow hover:scale-[1.02] transition-all">
                                <span class="material-symbols-outlined">person</span>
                                Go to Profile
                            </a>
                        </div>
                    </div>
                    
                    <!-- Connected Wallet Header -->
                    <div id="walletHeader" class="flex items-center justify-between mb-6 pb-6 border-b border-white/10">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-green-500/20 rounded-full flex items-center justify-center">
                                <span class="material-symbols-outlined text-green-400">check_circle</span>
                            </div>
                            <div>
                                <p class="text-white font-medium" id="walletAddressDisplay">0x...</p>
                                <p class="text-green-400 text-sm">Wallet Connected</p>
                            </div>
                        </div>
                        <a href="/profile" class="text-gray-500 hover:text-primary transition-colors text-sm flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">open_in_new</span>
                            Profile
                        </a>
                    </div>
                    
                    <!-- Purchase Form Section -->
                    <div id="purchaseFormSection">
                        
                        <!-- Step 1 Header -->
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-black font-bold text-sm">1</div>
                            <h3 class="text-lg font-semibold text-white">Choose Amount</h3>
                        </div>
                        
                        <!-- Token Amount Input -->
                        <div class="mb-6">
                            <div class="relative">
                                <input 
                                    type="number" 
                                    id="tokenAmount" 
                                    placeholder="100"
                                    min="10"
                                    class="token-input w-full bg-surface border border-white/10 rounded-xl px-4 py-4 text-2xl text-white placeholder-gray-600 focus:border-primary focus:outline-none"
                                    oninput="updateTotals()"
                                >
                                <div class="absolute right-4 top-1/2 -translate-y-1/2 flex items-center gap-2">
                                    <span class="text-primary font-bold">VIP</span>
                                </div>
                            </div>
                            <div class="flex justify-between mt-3 text-sm">
                                <button onclick="setAmount(100)" class="px-3 py-1 rounded bg-surface text-gray-400 hover:text-primary hover:bg-primary/10 transition-colors">100</button>
                                <button onclick="setAmount(500)" class="px-3 py-1 rounded bg-surface text-gray-400 hover:text-primary hover:bg-primary/10 transition-colors">500</button>
                                <button onclick="setAmount(1000)" class="px-3 py-1 rounded bg-surface text-gray-400 hover:text-primary hover:bg-primary/10 transition-colors">1,000</button>
                                <button onclick="setAmount(5000)" class="px-3 py-1 rounded bg-surface text-gray-400 hover:text-primary hover:bg-primary/10 transition-colors">5,000</button>
                                <button onclick="setMax()" class="px-3 py-1 rounded bg-primary/20 text-primary font-bold hover:bg-primary/30 transition-colors">MAX</button>
                            </div>
                        </div>
                        
                        <!-- Total Summary -->
                        <div class="bg-surface rounded-xl p-4 mb-6">
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-500">Token Price</span>
                                <div class="text-right">
                                    <span class="text-white" id="displayPriceEUR">€1.00</span>
                                    <span class="text-gray-500 text-xs ml-1">(<span id="displayPriceUSD">$1.19</span>)</span>
                                </div>
                            </div>
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-500">Quantity</span>
                                <span class="text-white" id="displayQuantity">0 VIP</span>
                            </div>
                            <div class="border-t border-white/10 my-3"></div>
                            <div class="flex justify-between items-center">
                                <span class="text-white font-bold text-lg">Total</span>
                                <div class="text-right">
                                    <p class="text-primary text-2xl font-bold" id="displayTotalEUR">€0.00</p>
                                    <p class="text-gray-400 text-sm" id="displayTotalUSD">≈ $0.00 USD</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 2 Header -->
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-black font-bold text-sm">2</div>
                            <h3 class="text-lg font-semibold text-white">Choose Payment Method</h3>
                        </div>
                        
                        <!-- Payment Methods -->
                        <div class="space-y-3 mb-6">
                            <!-- POL (default selected) -->
                            <div onclick="selectPayment('POL')" id="payPOL" 
                                 class="payment-option selected border border-white/10 rounded-xl p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-8 bg-purple-600 rounded flex items-center justify-center">
                                            <span class="text-white font-bold text-sm">POL</span>
                                        </div>
                                        <div>
                                            <p class="text-white font-medium">POL (Polygon)</p>
                                            <p class="text-gray-500 text-xs" id="polEquivalent">≈ 0 POL</p>
                                        </div>
                                    </div>
                                    <div class="w-5 h-5 rounded-full border-2 border-primary flex items-center justify-center" id="polRadio">
                                        <div class="w-3 h-3 rounded-full bg-primary"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- USDC -->
                            <div onclick="selectPayment('USDC')" id="payUSDC" 
                                 class="payment-option border border-white/10 rounded-xl p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-8 bg-blue-500 rounded flex items-center justify-center">
                                            <span class="text-white font-bold text-sm">USDC</span>
                                        </div>
                                        <div>
                                            <p class="text-white font-medium">USDC (Stablecoin)</p>
                                            <p class="text-gray-500 text-xs" id="usdcEquivalent">≈ 0 USDC</p>
                                        </div>
                                    </div>
                                    <div class="w-5 h-5 rounded-full border-2 border-gray-600 flex items-center justify-center" id="usdcRadio">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Card (disabled) -->
                            <div id="payCard" class="payment-option disabled border border-white/10 rounded-xl p-4 opacity-50">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-8 bg-gray-600 rounded flex items-center justify-center">
                                            <span class="text-white font-bold text-xs">CARD</span>
                                        </div>
                                        <div>
                                            <p class="text-white font-medium">Credit / Debit Card</p>
                                            <p class="text-yellow-500 text-xs">Coming Soon</p>
                                        </div>
                                    </div>
                                    <div class="w-5 h-5 rounded-full border-2 border-gray-600 flex items-center justify-center" id="cardRadio">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Crypto Balance -->
                        <div id="cryptoBalanceSection" class="mb-6 px-1">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">Your Balance:</span>
                                <span class="text-white" id="userBalance">Loading...</span>
                            </div>
                        </div>
                        
                        <!-- Crypto Payment Info -->
                        <div id="cryptoPaymentInfo" class="mb-6 bg-surface rounded-xl p-4">
                            <div class="flex items-start gap-3">
                                <span class="material-symbols-outlined text-primary">info</span>
                                <div class="text-sm">
                                    <p class="text-gray-400 mb-2">Send payment in USD equivalent to:</p>
                                    <p class="text-white font-mono text-xs bg-black/50 p-2 rounded break-all" id="presaleWalletAddress">Loading...</p>
                                    <p class="text-gray-500 text-xs mt-2">Tokens will be sent after payment confirmation.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Buy Button -->
                        <button 
                            id="buyButton"
                            onclick="executePurchase()"
                            class="w-full bg-primary text-background-dark py-4 rounded-xl font-bold uppercase tracking-widest text-sm gold-glow hover:scale-[1.02] transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 flex items-center justify-center gap-2"
                        >
                            <span class="material-symbols-outlined">shopping_cart</span>
                            <span id="buyButtonText">Buy with POL</span>
                        </button>
                        
                        <p class="text-center text-gray-500 text-xs mt-4">
                            Tokens will be sent to your connected wallet after payment
                        </p>
                    </div>
                    
                    <!-- Processing State -->
                    <div id="processingSection" class="hidden text-center py-12">
                        <div class="w-16 h-16 border-4 border-primary/30 border-t-primary rounded-full animate-spin mx-auto mb-6"></div>
                        <h3 class="text-xl font-serif text-white mb-2">Processing...</h3>
                        <p class="text-gray-400 text-sm" id="processingStatus">Recording your purchase...</p>
                    </div>
                    
                    <!-- Success State -->
                    <div id="successSection" class="hidden text-center py-12">
                        <div class="w-20 h-20 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
                            <span class="material-symbols-outlined text-green-400 text-4xl">check_circle</span>
                        </div>
                        <h3 class="text-2xl font-serif text-white mb-2">Purchase Recorded!</h3>
                        <p class="text-gray-400 mb-6 whitespace-pre-line" id="successMessage">Your VIP tokens will be sent shortly</p>
                        <a id="txLink" href="#" target="_blank" 
                           class="inline-flex items-center gap-2 text-primary hover:underline mb-6 hidden">
                            <span class="material-symbols-outlined text-sm">open_in_new</span>
                            View Transaction
                        </a>
                        <div class="pt-6 space-y-3">
                            <a href="/profile" class="block w-full bg-primary text-background-dark py-3 rounded-xl font-bold uppercase tracking-widest text-sm">
                                View Profile
                            </a>
                            <button onclick="resetPurchase()" class="text-gray-500 hover:text-white transition-colors text-sm">
                                Make Another Purchase
                            </button>
                        </div>
                    </div>
                    
                    <!-- Error State -->
                    <div id="errorSection" class="hidden text-center py-12">
                        <div class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
                            <span class="material-symbols-outlined text-red-400 text-4xl">error</span>
                        </div>
                        <h3 class="text-2xl font-serif text-white mb-2">Something Went Wrong</h3>
                        <p class="text-gray-400 mb-6" id="errorMessage">Purchase could not be processed</p>
                        <button onclick="resetPurchase()" 
                                class="bg-surface border border-white/10 text-white px-6 py-3 rounded-xl hover:border-primary transition-colors">
                            Try Again
                        </button>
                    </div>
                    
                </div>
            </div>
            
            <!-- Purchase History Section -->
            <div class="mt-12">
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xs font-bold uppercase tracking-widest text-primary">Your Purchases</h3>
                        <button onclick="loadPurchaseHistory()" class="text-gray-500 hover:text-primary text-sm flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">refresh</span>
                            Refresh
                        </button>
                    </div>
                    <div id="purchaseHistory" class="text-gray-500 text-sm">
                        <p class="text-center py-4">Connect wallet to view purchase history</p>
                    </div>
                </div>
            </div>
            
            <!-- How It Works -->
            <div class="mt-16">
                <h2 class="text-2xl font-serif text-center text-white mb-8">How It Works</h2>
                <div class="grid md:grid-cols-4 gap-6">
                    <div class="glass-card rounded-xl p-6 text-center">
                        <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-primary font-bold text-xl">1</span>
                        </div>
                        <h3 class="text-white font-semibold mb-2">Connect Wallet</h3>
                        <p class="text-gray-500 text-sm">Connect via your Profile page</p>
                    </div>
                    <div class="glass-card rounded-xl p-6 text-center">
                        <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-primary font-bold text-xl">2</span>
                        </div>
                        <h3 class="text-white font-semibold mb-2">Choose Amount</h3>
                        <p class="text-gray-500 text-sm">Select how many tokens to buy</p>
                    </div>
                    <div class="glass-card rounded-xl p-6 text-center">
                        <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-primary font-bold text-xl">3</span>
                        </div>
                        <h3 class="text-white font-semibold mb-2">Send Crypto</h3>
                        <p class="text-gray-500 text-sm">POL or USDC (USD value)</p>
                    </div>
                    <div class="glass-card rounded-xl p-6 text-center">
                        <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-primary font-bold text-xl">4</span>
                        </div>
                        <h3 class="text-white font-semibold mb-2">Receive Tokens</h3>
                        <p class="text-gray-500 text-sm">Tokens sent to your wallet</p>
                    </div>
                </div>
            </div>
            
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-white/5 py-8 px-6">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <p class="text-gray-500 text-sm">&copy; 2025 Kea Valley. All rights reserved.</p>
            <div class="flex items-center gap-6">
                <a href="https://polygonscan.com/token/0x6860c34db140DB7B589DaDA38859a1d3736bbE3F" target="_blank" 
                   class="text-gray-500 hover:text-primary text-sm transition-colors">
                    Contract
                </a>
                <a href="/profile" class="text-gray-500 hover:text-primary text-sm transition-colors">
                    Profile
                </a>
            </div>
        </div>
    </footer>

    <script>
        // ============================================
        // Configuration
        // ============================================
        const CONFIG = {
            tokenPriceEUR: 1.00,      // Base price in EUR
            eurUsdRate: 1.19,          // EUR to USD conversion rate
            totalTokens: 1000000,
            tokensSold: 0,
            minPurchase: 10,
            maxPurchase: 10000,
            presaleWallet: '',
            
            // Storage keys
            STORAGE_KEYS: [
                'keavalley_profile',
                'walletTwoSession',
                'walletAddress'
            ],
            
            POLYGON_RPC: 'https://polygon-rpc.com',
            USDC_ADDRESS: '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359'
        };
        
        // Computed USD price
        function getTokenPriceUSD() {
            return CONFIG.tokenPriceEUR * CONFIG.eurUsdRate;
        }
        
        // State
        let connectedWallet = null;
        let selectedPayment = 'POL';
        let polPrice = 0.50; // POL price in USD
        let userBalances = { POL: 0, USDC: 0 };
        
        // ============================================
        // Initialize
        // ============================================
        async function init() {
            // Fetch EUR/USD rate
            await fetchEurUsdRate();
            
            // Load presale config
            await loadPresaleConfig();
            
            // Check wallet connection
            checkWalletConnection();
            
            // Update UI
            updatePresaleUI();
            updateTotals();
        }
        
        async function fetchEurUsdRate() {
            try {
                // Try multiple sources for EUR/USD rate
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/EUR');
                if (response.ok) {
                    const data = await response.json();
                    CONFIG.eurUsdRate = data.rates?.USD || 1.08;
                    console.log('EUR/USD rate:', CONFIG.eurUsdRate);
                }
            } catch (e) {
                console.log('Using default EUR/USD rate:', CONFIG.eurUsdRate);
                // Try fallback
                try {
                    const fallback = await fetch('https://open.er-api.com/v6/latest/EUR');
                    if (fallback.ok) {
                        const data = await fallback.json();
                        CONFIG.eurUsdRate = data.rates?.USD || 1.08;
                    }
                } catch (e2) {
                    console.log('Fallback also failed, using default rate');
                }
            }
        }
        
        async function loadPresaleConfig() {
            try {
                const response = await fetch('/api/presale/config');
                if (response.ok) {
                    const data = await response.json();
                    CONFIG.tokenPriceEUR = data.tokenPrice || CONFIG.tokenPriceEUR; // Now in EUR
                    CONFIG.totalTokens = data.totalTokens || CONFIG.totalTokens;
                    CONFIG.tokensSold = data.tokensSold || CONFIG.tokensSold;
                    CONFIG.minPurchase = data.minPurchase || CONFIG.minPurchase;
                    CONFIG.maxPurchase = data.maxPurchase || CONFIG.maxPurchase;
                    CONFIG.presaleWallet = data.presaleWallet || '';
                    polPrice = data.polPrice || polPrice;
                    
                    // Use server EUR/USD rate if provided
                    if (data.eurUsdRate) {
                        CONFIG.eurUsdRate = data.eurUsdRate;
                    }
                    
                    if (CONFIG.presaleWallet) {
                        document.getElementById('presaleWalletAddress').textContent = CONFIG.presaleWallet;
                    }
                }
            } catch (e) {
                console.log('Using default config');
            }
        }
        
        function updatePresaleUI() {
            const progress = CONFIG.totalTokens > 0 ? (CONFIG.tokensSold / CONFIG.totalTokens) * 100 : 0;
            document.getElementById('progressBar').style.width = `${Math.min(progress, 100)}%`;
            document.getElementById('progressPercent').textContent = `${progress.toFixed(1)}%`;
            document.getElementById('tokensSold').textContent = `${CONFIG.tokensSold.toLocaleString()} VIP`;
            document.getElementById('totalTokens').textContent = `${CONFIG.totalTokens.toLocaleString()} VIP`;
            
            // Price display - EUR and USD
            document.getElementById('tokenPriceEUR').textContent = `€${CONFIG.tokenPriceEUR.toFixed(2)}`;
            document.getElementById('tokenPriceUSD').textContent = `$${getTokenPriceUSD().toFixed(2)}`;
            document.getElementById('eurUsdRate').textContent = CONFIG.eurUsdRate.toFixed(4);
            
            document.getElementById('minPurchase').textContent = `${CONFIG.minPurchase.toLocaleString()} VIP`;
            document.getElementById('maxPurchase').textContent = `${CONFIG.maxPurchase.toLocaleString()} VIP`;
        }
        
        // ============================================
        // Wallet Connection
        // ============================================
        function checkWalletConnection() {
            let walletAddress = null;
            
            for (const key of CONFIG.STORAGE_KEYS) {
                const stored = localStorage.getItem(key);
                if (stored) {
                    try {
                        const data = JSON.parse(stored);
                        const address = data.wallet || data.address || data.walletAddress || data.user?.walletAddress;
                        
                        if (address && address.length === 42 && address.startsWith('0x')) {
                            const timestamp = data.timestamp || data.created || 0;
                            if (timestamp && Date.now() - timestamp > 24 * 60 * 60 * 1000) {
                                continue;
                            }
                            walletAddress = address;
                            break;
                        }
                    } catch (e) {
                        if (stored.length === 42 && stored.startsWith('0x')) {
                            walletAddress = stored;
                            break;
                        }
                    }
                }
            }
            
            if (!walletAddress) {
                const sessionWallet = sessionStorage.getItem('walletAddress');
                if (sessionWallet && sessionWallet.length === 42 && sessionWallet.startsWith('0x')) {
                    walletAddress = sessionWallet;
                }
            }
            
            if (walletAddress) {
                setWalletConnected(walletAddress);
            } else {
                showNotConnected();
            }
        }
        
        async function setWalletConnected(address) {
            connectedWallet = address;
            
            document.getElementById('notConnectedOverlay').classList.add('hidden');
            document.getElementById('walletHeader').classList.remove('hidden');
            document.getElementById('purchaseFormSection').classList.remove('hidden');
            
            document.getElementById('walletAddressDisplay').textContent = 
                `${address.slice(0, 6)}...${address.slice(-4)}`;
            
            await fetchUserBalances();
            await loadPurchaseHistory();
            updateTotals();
        }
        
        function showNotConnected() {
            document.getElementById('notConnectedOverlay').classList.remove('hidden');
            document.getElementById('walletHeader').classList.add('hidden');
            document.getElementById('purchaseHistory').innerHTML = 
                '<p class="text-center py-4">Connect wallet to view purchase history</p>';
        }
        
        async function fetchUserBalances() {
            if (!connectedWallet) return;
            
            try {
                try {
                    const polRes = await fetch(`https://api.wallettwo.com/blockchain/balance/137/${connectedWallet}/native`);
                    if (polRes.ok) {
                        const polData = await polRes.json();
                        userBalances.POL = parseFloat(polData.balance || 0);
                    }
                } catch (e) {
                    const provider = new ethers.JsonRpcProvider(CONFIG.POLYGON_RPC);
                    const balance = await provider.getBalance(connectedWallet);
                    userBalances.POL = parseFloat(ethers.formatEther(balance));
                }
                
                try {
                    const usdcRes = await fetch(`https://api.wallettwo.com/blockchain/balance/137/${connectedWallet}/${CONFIG.USDC_ADDRESS}`);
                    if (usdcRes.ok) {
                        const usdcData = await usdcRes.json();
                        userBalances.USDC = parseFloat(usdcData.balance || 0);
                    }
                } catch (e) {
                    userBalances.USDC = 0;
                }
            } catch (e) {
                console.error('Balance fetch error:', e);
            }
            
            updateBalanceDisplay();
        }
        
        function updateBalanceDisplay() {
            if (selectedPayment === 'POL') {
                document.getElementById('userBalance').textContent = `${userBalances.POL.toFixed(4)} POL`;
            } else if (selectedPayment === 'USDC') {
                document.getElementById('userBalance').textContent = `${userBalances.USDC.toFixed(2)} USDC`;
            }
        }
        
        // ============================================
        // Purchase History
        // ============================================
        async function loadPurchaseHistory() {
            if (!connectedWallet) return;
            
            const container = document.getElementById('purchaseHistory');
            container.innerHTML = '<p class="text-center py-4">Loading...</p>';
            
            try {
                const response = await fetch(`/api/presale/purchases/${connectedWallet}`);
                if (!response.ok) throw new Error('Failed to load');
                
                const purchases = await response.json();
                
                if (!purchases || purchases.length === 0) {
                    container.innerHTML = '<p class="text-center py-4 text-gray-500">No purchases yet</p>';
                    return;
                }
                
                const html = purchases.map(p => `
                    <div class="flex items-center justify-between py-4 border-b border-white/5 last:border-0">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center ${getPaymentBgClass(p.payment_method)}">
                                <span class="text-white font-bold text-xs">${p.payment_method}</span>
                            </div>
                            <div>
                                <p class="text-white font-medium">${parseInt(p.token_amount).toLocaleString()} VIP</p>
                                <p class="text-gray-500 text-xs">${new Date(p.created_at).toLocaleDateString()} • ${p.payment_method}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-white">€${parseFloat(p.eur_amount || p.usd_amount / CONFIG.eurUsdRate).toFixed(2)}</p>
                            <p class="text-gray-500 text-xs">$${parseFloat(p.usd_amount).toFixed(2)}</p>
                            <span class="text-xs px-2 py-1 rounded-full ${getStatusClass(p.status)}">${formatStatus(p.status)}</span>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = html;
                
            } catch (e) {
                console.error('Error loading purchases:', e);
                container.innerHTML = '<p class="text-center py-4 text-red-400">Error loading purchases</p>';
            }
        }
        
        function getPaymentBgClass(method) {
            const classes = {
                'POL': 'bg-purple-600',
                'USDC': 'bg-blue-500'
            };
            return classes[method] || 'bg-gray-600';
        }
        
        function getStatusClass(status) {
            const classes = {
                'pending': 'bg-yellow-500/20 text-yellow-400',
                'pending_payment': 'bg-yellow-500/20 text-yellow-400',
                'paid': 'bg-blue-500/20 text-blue-400',
                'paid_pending_mint': 'bg-blue-500/20 text-blue-400',
                'minted': 'bg-green-500/20 text-green-400',
                'completed': 'bg-green-500/20 text-green-400',
                'failed': 'bg-red-500/20 text-red-400',
                'expired': 'bg-gray-500/20 text-gray-400'
            };
            return classes[status] || 'bg-gray-500/20 text-gray-400';
        }
        
        function formatStatus(status) {
            const labels = {
                'pending': 'Pending',
                'pending_payment': 'Awaiting Payment',
                'paid': 'Paid',
                'paid_pending_mint': 'Processing',
                'minted': 'Completed',
                'completed': 'Completed',
                'failed': 'Failed',
                'expired': 'Expired'
            };
            return labels[status] || status;
        }
        
        // ============================================
        // Amount & Payment Selection
        // ============================================
        function setAmount(amount) {
            document.getElementById('tokenAmount').value = amount;
            updateTotals();
        }
        
        function setMax() {
            document.getElementById('tokenAmount').value = CONFIG.maxPurchase;
            updateTotals();
        }
        
        function selectPayment(method) {
            if (method === 'card') return;
            
            selectedPayment = method;
            
            ['POL', 'USDC'].forEach(m => {
                const el = document.getElementById(`pay${m}`);
                const radio = document.getElementById(`${m.toLowerCase()}Radio`);
                
                if (m === method) {
                    el.classList.add('selected');
                    radio.innerHTML = '<div class="w-3 h-3 rounded-full bg-primary"></div>';
                    radio.classList.remove('border-gray-600');
                    radio.classList.add('border-primary');
                } else {
                    el.classList.remove('selected');
                    radio.innerHTML = '';
                    radio.classList.add('border-gray-600');
                    radio.classList.remove('border-primary');
                }
            });
            
            document.getElementById('buyButtonText').textContent = `Buy with ${method}`;
            updateBalanceDisplay();
            updateTotals();
        }
        
        function updateTotals() {
            const amount = parseInt(document.getElementById('tokenAmount').value) || 0;
            const totalEUR = amount * CONFIG.tokenPriceEUR;
            const totalUSD = totalEUR * CONFIG.eurUsdRate;
            
            // Display prices
            document.getElementById('displayPriceEUR').textContent = `€${CONFIG.tokenPriceEUR.toFixed(2)}`;
            document.getElementById('displayPriceUSD').textContent = `$${getTokenPriceUSD().toFixed(2)}`;
            document.getElementById('displayQuantity').textContent = `${amount.toLocaleString()} VIP`;
            document.getElementById('displayTotalEUR').textContent = `€${totalEUR.toFixed(2)}`;
            document.getElementById('displayTotalUSD').textContent = `≈ $${totalUSD.toFixed(2)} USD`;
            
            // Update crypto equivalents (in USD value)
            const totalPOL = polPrice > 0 ? totalUSD / polPrice : 0;
            document.getElementById('polEquivalent').textContent = `≈ ${totalPOL.toFixed(4)} POL ($${totalUSD.toFixed(2)})`;
            document.getElementById('usdcEquivalent').textContent = `≈ ${totalUSD.toFixed(2)} USDC`;
        }
        
        // ============================================
        // Purchase Execution
        // ============================================
        async function executePurchase() {
            const amount = parseInt(document.getElementById('tokenAmount').value) || 0;
            
            if (amount < CONFIG.minPurchase) {
                alert(`Minimum purchase is ${CONFIG.minPurchase} VIP tokens`);
                return;
            }
            
            if (amount > CONFIG.maxPurchase) {
                alert(`Maximum purchase is ${CONFIG.maxPurchase} VIP tokens`);
                return;
            }
            
            if (!connectedWallet) {
                alert('Please connect your wallet from your Profile first');
                return;
            }
            
            const totalEUR = amount * CONFIG.tokenPriceEUR;
            const totalUSD = totalEUR * CONFIG.eurUsdRate;
            
            await payWithCrypto(amount, selectedPayment, totalEUR, totalUSD);
        }
        
        async function payWithCrypto(tokenAmount, method, totalEUR, totalUSD) {
            const totalPOL = polPrice > 0 ? totalUSD / polPrice : 0;
            
            // Check balance
            if (method === 'POL' && userBalances.POL < totalPOL) {
                alert(`Insufficient POL balance. You have ${userBalances.POL.toFixed(4)} POL but need ${totalPOL.toFixed(4)} POL`);
                return;
            }
            if (method === 'USDC' && userBalances.USDC < totalUSD) {
                alert(`Insufficient USDC balance. You have ${userBalances.USDC.toFixed(2)} USDC but need ${totalUSD.toFixed(2)} USDC`);
                return;
            }
            
            showProcessing('Recording purchase...');
            
            try {
                const response = await fetch('/api/presale/purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        wallet_address: connectedWallet,
                        token_amount: tokenAmount,
                        payment_method: method,
                        payment_amount: method === 'POL' ? totalPOL : totalUSD,
                        eur_amount: totalEUR,
                        usd_amount: totalUSD,
                        eur_usd_rate: CONFIG.eurUsdRate
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const paymentAmount = method === 'POL' ? `${totalPOL.toFixed(4)} POL` : `${totalUSD.toFixed(2)} USDC`;
                    const walletDisplay = CONFIG.presaleWallet ? 
                        `\n\nSend to:\n${CONFIG.presaleWallet}` : '';
                    showSuccess(`Purchase recorded!\n\nTotal: €${totalEUR.toFixed(2)} (≈ $${totalUSD.toFixed(2)})\n\nPlease send ${paymentAmount} to complete your order.${walletDisplay}\n\nTokens will be sent after payment confirmation.`);
                    await loadPurchaseHistory();
                } else {
                    showError(data.error || 'Purchase failed');
                }
                
            } catch (error) {
                showError(error.message || 'Network error');
            }
        }
        
        // ============================================
        // UI State Management
        // ============================================
        function showProcessing(message) {
            document.getElementById('walletHeader').classList.add('hidden');
            document.getElementById('purchaseFormSection').classList.add('hidden');
            document.getElementById('processingSection').classList.remove('hidden');
            document.getElementById('successSection').classList.add('hidden');
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('processingStatus').textContent = message;
        }
        
        function showSuccess(message) {
            document.getElementById('walletHeader').classList.add('hidden');
            document.getElementById('purchaseFormSection').classList.add('hidden');
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('successSection').classList.remove('hidden');
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('successMessage').textContent = message;
        }
        
        function showError(message) {
            document.getElementById('walletHeader').classList.add('hidden');
            document.getElementById('purchaseFormSection').classList.add('hidden');
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('successSection').classList.add('hidden');
            document.getElementById('errorSection').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }
        
        function resetPurchase() {
            document.getElementById('tokenAmount').value = '';
            
            if (connectedWallet) {
                document.getElementById('walletHeader').classList.remove('hidden');
                document.getElementById('purchaseFormSection').classList.remove('hidden');
            }
            
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('successSection').classList.add('hidden');
            document.getElementById('errorSection').classList.add('hidden');
            
            updateTotals();
        }
        
        // Initialize
        init();
    </script>
</body>
</html>
