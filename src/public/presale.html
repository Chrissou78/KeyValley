<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>VIP Token Presale | Kea Valley</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ee9d2b",
                        "primary-light": "#fbdea6",
                        "background-dark": "#0a0a0a",
                        "surface": "#121212",
                    },
                    fontFamily: {
                        "sans": ["Manrope", "sans-serif"],
                        "serif": ["Playfair Display", "serif"],
                    },
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Manrope', sans-serif; }
        h1, h2, h3, h4, .font-serif { font-family: 'Playfair Display', serif; }
        .gold-glow:hover {
            box-shadow: 0 0 25px rgba(238, 157, 43, 0.3);
            border-color: #ee9d2b;
        }
        .glass-nav {
            backdrop-filter: blur(12px);
            background-color: rgba(10, 10, 10, 0.7);
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #ee9d2b; }
        
        /* Status pulse animation */
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        .pulse-dot {
            animation: pulse-dot 2s infinite;
        }
        
        /* Progress bar animation */
        .progress-bar-fill {
            background: linear-gradient(90deg, #ee9d2b, #fbdea6);
            transition: width 0.5s ease;
        }
        
        /* Payment option selected state */
        .payment-option.selected {
            border-color: #ee9d2b;
            background: rgba(238, 157, 43, 0.1);
        }
        
        /* Quick amount buttons */
        .quick-btn:hover {
            background: rgba(238, 157, 43, 0.2);
            border-color: #ee9d2b;
        }
        
        /* Overlay styles */
        .overlay-backdrop {
            background: rgba(10, 10, 10, 0.95);
        }
        
        /* Spinner */
        .spinner {
            border: 3px solid rgba(238, 157, 43, 0.2);
            border-top-color: #ee9d2b;
        }
    </style>
</head>
<body class="bg-background-dark text-white selection:bg-primary selection:text-background-dark antialiased min-h-screen flex flex-col">

    <!-- Header -->
    <header class="fixed top-0 w-full z-50 glass-nav border-b border-white/5">
        <div class="max-w-7xl mx-auto px-6 lg:px-12 flex items-center justify-between h-20 lg:h-24">
            <a href="/" class="flex items-center gap-4 group cursor-pointer">
                <div class="size-10 text-primary transition-transform duration-500 group-hover:rotate-180">
                    <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M44 4H30.6666V17.3334H17.3334V30.6666H4V44H44V4Z" fill="currentColor"></path>
                    </svg>
                </div>
                <div>
                    <h2 class="text-xl font-serif font-bold tracking-widest uppercase text-white">Kea Valley</h2>
                    <p class="text-[0.6rem] text-primary uppercase tracking-[0.3em] font-sans">Estates</p>
                </div>
            </a>
            <nav class="hidden md:flex items-center gap-8 lg:gap-12">
                <a class="text-xs font-bold tracking-widest hover:text-primary transition-colors uppercase" href="/">Home</a>
                <a class="text-xs font-bold tracking-widest hover:text-primary transition-colors uppercase" href="/profile">Profile</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 pt-32 pb-20 px-6">
        <div class="max-w-lg mx-auto w-full">
            
            <!-- Page Title -->
            <div class="text-center mb-12">
                <div class="flex items-center justify-center gap-4 mb-6">
                    <div class="h-[1px] w-8 bg-primary"></div>
                    <span class="text-primary tracking-[0.3em] uppercase text-xs font-bold">Exclusive Offer</span>
                    <div class="h-[1px] w-8 bg-primary"></div>
                </div>
                <h1 class="text-4xl md:text-5xl font-serif italic font-medium text-white mb-4">VIP Token Presale</h1>
                <p class="text-slate-400 font-light mb-6">Get VIP tokens at the best price before public launch.</p>
                
                <!-- Status Badge -->
                <div id="statusBadge" class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-green-500/30 bg-green-500/10">
                    <span id="statusDot" class="w-2 h-2 rounded-full bg-green-500 pulse-dot"></span>
                    <span id="statusText" class="text-xs font-bold uppercase tracking-widest text-green-400">Presale Live</span>
                </div>
            </div>

            <!-- Progress Card -->
            <div class="bg-surface border border-white/5 rounded-sm p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-xs font-bold uppercase tracking-widest text-slate-500">Progress</span>
                    <span id="progressPercent" class="text-sm font-bold text-primary">0%</span>
                </div>
                <div class="h-3 bg-background-dark rounded-full overflow-hidden mb-4">
                    <div id="progressBar" class="h-full progress-bar-fill rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-xs text-slate-500">
                    <span><span id="tokensSold" class="text-white">0</span> VIP sold</span>
                    <span><span id="totalTokens" class="text-white">1,000,000</span> VIP total</span>
                </div>
            </div>

            <!-- Wallet Header (shown when connected) -->
            <div id="walletHeader" class="hidden bg-surface border border-primary/20 rounded-sm p-4 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="size-10 rounded-full bg-primary/20 border border-primary/30 flex items-center justify-center">
                            <span class="material-symbols-outlined text-primary">account_balance_wallet</span>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 uppercase tracking-widest">Connected</p>
                            <p id="walletAddressDisplay" class="text-sm font-mono text-primary">0x...</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <a href="/profile" class="text-xs font-bold uppercase tracking-widest text-slate-400 hover:text-primary transition-colors">Profile</a>
                        <button onclick="disconnectWallet()" class="text-xs font-bold uppercase tracking-widest text-red-400 hover:text-red-300 transition-colors ml-4">Disconnect</button>
                    </div>
                </div>
            </div>

            <!-- Purchase Card -->
            <div class="bg-surface border border-white/5 rounded-sm overflow-hidden relative">
                <div class="px-8 py-5 border-b border-white/5 flex items-center justify-between">
                    <h3 class="text-xs font-bold uppercase tracking-widest text-primary">Purchase Tokens</h3>
                    <span class="material-symbols-outlined text-primary/50">shopping_cart</span>
                </div>
                
                <div class="p-6 relative">
                    
                    <!-- Not Connected Overlay -->
                    <div id="notConnectedOverlay" class="absolute inset-0 overlay-backdrop flex flex-col items-center justify-center z-10 p-8 text-center">
                        <span class="material-symbols-outlined text-6xl text-primary/50 mb-4">link</span>
                        <h3 class="text-lg font-serif text-white mb-2">Connect Wallet</h3>
                        <p class="text-slate-400 text-sm mb-6">Connect your WalletTwo to participate in the presale</p>
                        <button onclick="connectWallet()" class="bg-primary text-background-dark px-8 py-4 rounded-sm font-bold uppercase tracking-widest text-xs gold-glow hover:translate-y-[-2px] transition-all">
                            Connect WalletTwo
                        </button>
                    </div>

                    <!-- Presale Inactive Overlay -->
                    <div id="presaleInactiveOverlay" class="hidden absolute inset-0 overlay-backdrop flex flex-col items-center justify-center z-10 p-8 text-center">
                        <span class="material-symbols-outlined text-6xl text-red-400/50 mb-4">pause_circle</span>
                        <h3 class="text-lg font-serif text-white mb-2">Presale Not Active</h3>
                        <p class="text-slate-400 text-sm">The presale is currently paused. Please check back later.</p>
                    </div>

                    <!-- Price Display -->
                    <div class="text-center mb-8 pb-6 border-b border-white/5">
                        <p class="text-xs text-slate-500 uppercase tracking-widest mb-2">Token Price</p>
                        <p class="text-4xl font-serif text-primary mb-1">
                            ‚Ç¨<span id="tokenPriceDisplay">1.00</span>
                        </p>
                        <p id="tokenPriceUSD" class="text-sm text-slate-500">‚âà $1.19 USD</p>
                    </div>

                    <!-- Token Amount Input -->
                    <div class="mb-6">
                        <label class="text-xs font-bold uppercase tracking-widest text-slate-500 mb-3 block">Amount to Purchase</label>
                        <div class="flex items-center bg-background-dark border border-white/10 rounded-sm overflow-hidden focus-within:border-primary/50 transition-colors">
                            <input 
                                type="number" 
                                id="tokenAmount" 
                                class="flex-1 bg-transparent border-none px-4 py-4 text-xl text-white focus:outline-none focus:ring-0" 
                                placeholder="0"
                                min="10"
                                max="10000"
                                oninput="updateTotals()"
                            >
                            <span class="px-4 py-4 text-primary font-bold text-sm border-l border-white/10 bg-white/5">VIP</span>
                        </div>
                    </div>

                    <!-- Quick Amount Buttons -->
                    <div class="grid grid-cols-5 gap-2 mb-6">
                        <button class="quick-btn py-3 text-xs font-bold text-slate-400 border border-white/10 rounded-sm hover:text-primary transition-all" onclick="setAmount(100)">100</button>
                        <button class="quick-btn py-3 text-xs font-bold text-slate-400 border border-white/10 rounded-sm hover:text-primary transition-all" onclick="setAmount(500)">500</button>
                        <button class="quick-btn py-3 text-xs font-bold text-slate-400 border border-white/10 rounded-sm hover:text-primary transition-all" onclick="setAmount(1000)">1K</button>
                        <button class="quick-btn py-3 text-xs font-bold text-slate-400 border border-white/10 rounded-sm hover:text-primary transition-all" onclick="setAmount(5000)">5K</button>
                        <button class="quick-btn py-3 text-xs font-bold text-slate-400 border border-white/10 rounded-sm hover:text-primary transition-all" onclick="setAmount(CONFIG.maxPurchase)">MAX</button>
                    </div>

                    <!-- Limits Info -->
                    <div class="flex justify-between text-xs text-slate-500 mb-6">
                        <span>Min: <span id="minPurchase" class="text-slate-300">10</span> VIP</span>
                        <span>Max: <span id="maxPurchase" class="text-slate-300">10,000</span> VIP</span>
                    </div>

                    <!-- Payment Methods -->
                    <div class="mb-6">
                        <label class="text-xs font-bold uppercase tracking-widest text-slate-500 mb-3 block">Payment Method</label>
                        <div class="grid grid-cols-3 gap-3">
                            <button id="paymentPOL" class="payment-option selected flex flex-col items-center py-4 border border-white/10 rounded-sm hover:border-primary/50 transition-all" onclick="selectPayment('POL')">
                                <span class="text-2xl mb-1">üíú</span>
                                <span class="text-xs font-bold text-white">POL</span>
                            </button>
                            <button id="paymentUSDC" class="payment-option flex flex-col items-center py-4 border border-white/10 rounded-sm hover:border-primary/50 transition-all" onclick="selectPayment('USDC')">
                                <span class="text-2xl mb-1">üíµ</span>
                                <span class="text-xs font-bold text-white">USDC</span>
                            </button>
                            <button class="payment-option flex flex-col items-center py-4 border border-white/10 rounded-sm opacity-40 cursor-not-allowed" disabled>
                                <span class="text-2xl mb-1">üí≥</span>
                                <span class="text-xs font-bold text-white">Card</span>
                                <span class="text-[10px] text-slate-500">Soon</span>
                            </button>
                        </div>
                    </div>

                    <!-- Balance Display -->
                    <div id="balanceDisplay" class="flex justify-between items-center bg-background-dark border border-white/5 rounded-sm p-4 mb-6">
                        <span class="text-xs text-slate-500 uppercase tracking-widest">Your Balance</span>
                        <span id="balanceValue" class="text-sm font-bold text-primary">-- POL</span>
                    </div>

                    <!-- Total Section -->
                    <div class="bg-background-dark border border-white/5 rounded-sm p-4 mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-slate-500">Tokens</span>
                            <span id="totalTokensDisplay" class="text-sm text-white">0 VIP</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-slate-500">Price (EUR)</span>
                            <span id="totalEUR" class="text-sm text-white">‚Ç¨0.00</span>
                        </div>
                        <div class="flex justify-between items-center pb-3 mb-3 border-b border-white/5">
                            <span class="text-xs text-slate-500">Total (USD)</span>
                            <span id="totalUSD" class="text-sm text-white">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-slate-500">You Pay</span>
                            <span id="cryptoEquivalent" class="text-lg font-bold text-primary">‚âà 0 POL</span>
                        </div>
                    </div>

                    <!-- Buy Button -->
                    <button id="buyButton" onclick="executePurchase()" disabled class="w-full bg-primary text-background-dark px-8 py-5 rounded-sm font-bold uppercase tracking-widest text-sm gold-glow hover:translate-y-[-2px] transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none">
                        Enter Amount
                    </button>

                </div>
            </div>

            <!-- Purchase History -->
            <div id="historyCard" class="hidden bg-surface border border-white/5 rounded-sm overflow-hidden mt-6">
                <div class="px-8 py-5 border-b border-white/5 flex items-center justify-between">
                    <h3 class="text-xs font-bold uppercase tracking-widest text-primary">Your Purchases</h3>
                    <span class="material-symbols-outlined text-primary/50">history</span>
                </div>
                <div id="historyList" class="p-6">
                    <p class="text-slate-500 text-sm text-center py-4">No purchases yet</p>
                </div>
            </div>

            <!-- Token Info -->
            <div class="text-center mt-8 text-xs text-slate-500">
                <p class="mb-2">VIP Token on Polygon Network</p>
                <a href="https://polygonscan.com/token/0x6860c34db140DB7B589DaDA38859a1d3736bbE3F" target="_blank" class="inline-flex items-center gap-1 text-primary hover:underline">
                    View Contract <span class="material-symbols-outlined text-sm">open_in_new</span>
                </a>
            </div>

        </div>
    </main>

    <!-- Processing Overlay -->
    <div id="processingOverlay" class="hidden fixed inset-0 bg-background-dark/98 flex flex-col items-center justify-center z-50 p-8">
        <div class="spinner w-16 h-16 rounded-full animate-spin mb-6"></div>
        <h3 id="processingTitle" class="text-xl font-serif text-white mb-2">Processing Purchase</h3>
        <p id="processingText" class="text-slate-400 text-sm mb-6 text-center max-w-xs">Please confirm the transaction in WalletTwo</p>
        <div id="processingStep" class="px-4 py-2 bg-primary/10 border border-primary/30 rounded-full text-xs font-bold text-primary uppercase tracking-widest">
            Step 1: Payment
        </div>
    </div>

    <!-- Result Overlay -->
    <div id="resultOverlay" class="hidden fixed inset-0 bg-background-dark/98 flex flex-col items-center justify-center z-50 p-8">
        <span id="resultIcon" class="material-symbols-outlined text-7xl mb-6 text-primary">check_circle</span>
        <h3 id="resultTitle" class="text-2xl font-serif text-white mb-2">Purchase Complete!</h3>
        <p id="resultMessage" class="text-slate-400 text-sm mb-8 text-center max-w-xs">Your VIP tokens have been sent to your wallet.</p>
        
        <div id="resultDetails" class="w-full max-w-xs bg-surface border border-white/5 rounded-sm p-4 mb-8">
            <div class="flex justify-between items-center mb-3">
                <span class="text-xs text-slate-500">Tokens</span>
                <span id="resultTokens" class="text-sm font-bold text-white">0 VIP</span>
            </div>
            <div class="flex justify-between items-center mb-3">
                <span class="text-xs text-slate-500">Payment TX</span>
                <a id="resultPaymentTx" href="#" target="_blank" class="text-xs font-mono text-primary hover:underline">View ‚Üó</a>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-xs text-slate-500">Mint TX</span>
                <a id="resultMintTx" href="#" target="_blank" class="text-xs font-mono text-primary hover:underline">View ‚Üó</a>
            </div>
        </div>
        
        <button onclick="closeResult()" class="bg-primary text-background-dark px-8 py-4 rounded-sm font-bold uppercase tracking-widest text-xs gold-glow hover:translate-y-[-2px] transition-all mb-3">
            Done
        </button>
        <button onclick="viewInWallet()" class="text-slate-400 text-xs font-bold uppercase tracking-widest hover:text-primary transition-colors">
            View in Wallet
        </button>
    </div>

    <!-- Footer -->
    <footer class="bg-background-dark py-8 border-t border-white/5">
        <div class="max-w-7xl mx-auto px-6 lg:px-12">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <a href="/" class="flex items-center gap-2">
                    <div class="size-6 text-primary">
                        <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M44 4H30.6666V17.3334H17.3334V30.6666H4V44H44V4Z" fill="currentColor"></path>
                        </svg>
                    </div>
                    <span class="text-xs font-serif font-bold tracking-widest uppercase text-white">Kea Valley</span>
                </a>
                <div class="text-slate-600 text-xs font-light">
                    ¬© 2025 Kea Valley
                </div>
            </div>
        </div>
    </footer>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            tokenAddress: '0x6860c34db140DB7B589DaDA38859a1d3736bbE3F',
            tokenSymbol: 'VIP',
            tokenDecimals: 18,
            
            tokenPriceEUR: 1.00,
            eurUsdRate: 1.19,
            polPrice: 0.12,
            
            totalTokens: 1000000,
            tokensSold: 0,
            minPurchase: 10,
            maxPurchase: 10000,
            presaleEnabled: true,
            presaleWallet: '',
            
            chainId: 137,
            rpcUrl: 'https://polygon-rpc.com',
            explorerUrl: 'https://polygonscan.com',
            
            usdcAddress: '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359',
            usdcDecimals: 6,
            
            walletTwoOrigin: 'https://wallet.wallettwo.com',
            companyId: '6a27c2f8-894c-46c7-bf9f-f5af11d4e092',
            storageKey: 'keavalley_profile'
        };

        // ============================================
        // Referral Handling
        // ============================================
        let referrerCode = null;
        let referrerWallet = null;

        function checkReferralCode() {
            const params = new URLSearchParams(window.location.search);
            const ref = params.get('ref') || params.get('referrer') || params.get('r');
            
            if (ref) {
                validateReferralCode(ref);
            }
        }

        async function validateReferralCode(code) {
            try {
                const response = await fetch(`/api/referral/validate/${code}`);
                const data = await response.json();
                
                if (data.valid) {
                    referrerCode = code;
                    referrerWallet = data.referrerWallet;
                    showReferralBadge(code);
                }
            } catch (error) {
                console.error('Failed to validate referral code:', error);
            }
        }

        function showReferralBadge(code) {
            const badge = document.createElement('div');
            badge.className = 'fixed top-24 right-4 bg-green-500/20 border border-green-500/30 rounded-full px-4 py-2 text-xs text-green-400 font-bold z-40';
            badge.innerHTML = `üéÅ Referral Active: ${code}`;
            document.body.appendChild(badge);
        }

        // ============================================
        // STATE
        // ============================================
        let currentWallet = null;
        let selectedPayment = 'POL';
        let userBalances = { POL: 0, USDC: 0 };
        let pendingPurchase = null;

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            await loadPresaleConfig();
            checkExistingSession();
            handleUrlParams();
            setupMessageListener();
        });

        async function loadPresaleConfig() {
            try {
                const response = await fetch('/api/presale/config');
                const data = await response.json();
                
                console.log('Presale config:', data);
                
                if (data.success !== false) {
                    CONFIG.tokenPriceEUR = data.tokenPrice || CONFIG.tokenPriceEUR;
                    CONFIG.eurUsdRate = data.eurUsdRate || CONFIG.eurUsdRate;
                    CONFIG.polPrice = data.polPrice || CONFIG.polPrice;
                    CONFIG.totalTokens = data.totalTokens || CONFIG.totalTokens;
                    CONFIG.tokensSold = data.tokensSold || 0;
                    CONFIG.minPurchase = data.minPurchase || CONFIG.minPurchase;
                    CONFIG.maxPurchase = data.maxPurchase || CONFIG.maxPurchase;
                    CONFIG.presaleEnabled = data.enabled === true;
                    CONFIG.presaleWallet = data.presaleWallet || '';
                }
                
                updateUI();
                updatePresaleStatus(CONFIG.presaleEnabled);
            } catch (error) {
                console.error('Failed to load presale config:', error);
                updatePresaleStatus(false);
            }
        }

        function updatePresaleStatus(enabled) {
            const statusBadge = document.getElementById('statusBadge');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const inactiveOverlay = document.getElementById('presaleInactiveOverlay');
            const notConnectedOverlay = document.getElementById('notConnectedOverlay');
            
            if (enabled) {
                // GREEN when active
                statusBadge.className = 'inline-flex items-center gap-2 px-4 py-2 rounded-full border border-green-500/30 bg-green-500/10';
                statusDot.className = 'w-2 h-2 rounded-full bg-green-500 pulse-dot';
                statusText.className = 'text-xs font-bold uppercase tracking-widest text-green-400';
                statusText.textContent = 'Presale Live';
                
                if (currentWallet) {
                    inactiveOverlay.classList.add('hidden');
                }
            } else {
                // RED when inactive
                statusBadge.className = 'inline-flex items-center gap-2 px-4 py-2 rounded-full border border-red-500/30 bg-red-500/10';
                statusDot.className = 'w-2 h-2 rounded-full bg-red-500';
                statusText.className = 'text-xs font-bold uppercase tracking-widest text-red-400';
                statusText.textContent = 'Presale Not Active';
                
                if (currentWallet) {
                    notConnectedOverlay.classList.add('hidden');
                    inactiveOverlay.classList.remove('hidden');
                }
            }
        }
        function updateUI() {
            document.getElementById('tokenPriceDisplay').textContent = CONFIG.tokenPriceEUR.toFixed(2);
            document.getElementById('tokenPriceUSD').textContent = `‚âà $${(CONFIG.tokenPriceEUR * CONFIG.eurUsdRate).toFixed(2)} USD`;
            
            document.getElementById('minPurchase').textContent = CONFIG.minPurchase.toLocaleString();
            document.getElementById('maxPurchase').textContent = CONFIG.maxPurchase.toLocaleString();
            
            const percent = CONFIG.totalTokens > 0 ? (CONFIG.tokensSold / CONFIG.totalTokens * 100) : 0;
            document.getElementById('progressPercent').textContent = `${percent.toFixed(1)}%`;
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('tokensSold').textContent = CONFIG.tokensSold.toLocaleString();
            document.getElementById('totalTokens').textContent = CONFIG.totalTokens.toLocaleString();
            
            const tokenInput = document.getElementById('tokenAmount');
            tokenInput.min = CONFIG.minPurchase;
            tokenInput.max = CONFIG.maxPurchase;
        }

        // ============================================
        // WALLET CONNECTION
        // ============================================
        function checkExistingSession() {
            const session = localStorage.getItem(CONFIG.storageKey);
            console.log('üîç Presale - checking session, storageKey:', CONFIG.storageKey);
            console.log('üîç Presale - raw session:', session);
            
            if (session) {
                try {
                    const data = JSON.parse(session);
                    console.log('üîç Presale - parsed data:', data);
                    
                    const sessionAge = Date.now() - (data.timestamp || 0);
                    const maxAge = 24 * 60 * 60 * 1000;
                    
                    const wallet = data.wallet || data.wlt || data.address;
                    console.log('üîç Presale - wallet found:', wallet, '| age:', sessionAge, '| maxAge:', maxAge);
                    
                    if (sessionAge < maxAge && wallet) {
                        console.log('‚úÖ Presale - using existing session');
                        setWalletConnected(wallet);
                    } else {
                        console.log('‚ö†Ô∏è Presale - session expired or no wallet');
                        localStorage.removeItem(CONFIG.storageKey);
                    }
                } catch (e) {
                    console.error('‚ùå Presale - parse error:', e);
                    localStorage.removeItem(CONFIG.storageKey);
                }
            } else {
                console.log('‚ö†Ô∏è Presale - no session in localStorage');
            }
        }

        function connectWallet() {
            const loginUrl = `${CONFIG.walletTwoOrigin}/auth/login?action=auth&companyId=${CONFIG.companyId}&redirect_uri=${encodeURIComponent(window.location.href)}`;
            window.location.href = loginUrl;
        }

        function disconnectWallet() {
            currentWallet = null;
            localStorage.removeItem(CONFIG.storageKey);
            localStorage.removeItem('walletTwoSession');
            localStorage.removeItem('walletAddress');
            
            document.getElementById('walletHeader').classList.add('hidden');
            document.getElementById('notConnectedOverlay').classList.remove('hidden');
            document.getElementById('presaleInactiveOverlay').classList.add('hidden');
            document.getElementById('historyCard').classList.add('hidden');
        }

        function setWalletConnected(address) {
            currentWallet = address;
            
            document.getElementById('walletHeader').classList.remove('hidden');
            document.getElementById('walletAddressDisplay').textContent = shortenAddress(address);
            document.getElementById('notConnectedOverlay').classList.add('hidden');
            
            if (!CONFIG.presaleEnabled) {
                document.getElementById('presaleInactiveOverlay').classList.remove('hidden');
            } else {
                document.getElementById('presaleInactiveOverlay').classList.add('hidden');
            }
            
            loadUserBalances(address);
            loadPurchaseHistory(address);
            
            document.getElementById('historyCard').classList.remove('hidden');
        }

        function shortenAddress(address) {
            return `${address.slice(0, 6)}...${address.slice(-4)}`;
        }

        // ============================================
        // URL PARAMS & MESSAGE HANDLING
        // ============================================
        function handleUrlParams() {
            const params = new URLSearchParams(window.location.search);
            
            const wallet = params.get('wlt') || params.get('wallet') || params.get('address');
            if (wallet) {
                saveSession({ wallet });
                setWalletConnected(wallet);
            }
            
            const purchaseComplete = params.get('purchase');
            const txHash = params.get('txhash');
            const success = params.get('success');
            
            if (purchaseComplete === 'complete' && txHash) {
                handlePurchaseCallback(txHash, success === 'true');
            }
            
            if (wallet || purchaseComplete) {
                window.history.replaceState({}, '', window.location.pathname);
            }
        }

        function setupMessageListener() {
            window.addEventListener('message', (event) => {
                if (event.origin !== CONFIG.walletTwoOrigin) return;
                
                const data = event.data;
                console.log('WalletTwo message:', data);
                
                if (data.type === 'wallet_login' || data.wallet || data.wlt) {
                    const wallet = data.wallet || data.wlt || data.address;
                    if (wallet) {
                        saveSession({ wallet, ...data });
                        setWalletConnected(wallet);
                    }
                }
                
                if (data.type === 'transaction_complete' || data.txhash) {
                    handlePurchaseCallback(data.txhash, data.success !== false);
                }
            });
        }

        function saveSession(data) {
            const session = {
                wallet: data.wallet || data.wlt,
                email: data.email,
                name: data.name,
                userId: data.usr || data.userId,
                timestamp: Date.now()
            };
            localStorage.setItem(CONFIG.storageKey, JSON.stringify(session));
            if (session.wallet) {
                localStorage.setItem('walletAddress', session.wallet);
            }
        }

        // ============================================
        // BALANCES
        // ============================================
        async function loadUserBalances(address) {
            try {
                const [polBalance, usdcBalance] = await Promise.all([
                    fetchBalance(address, 'native'),
                    fetchBalance(address, CONFIG.usdcAddress)
                ]);
                
                userBalances.POL = polBalance;
                userBalances.USDC = usdcBalance;
                
                updateBalanceDisplay();
            } catch (error) {
                console.error('Failed to load balances:', error);
            }
        }

        async function fetchBalance(address, token) {
            try {
                const tokenAddr = token === 'native' ? '0x0000000000000000000000000000000000000000' : token;
                const response = await fetch(`https://api.wallettwo.com/blockchain/balance/137/${address}/${tokenAddr}`);
                const data = await response.json();
                return parseFloat(data.balance || 0);
            } catch (e) {
                return await fetchBalanceRPC(address, token);
            }
        }

        async function fetchBalanceRPC(address, token) {
            try {
                if (token === 'native') {
                    const response = await fetch(CONFIG.rpcUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            jsonrpc: '2.0',
                            method: 'eth_getBalance',
                            params: [address, 'latest'],
                            id: 1
                        })
                    });
                    const data = await response.json();
                    return parseInt(data.result, 16) / 1e18;
                } else {
                    const balanceOfData = '0x70a08231000000000000000000000000' + address.slice(2);
                    const response = await fetch(CONFIG.rpcUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            jsonrpc: '2.0',
                            method: 'eth_call',
                            params: [{ to: token, data: balanceOfData }, 'latest'],
                            id: 1
                        })
                    });
                    const data = await response.json();
                    const decimals = token === CONFIG.usdcAddress ? 6 : 18;
                    return parseInt(data.result, 16) / Math.pow(10, decimals);
                }
            } catch (e) {
                return 0;
            }
        }

        function updateBalanceDisplay() {
            const balanceValue = document.getElementById('balanceValue');
            const balance = selectedPayment === 'POL' ? userBalances.POL : userBalances.USDC;
            const symbol = selectedPayment;
            
            balanceValue.textContent = `${balance.toFixed(4)} ${symbol}`;
            
            const tokenAmount = parseInt(document.getElementById('tokenAmount').value) || 0;
            const totalUSD = tokenAmount * CONFIG.tokenPriceEUR * CONFIG.eurUsdRate;
            const required = selectedPayment === 'POL' ? totalUSD / CONFIG.polPrice : totalUSD;
            
            if (balance < required && tokenAmount > 0) {
                balanceValue.classList.add('text-red-400');
                balanceValue.classList.remove('text-primary');
            } else {
                balanceValue.classList.remove('text-red-400');
                balanceValue.classList.add('text-primary');
            }
        }

        // ============================================
        // PAYMENT SELECTION & TOTALS
        // ============================================
        function selectPayment(method) {
            if (method === 'Card') return;
            
            selectedPayment = method;
            
            document.querySelectorAll('.payment-option').forEach(el => el.classList.remove('selected'));
            document.getElementById(`payment${method}`).classList.add('selected');
            
            updateBalanceDisplay();
            updateTotals();
        }

        function setAmount(amount) {
            document.getElementById('tokenAmount').value = amount;
            updateTotals();
        }

        function updateTotals() {
            const tokenAmount = parseInt(document.getElementById('tokenAmount').value) || 0;
            const totalEUR = tokenAmount * CONFIG.tokenPriceEUR;
            const totalUSD = totalEUR * CONFIG.eurUsdRate;
            
            document.getElementById('totalTokensDisplay').textContent = `${tokenAmount.toLocaleString()} VIP`;
            document.getElementById('totalEUR').textContent = `‚Ç¨${totalEUR.toFixed(2)}`;
            document.getElementById('totalUSD').textContent = `$${totalUSD.toFixed(2)}`;
            
            const cryptoEquiv = document.getElementById('cryptoEquivalent');
            if (selectedPayment === 'POL') {
                const polAmount = totalUSD / CONFIG.polPrice;
                cryptoEquiv.textContent = `‚âà ${polAmount.toFixed(2)} POL`;
            } else {
                cryptoEquiv.textContent = `‚âà ${totalUSD.toFixed(2)} USDC`;
            }
            
            updateBuyButton(tokenAmount, totalUSD);
            updateBalanceDisplay();
        }

        function updateBuyButton(tokenAmount, totalUSD) {
            const buyButton = document.getElementById('buyButton');
            const balance = selectedPayment === 'POL' ? userBalances.POL : userBalances.USDC;
            const required = selectedPayment === 'POL' ? totalUSD / CONFIG.polPrice : totalUSD;
            
            if (!currentWallet) {
                buyButton.textContent = 'Connect Wallet';
                buyButton.disabled = true;
            } else if (!CONFIG.presaleEnabled) {
                buyButton.textContent = 'Presale Not Active';
                buyButton.disabled = true;
            } else if (tokenAmount < CONFIG.minPurchase) {
                buyButton.textContent = `Min ${CONFIG.minPurchase} VIP`;
                buyButton.disabled = true;
            } else if (tokenAmount > CONFIG.maxPurchase) {
                buyButton.textContent = `Max ${CONFIG.maxPurchase} VIP`;
                buyButton.disabled = true;
            } else if (balance < required) {
                buyButton.textContent = 'Insufficient Balance';
                buyButton.disabled = true;
            } else {
                buyButton.textContent = `Buy ${tokenAmount.toLocaleString()} VIP`;
                buyButton.disabled = false;
            }
        }

        // ============================================
        // PURCHASE EXECUTION
        // ============================================
        async function executePurchase() {
            if (!currentWallet) return connectWallet();
            if (!CONFIG.presaleEnabled) return alert('Presale is not active');
            
            const tokenAmount = parseInt(document.getElementById('tokenAmount').value);
            if (tokenAmount < CONFIG.minPurchase || tokenAmount > CONFIG.maxPurchase) {
                return alert(`Please enter an amount between ${CONFIG.minPurchase} and ${CONFIG.maxPurchase}`);
            }
            
            const totalEUR = tokenAmount * CONFIG.tokenPriceEUR;
            const totalUSD = totalEUR * CONFIG.eurUsdRate;
            
            pendingPurchase = {
                tokenAmount,
                totalEUR,
                totalUSD,
                paymentMethod: selectedPayment,
                wallet: currentWallet,
                timestamp: Date.now()
            };
            localStorage.setItem('pendingPurchase', JSON.stringify(pendingPurchase));
            
            showProcessing('Initiating Payment', 'Redirecting to WalletTwo...', 'Step 1: Confirm Payment');
            
            const redirectUri = `${window.location.origin}/presale?purchase=complete`;
            
            if (selectedPayment === 'USDC') {
                const usdcAmount = Math.ceil(totalUSD * 1e6);
                
                const txUrl = new URL(`${CONFIG.walletTwoOrigin}/auth/login`);
                txUrl.searchParams.set('action', 'transaction');
                txUrl.searchParams.set('redirect_uri', redirectUri);
                txUrl.searchParams.set('address', CONFIG.usdcAddress);
                txUrl.searchParams.set('methods', 'transfer');
                txUrl.searchParams.set('params', JSON.stringify([CONFIG.presaleWallet, usdcAmount.toString()]));
                txUrl.searchParams.set('external_ids', `presale-${Date.now()}`);
                
                window.location.href = txUrl.toString();
            } else {
                const polAmount = totalUSD / CONFIG.polPrice;
                const polWei = BigInt(Math.ceil(polAmount * 1e18)).toString();
                
                const txUrl = new URL(`${CONFIG.walletTwoOrigin}/auth/login`);
                txUrl.searchParams.set('action', 'transaction');
                txUrl.searchParams.set('redirect_uri', redirectUri);
                txUrl.searchParams.set('address', CONFIG.presaleWallet);
                txUrl.searchParams.set('value', polWei);
                txUrl.searchParams.set('external_ids', `presale-${Date.now()}`);
                
                window.location.href = txUrl.toString();
            }
        }

        async function handlePurchaseCallback(txHash, success) {
            const stored = localStorage.getItem('pendingPurchase');
            if (!stored) {
                showError('Purchase Error', 'Could not find purchase details. Please try again.');
                return;
            }
            
            pendingPurchase = JSON.parse(stored);
            
            if (!success || !txHash) {
                showError('Payment Failed', 'The payment transaction was not completed. Please try again.');
                localStorage.removeItem('pendingPurchase');
                return;
            }
            
            showProcessing('Verifying Payment', 'Checking transaction on blockchain...', 'Step 2: Verification');
            
            try {
                const response = await fetch('/api/presale/verify-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        txHash,
                        walletAddress: pendingPurchase.wallet,
                        tokenAmount: pendingPurchase.tokenAmount,
                        totalEUR: pendingPurchase.totalEUR,
                        totalUSD: pendingPurchase.totalUSD,
                        paymentMethod: pendingPurchase.paymentMethod
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showProcessing('Minting Tokens', 'Sending VIP tokens to your wallet...', 'Step 3: Minting');
                    await new Promise(r => setTimeout(r, 1500));
                    
                    showSuccess({
                        tokenAmount: pendingPurchase.tokenAmount,
                        paymentTxHash: txHash,
                        mintTxHash: result.mintTxHash
                    });
                    
                    loadPresaleConfig();
                    loadPurchaseHistory(currentWallet);
                } else {
                    showError('Verification Failed', result.error || 'Could not verify payment. Please contact support.');
                }
            } catch (error) {
                console.error('Verification error:', error);
                showError('Server Error', 'Could not communicate with server. Please contact support with TX: ' + txHash);
            }
            
            localStorage.removeItem('pendingPurchase');
        }

        // ============================================
        // OVERLAYS
        // ============================================
        function showProcessing(title, text, step) {
            document.getElementById('processingTitle').textContent = title;
            document.getElementById('processingText').textContent = text;
            document.getElementById('processingStep').textContent = step;
            document.getElementById('processingOverlay').classList.remove('hidden');
        }

        function hideProcessing() {
            document.getElementById('processingOverlay').classList.add('hidden');
        }

        function showSuccess(data) {
            hideProcessing();
            
            const resultOverlay = document.getElementById('resultOverlay');
            document.getElementById('resultIcon').textContent = 'check_circle';
            document.getElementById('resultIcon').className = 'material-symbols-outlined text-7xl mb-6 text-primary';
            document.getElementById('resultTitle').textContent = 'Purchase Complete!';
            document.getElementById('resultMessage').textContent = `${data.tokenAmount.toLocaleString()} VIP tokens have been sent to your wallet.`;
            
            document.getElementById('resultTokens').textContent = `${data.tokenAmount.toLocaleString()} VIP`;
            
            const paymentLink = document.getElementById('resultPaymentTx');
            paymentLink.href = `${CONFIG.explorerUrl}/tx/${data.paymentTxHash}`;
            paymentLink.textContent = shortenAddress(data.paymentTxHash);
            
            const mintLink = document.getElementById('resultMintTx');
            if (data.mintTxHash) {
                mintLink.href = `${CONFIG.explorerUrl}/tx/${data.mintTxHash}`;
                mintLink.textContent = shortenAddress(data.mintTxHash);
                mintLink.parentElement.style.display = 'flex';
            } else {
                mintLink.parentElement.style.display = 'none';
            }
            
            document.getElementById('resultDetails').style.display = 'block';
            resultOverlay.classList.remove('hidden');
        }

        function showError(title, message) {
            hideProcessing();
            
            const resultOverlay = document.getElementById('resultOverlay');
            document.getElementById('resultIcon').textContent = 'error';
            document.getElementById('resultIcon').className = 'material-symbols-outlined text-7xl mb-6 text-red-400';
            document.getElementById('resultTitle').textContent = title;
            document.getElementById('resultMessage').textContent = message;
            document.getElementById('resultDetails').style.display = 'none';
            
            resultOverlay.classList.remove('hidden');
        }

        function closeResult() {
            document.getElementById('resultOverlay').classList.add('hidden');
            document.getElementById('tokenAmount').value = '';
            updateTotals();
        }

        function viewInWallet() {
            window.open(`${CONFIG.walletTwoOrigin}/wallet/dashboard?tab=Tokens&companyId=${CONFIG.companyId}`, '_blank');
        }

        // ============================================
        // PURCHASE HISTORY
        // ============================================
        async function loadPurchaseHistory(address) {
            try {
                const response = await fetch(`/api/presale/purchases/${address}`);
                const data = await response.json();
                
                const historyList = document.getElementById('historyList');
                
                if (!data.purchases || data.purchases.length === 0) {
                    historyList.innerHTML = '<p class="text-slate-500 text-sm text-center py-4">No purchases yet</p>';
                    return;
                }
                
                historyList.innerHTML = data.purchases.map(purchase => `
                    <div class="flex justify-between items-center py-3 border-b border-white/5 last:border-0">
                        <div>
                            <p class="text-sm font-bold text-white">${Number(purchase.token_amount).toLocaleString()} VIP</p>
                            <p class="text-xs text-slate-500">${new Date(purchase.created_at).toLocaleDateString()}</p>
                        </div>
                        <span class="px-3 py-1 text-xs font-bold uppercase rounded-full ${
                            purchase.status === 'completed' ? 'bg-primary/20 text-primary' :
                            purchase.status === 'pending' || purchase.status === 'pending_mint' ? 'bg-yellow-500/20 text-yellow-400' :
                            'bg-slate-500/20 text-slate-400'
                        }">${purchase.status}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load purchase history:', error);
            }
        }
    </script>
</body>
</html>
