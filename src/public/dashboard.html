<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Kea Valley</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%); min-height: 100vh; }
        
        .glass-card {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .gold-gradient { background: linear-gradient(135deg, #ee9d2b 0%, #d4a543 100%); }
        .gold-text { color: #ee9d2b; }
        
        /* Tab styles */
        .main-tab {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.6);
            background: transparent;
            border: 1px solid transparent;
        }
        .main-tab:hover {
            color: rgba(255, 255, 255, 0.9);
            background: rgba(255, 255, 255, 0.05);
        }
        .main-tab.active {
            color: #ee9d2b;
            background: rgba(238, 157, 43, 0.1);
            border-color: rgba(238, 157, 43, 0.3);
        }
        
        .sub-tab {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: rgba(255, 255, 255, 0.5);
            background: transparent;
            font-size: 0.875rem;
        }
        .sub-tab:hover {
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.05);
        }
        .sub-tab.active {
            color: #ffffff;
            background: rgba(238, 157, 43, 0.2);
        }
        
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        
        /* Badge styles */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-success { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .badge-warning { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .badge-pending { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .badge-error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .badge-purple { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .badge-pink { background: rgba(236, 72, 153, 0.2); color: #ec4899; }

        /* Fix autofill/preset background */
        .input-field:-webkit-autofill,
        .input-field:-webkit-autofill:hover,
        .input-field:-webkit-autofill:focus,
        .input-field:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #1a1a1a inset !important;
            -webkit-text-fill-color: #ffffff !important;
            caret-color: #ffffff;
        }

        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #1a1a1a inset !important;
            -webkit-text-fill-color: #ffffff !important;
            caret-color: #ffffff;
        }
        
        /* Input field fixes - ensure visibility on dark background */
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            background: #1a1a1a !important;
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #ffffff !important;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            background: #222222 !important;
            border-color: #ee9d2b;
            outline: none;
            box-shadow: 0 0 0 2px rgba(238, 157, 43, 0.2);
        }
        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.35);
        }
        .input-field:read-only {
            background: #111111 !important;
            color: rgba(255, 255, 255, 0.5) !important;
        }
        
        /* Table styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .data-table td {
            padding: 0.75rem 1rem;
            color: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .data-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }
        
        /* Button styles */
        .btn-gold {
            background: linear-gradient(135deg, #ee9d2b 0%, #d4a543 100%);
            color: #000;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .btn-gold:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(238, 157, 43, 0.4);
        }
        .btn-gold:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-outline:hover {
            border-color: #ee9d2b;
            color: #ee9d2b;
        }
        
        .btn-danger {
            background: transparent;
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
        }
        
        .btn-success {
            background: transparent;
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-success:hover {
            background: rgba(34, 197, 94, 0.1);
            border-color: #22c55e;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Stat card styles */
        .stat-card {
            background: rgba(26, 26, 26, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            padding: 1.25rem;
        }
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #ffffff;
        }
        .stat-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Toggle switch */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .toggle-switch.active {
            background: #ee9d2b;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: #ffffff;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        .toggle-switch.active::after {
            transform: translateX(24px);
        }
        
        /* Admin card */
        .admin-card {
            background: rgba(26, 26, 26, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            padding: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }
        .admin-card:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }
        .admin-card.super-admin {
            border-color: rgba(238, 157, 43, 0.3);
            background: rgba(238, 157, 43, 0.05);
        }
        
        /* Referral code card */
        .referral-code-display {
            background: rgba(238, 157, 43, 0.1);
            border: 1px solid rgba(238, 157, 43, 0.3);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-family: monospace;
            font-size: 1.125rem;
            font-weight: 600;
            color: #ee9d2b;
            letter-spacing: 0.1em;
        }
    </style>
</head>
<body class="text-white">
    <!-- Header -->
    <header class="glass-card border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/" class="text-xl font-bold gold-text">KEA VALLEY®</a>
                <span class="text-white/40">|</span>
                <span class="text-white/60">Admin Dashboard</span>
            </div>
            <div class="flex items-center gap-4">
                <span id="adminInfo" class="text-white/60 text-sm"></span>
                <a href="/" class="btn-outline text-sm">Back to Site</a>
                <button onclick="logout()" class="btn-outline text-sm text-red-400 border-red-400/30 hover:border-red-400">Logout</button>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Main Tabs -->
        <div class="flex flex-wrap gap-2 mb-8">
            <button class="main-tab active" data-tab="claims" onclick="switchMainTab('claims')">
                <span class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Free Claims
                </span>
            </button>
            <button class="main-tab" data-tab="manual-mint" onclick="switchMainTab('manual-mint')">
                <span class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Manual Mint
                </span>
            </button>
            <button class="main-tab" data-tab="presale" onclick="switchMainTab('presale')">
                <span class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    Presale
                </span>
            </button>
            <button class="main-tab" data-tab="referrals" onclick="switchMainTab('referrals')">
                <span class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                    </svg>
                    Referrals
                </span>
            </button>
            <button class="main-tab" data-tab="admins" onclick="switchMainTab('admins')">
                <span class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    Admins
                </span>
            </button>
            <button class="main-tab" data-tab="settings" onclick="switchMainTab('settings')">
                <span class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Settings
                </span>
            </button>
        </div>
        
        <!-- Claims Tab Panel -->
        <div id="claims-panel" class="tab-panel active">
            <!-- Claims Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="stat-card">
                    <div class="stat-label">Total Registrants</div>
                    <div class="stat-value" id="claims-total">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Minted</div>
                    <div class="stat-value text-green-400" id="claims-minted">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pending</div>
                    <div class="stat-value text-yellow-400" id="claims-pending">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">With Balance</div>
                    <div class="stat-value text-blue-400" id="claims-balance">--</div>
                </div>
            </div>
            
            <!-- Claims Actions -->
            <div class="flex gap-4 mb-6">
                <button onclick="loadRegistrants()" class="btn-gold">Refresh Data</button>
                <button onclick="syncMembers()" class="btn-outline">Sync from WalletTwo</button>
                <button onclick="openFullSyncModal()" class="btn-outline">Full Sync</button>
                <button onclick="exportClaimsCSV()" class="btn-outline">Export CSV</button>
            </div>
            
            <!-- Claims Table -->
            <div class="glass-card rounded-xl overflow-hidden">
                <div class="p-4 border-b border-white/10">
                    <h3 class="font-semibold">Registrants</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Address</th>
                                <th>Status</th>
                                <th>TX Hash</th>
                                <th>Registered</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="registrants-table">
                            <tr>
                                <td colspan="6" class="text-center text-white/40 py-8">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Presale Tab Panel -->
        <div id="presale-panel" class="tab-panel">
            <!-- Presale Stats -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                <div class="stat-card">
                    <div class="stat-label">Total Purchases</div>
                    <div class="stat-value" id="presale-total">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Tokens Sold</div>
                    <div class="stat-value gold-text" id="presale-tokens">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total EUR</div>
                    <div class="stat-value text-green-400" id="presale-usd">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Unique Buyers</div>
                    <div class="stat-value text-blue-400" id="presale-buyers">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pending Mint</div>
                    <div class="stat-value text-yellow-400" id="presale-pending">--</div>
                </div>
            </div>
            
            <!-- Presale Progress -->
            <div class="glass-card rounded-xl p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-white/60">Sale Progress</span>
                    <span class="gold-text font-semibold" id="presale-progress-pct">0%</span>
                </div>
                <div class="w-full h-3 bg-white/10 rounded-full overflow-hidden">
                    <div id="presale-progress-bar" class="h-full gold-gradient transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-2 text-sm text-white/40">
                    <span>0</span>
                    <span id="presale-progress-total">1,000,000 VIP</span>
                </div>
            </div>
            
            <!-- Presale Actions -->
            <div class="flex gap-4 mb-6">
                <button onclick="loadPresaleStats()" class="btn-gold">Refresh Data</button>
                <button onclick="fulfillOrders()" class="btn-outline">Fulfill Orders</button>
                <button onclick="exportPresaleCSV()" class="btn-outline">Export CSV</button>
                <a href="/presale" target="_blank" class="btn-outline">View Presale</a>
            </div>
            
            <!-- Presale Purchases Table -->
            <div class="glass-card rounded-xl overflow-hidden">
                <div class="p-4 border-b border-white/10 flex items-center justify-between">
                    <h3 class="font-semibold">Presale Purchases</h3>
                    <div class="flex gap-2">
                        <button onclick="filterPresale('all')" class="sub-tab active" data-filter="all">All</button>
                        <button onclick="filterPresale('pending')" class="sub-tab" data-filter="pending">Pending</button>
                        <button onclick="filterPresale('paid')" class="sub-tab" data-filter="paid">Paid</button>
                        <button onclick="filterPresale('minted')" class="sub-tab" data-filter="minted">Minted</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Wallet</th>
                                <th>Tokens</th>
                                <th>Amount</th>
                                <th>Payment</th>
                                <th>Status</th>
                                <th>Referrer</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="presale-table">
                            <tr>
                                <td colspan="9" class="text-center text-white/40 py-8">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Referrals Tab Panel -->
        <div id="referrals-panel" class="tab-panel">
            <!-- Referral Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="stat-card">
                    <div class="stat-label">Active Codes</div>
                    <div class="stat-value gold-text" id="referral-codes-total">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Referrals</div>
                    <div class="stat-value text-pink-400" id="referral-total">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Signup Bonuses Paid</div>
                    <div class="stat-value text-green-400" id="referral-signup-bonus">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Presale Bonuses Paid</div>
                    <div class="stat-value text-blue-400" id="referral-presale-bonus">--</div>
                </div>
            </div>
            
            <!-- Referral Settings -->
            <div class="glass-card rounded-xl p-6 mb-8">
                <h3 class="font-semibold text-lg mb-6 flex items-center gap-2">
                    <svg class="w-5 h-5 gold-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Referral Program Settings
                </h3>
                
                <div class="space-y-6">
                    <!-- Enable Toggle -->
                    <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg">
                        <div>
                            <p class="font-medium">Referral Program Enabled</p>
                            <p class="text-white/40 text-sm">Allow users to generate and share referral codes</p>
                        </div>
                        <div id="referral-enabled-toggle" class="toggle-switch" onclick="toggleReferralEnabled()"></div>
                    </div>
                    
                    <!-- Signup Bonus -->
                    <div class="p-4 bg-white/5 rounded-lg">
                        <p class="font-medium mb-4">Signup Bonus (when referee registers)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-white/60 text-sm block mb-2">Bonus Type</label>
                                <select id="referral-bonus-type" class="input-field">
                                    <option value="percentage">Percentage (%)</option>
                                    <option value="fixed">Fixed (VIP tokens)</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-white/60 text-sm block mb-2">Bonus Amount</label>
                                <input type="number" id="referral-bonus-amount" class="input-field" value="5" step="0.01" min="0">
                            </div>
                        </div>
                        <p id="referral-bonus-explanation" class="text-white/40 text-sm mt-2">Referrer receives 5% of referee's first purchase</p>
                    </div>
                    
                    <!-- Presale Bonus -->
                    <div class="p-4 bg-white/5 rounded-lg">
                        <p class="font-medium mb-4">Presale Purchase Bonus (when referee buys)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-white/60 text-sm block mb-2">Bonus Type</label>
                                <select id="referral-presale-bonus-type" class="input-field">
                                    <option value="percentage">Percentage (%)</option>
                                    <option value="fixed">Fixed (VIP tokens)</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-white/60 text-sm block mb-2">Bonus Amount</label>
                                <input type="number" id="referral-presale-bonus-amount" class="input-field" value="5" step="0.01" min="0">
                            </div>
                        </div>
                        <p id="referral-presale-bonus-explanation" class="text-white/40 text-sm mt-2">Referrer receives 5% of referee's presale purchase in VIP tokens</p>
                    </div>
                    
                    <!-- Minimum Purchase -->
                    <div>
                        <label class="text-white/60 text-sm block mb-2">Minimum Purchase for Bonus (EUR)</label>
                        <input type="number" id="referral-min-purchase" class="input-field" value="10" step="1" min="0">
                        <p class="text-white/40 text-xs mt-1">Referee must spend at least this amount for referrer to earn presale bonus</p>
                    </div>
                    
                    <!-- Save Button -->
                    <div class="pt-4">
                        <button onclick="saveReferralSettings()" class="btn-gold">Save Referral Settings</button>
                        <span id="referral-settings-status" class="ml-4 text-sm"></span>
                    </div>
                </div>
            </div>
            
            <!-- Referral Actions -->
            <div class="flex gap-4 mb-6">
                <button onclick="loadReferralData()" class="btn-gold">Refresh Data</button>
                <button onclick="exportReferralCodesCSV()" class="btn-outline">Export Codes CSV</button>
                <button onclick="exportReferralsCSV()" class="btn-outline">Export Referrals CSV</button>
            </div>
            
            <!-- Referral Codes Table -->
            <div class="glass-card rounded-xl overflow-hidden mb-8">
                <div class="p-4 border-b border-white/10 flex items-center justify-between">
                    <h3 class="font-semibold">Referral Codes</h3>
                    <div class="flex gap-2">
                        <button onclick="filterReferralCodes('all')" class="sub-tab active" data-code-filter="all">All</button>
                        <button onclick="filterReferralCodes('active')" class="sub-tab" data-code-filter="active">Active</button>
                        <button onclick="filterReferralCodes('disabled')" class="sub-tab" data-code-filter="disabled">Disabled</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Owner Wallet</th>
                                <th>Referrals</th>
                                <th>Total Bonus Earned</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="referral-codes-table">
                            <tr>
                                <td colspan="7" class="text-center text-white/40 py-8">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Referrals Activity Table -->
            <div class="glass-card rounded-xl overflow-hidden">
                <div class="p-4 border-b border-white/10">
                    <h3 class="font-semibold">Referral Activity</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Referrer</th>
                                <th>Code Used</th>
                                <th>Referee</th>
                                <th>Signup Bonus</th>
                                <th>Presale Bonus</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="referrals-activity-table">
                            <tr>
                                <td colspan="6" class="text-center text-white/40 py-8">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Admins Tab Panel -->
        <div id="admins-panel" class="tab-panel">
            <!-- Admin Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="stat-card">
                    <div class="stat-label">Total Admins</div>
                    <div class="stat-value" id="admins-total">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Super Admins</div>
                    <div class="stat-value gold-text" id="admins-super">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Regular Admins</div>
                    <div class="stat-value text-blue-400" id="admins-regular">--</div>
                </div>
            </div>
            
            <!-- Add Admin Form (only visible to super_admin) -->
            <div id="add-admin-section" class="glass-card rounded-xl p-6 mb-8 hidden">
                <h3 class="font-semibold text-lg mb-6 flex items-center gap-2">
                    <svg class="w-5 h-5 gold-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                    </svg>
                    Add New Admin
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-2">
                        <label class="text-white/60 text-sm block mb-2">Email Address *</label>
                        <input type="email" id="new-admin-email" class="input-field" placeholder="admin@example.com">
                    </div>
                    <div>
                        <label class="text-white/60 text-sm block mb-2">Name</label>
                        <input type="text" id="new-admin-name" class="input-field" placeholder="John Doe">
                    </div>
                    <div>
                        <label class="text-white/60 text-sm block mb-2">Role</label>
                        <select id="new-admin-role" class="input-field">
                            <option value="admin">Admin</option>
                            <option value="super_admin">Super Admin</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-4 flex items-center gap-4">
                    <button onclick="addAdmin()" class="btn-gold">Add Admin</button>
                    <span id="add-admin-status" class="text-sm"></span>
                </div>
                
                <p class="text-white/40 text-xs mt-4">
                    * The email must match the WalletTwo account email. The user will be able to login after being added.
                </p>
            </div>
            
            <!-- Not Super Admin Notice -->
            <div id="not-super-admin-notice" class="glass-card rounded-xl p-6 mb-8 hidden">
                <div class="flex items-center gap-4 text-yellow-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <div>
                        <p class="font-semibold">View Only Access</p>
                        <p class="text-white/60 text-sm">Only super admins can add or remove other admins.</p>
                    </div>
                </div>
            </div>
            
            <!-- Admin List -->
            <div class="glass-card rounded-xl overflow-hidden">
                <div class="p-4 border-b border-white/10 flex items-center justify-between">
                    <h3 class="font-semibold">Admin Whitelist</h3>
                    <button onclick="loadAdmins()" class="btn-outline text-sm">Refresh</button>
                </div>
                <div id="admins-list" class="p-4 space-y-3">
                    <div class="text-center text-white/40 py-8">Loading...</div>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab Panel -->
        <div id="settings-panel" class="tab-panel">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Presale Configuration -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="font-semibold text-lg mb-6 flex items-center gap-2">
                        <svg class="w-5 h-5 gold-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Presale Configuration
                    </h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <label class="text-white/80">Presale Enabled</label>
                            <div id="presale-enabled-toggle" class="toggle-switch" onclick="togglePresaleEnabled()"></div>
                        </div>
                        
                        <div>
                            <label class="text-white/60 text-sm block mb-2">Token Price (EUR)</label>
                            <input type="number" id="setting-token-price" class="input-field" value="1.00" step="0.01" min="0.01">
                            <p class="text-white/40 text-xs mt-1">Base price in EUR</p>
                        </div>
                        
                        <div>
                            <label class="text-white/60 text-sm block mb-2">Total Tokens</label>
                            <input type="number" id="setting-total-tokens" class="input-field" value="1000000" min="1">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-white/60 text-sm block mb-2">Min Purchase</label>
                                <input type="number" id="setting-min-purchase" class="input-field" value="10" min="1">
                            </div>
                            <div>
                                <label class="text-white/60 text-sm block mb-2">Max Purchase</label>
                                <input type="number" id="setting-max-purchase" class="input-field" value="10000" min="1">
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-white/60 text-sm block mb-2">Presale Wallet</label>
                            <input type="text" id="setting-presale-wallet" class="input-field font-mono text-sm" placeholder="0x...">
                        </div>
                        
                        <div class="pt-4">
                            <button onclick="savePresaleSettings()" class="btn-gold w-full">Save Settings</button>
                        </div>
                        
                        <p class="text-white/40 text-xs mt-2">Note: Some settings require Vercel env var changes for persistence.</p>
                    </div>
                </div>
                
                <!-- Claim Configuration -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="font-semibold text-lg mb-6 flex items-center gap-2">
                        <svg class="w-5 h-5 gold-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Claim Configuration
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-white/60 text-sm block mb-2">Mint Amount per Claim</label>
                            <input type="number" id="setting-mint-amount" class="input-field" value="2" min="1" max="100" step="1">
                            <p class="text-white/40 text-xs mt-1">VIP tokens minted per free claim</p>
                        </div>
                        <div class="pt-4">
                            <button onclick="saveClaimSettings()" class="btn-gold">Save Claim Settings</button>
                            <span id="claim-settings-status" class="ml-4 text-sm"></span>
                        </div>
                        
                        <div>
                            <label class="text-white/60 text-sm block mb-2">VIP Token Contract</label>
                            <input type="text" id="setting-contract" class="input-field font-mono text-sm" value="0x6860c34db140DB7B589DaDA38859a1d3736bbE3F" readonly>
                            <a href="https://polygonscan.com/token/0x6860c34db140DB7B589DaDA38859a1d3736bbE3F" target="_blank" class="text-xs gold-text hover:underline mt-1 inline-block">View on Polygonscan →</a>
                        </div>
                        
                        <div>
                            <label class="text-white/60 text-sm block mb-2">Network</label>
                            <input type="text" class="input-field" value="Polygon Mainnet (Chain ID: 137)" readonly>
                        </div>
                    </div>
                </div>
                
                <!-- Stripe Integration -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="font-semibold text-lg mb-6 flex items-center gap-2">
                        <svg class="w-5 h-5 gold-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                        Stripe Integration
                    </h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                            <span class="text-white/80">Status</span>
                            <span id="stripe-status" class="badge badge-pending">Checking...</span>
                        </div>
                        
                        <p class="text-white/60 text-sm">Stripe keys are configured via environment variables:</p>
                        <ul class="text-white/40 text-sm space-y-1 ml-4">
                            <li>• STRIPE_SECRET_KEY</li>
                            <li>• STRIPE_PUBLIC_KEY</li>
                            <li>• STRIPE_WEBHOOK_SECRET</li>
                        </ul>
                        
                        <a href="https://dashboard.stripe.com" target="_blank" class="btn-outline w-full text-center block mt-4">
                            Open Stripe Dashboard →
                        </a>
                    </div>
                </div>
                
                <!-- Database Status -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="font-semibold text-lg mb-6 flex items-center gap-2">
                        <svg class="w-5 h-5 gold-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                        </svg>
                        Database Status
                    </h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                            <span class="text-white/80">PostgreSQL</span>
                            <span id="db-status" class="badge badge-pending">Checking...</span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-3 bg-white/5 rounded-lg text-center">
                                <div class="text-2xl font-bold" id="db-registrants">--</div>
                                <div class="text-white/40 text-sm">Registrants</div>
                            </div>
                            <div class="p-3 bg-white/5 rounded-lg text-center">
                                <div class="text-2xl font-bold" id="db-purchases">--</div>
                                <div class="text-white/40 text-sm">Purchases</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Manual Mint Tab Panel -->
        <div id="manual-mint-panel" class="tab-panel">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Mint Form -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="font-semibold text-lg mb-6 flex items-center gap-2">
                        <svg class="w-5 h-5 gold-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Manual Presale Mint (Cash/Bank Transfers)
                    </h3>
                    <p class="text-white/60 text-sm mb-6">
                        Mint VIP tokens for payments received outside Stripe/crypto. Tokens are calculated automatically based on presale price (€1.00 per VIP).
                    </p>
                    
                    <form id="manual-mint-form" onsubmit="submitManualMint(event)" class="space-y-4">
                        <div>
                            <label class="text-white/60 text-sm block mb-2">Recipient Wallet Address *</label>
                            <input type="text" id="mint-wallet" required placeholder="0x..." class="input-field font-mono"/>
                        </div>
                        
                        <div>
                            <label class="text-white/60 text-sm block mb-2">EUR Amount Received *</label>
                            <input type="number" id="mint-eur" required min="1" step="0.01" placeholder="e.g., 1000.00"
                                oninput="updateMintSummary()" class="input-field"/>
                        </div>

                        <!-- Summary -->
                        <div class="p-4 bg-white/5 rounded-lg space-y-2">
                            <h4 class="text-sm font-medium gold-text">Summary</h4>
                            <div class="flex justify-between text-sm">
                                <span class="text-white/60">EUR Received:</span>
                                <span id="summary-eur">€0.00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-white/60">Platform Fee (1%):</span>
                                <span id="summary-fee" class="text-white/60">€0.00</span>
                            </div>
                            <div class="flex justify-between text-sm border-t border-white/10 pt-2 mt-2">
                                <span class="text-white/80 font-medium">Tokens to Mint:</span>
                                <span id="summary-tokens" class="gold-text font-bold">0 VIP</span>
                            </div>
                        </div>

                        <div id="mint-error" class="hidden bg-red-500/20 border border-red-500/50 rounded-lg p-3 text-red-400 text-sm"></div>
                        <div id="mint-success" class="hidden bg-green-500/20 border border-green-500/50 rounded-lg p-3 text-green-400 text-sm"></div>

                        <button type="submit" id="mint-submit-btn" class="btn-gold w-full py-3">
                            Mint Tokens
                        </button>
                    </form>
                </div>

                <!-- Recent Manual Mints -->
                <div class="glass-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-semibold text-lg flex items-center gap-2">
                            <svg class="w-5 h-5 gold-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            Recent Manual Mints
                        </h3>
                        <button onclick="loadManualMints()" class="btn-outline text-sm">Refresh</button>
                    </div>
                    <div class="space-y-3 max-h-[500px] overflow-y-auto" id="manual-mints-list">
                        <p class="text-white/40 text-sm text-center py-4">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

    </main>
    
    <!-- Full Sync Modal -->
    <div id="fullsync-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="p-6 border-b border-white/10 flex items-center justify-between">
                <h3 class="font-semibold text-lg">Full Sync Results</h3>
                <button onclick="closeFullSyncModal()" class="text-white/40 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="fullsync-content" class="p-6">
                <div class="text-center text-white/40 py-8">
                    <div class="animate-spin w-8 h-8 border-2 border-white/20 border-t-gold-text rounded-full mx-auto mb-4"></div>
                    Running sync...
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirm Remove Admin Modal -->
    <div id="confirm-remove-modal" class="modal-overlay">
        <div class="modal-content max-w-md">
            <div class="p-6 border-b border-white/10">
                <h3 class="font-semibold text-lg">Remove Admin</h3>
            </div>
            <div class="p-6">
                <p class="text-white/80 mb-4">Are you sure you want to remove this admin?</p>
                <p id="remove-admin-email" class="font-mono text-sm bg-white/5 p-3 rounded mb-6"></p>
                <div class="flex gap-4">
                    <button onclick="closeRemoveModal()" class="btn-outline flex-1">Cancel</button>
                    <button onclick="confirmRemoveAdmin()" class="btn-danger flex-1">Remove</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="border-t border-white/10 mt-16">
        <div class="max-w-7xl mx-auto px-4 py-6 text-center text-white/40 text-sm">
            &copy; 2025 KEA VALLEY®. All rights reserved.
        </div>
    </footer>
    
    <script>
        // Configuration
        const EXPLORER_URL = 'https://polygonscan.com';
        let currentFilter = 'all';
        let currentCodeFilter = 'all';
        let registrantsData = [];
        let presaleData = [];
        let adminsData = [];
        let referralCodesData = [];
        let referralsData = [];
        let referralSettings = {};
        let currentAdminRole = 'admin';
        let currentAdminEmail = '';
        let adminToRemove = null;
        
        // ==========================================
        // TAB SWITCHING - MUST BE IN GLOBAL SCOPE
        // ==========================================
        function switchMainTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                }
            });
            
            // Update panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(`${tabName}-panel`).classList.add('active');
            
            // Load data for the tab
            if (tabName === 'claims') {
                loadRegistrants();
            } else if (tabName === 'presale') {
                loadPresaleStats();
                loadPresalePurchases();
            } else if (tabName === 'referrals') {
                loadReferralData();
            } else if (tabName === 'admins') {
                loadAdmins();
            } else if (tabName === 'manual-mint') {
                loadManualMintConfig();
                loadManualMints();
            } else if (tabName === 'settings') {
                loadSettings();
            }
        }

        async function syncMembers() {
            try {
                const response = await fetch('/api/members/sync', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`Synced: ${data.synced} new, ${data.updated} updated`);
                    loadRegistrants(); // Refresh the table
                } else {
                    alert('Sync failed: ' + data.error);
                }
            } catch (error) {
                alert('Sync error: ' + error.message);
            }
        }

        async function saveClaimSettings() {
            const statusEl = document.getElementById('claim-settings-status');
            const mintAmount = parseInt(document.getElementById('setting-mint-amount').value) || 2;
            
            if (mintAmount < 1 || mintAmount > 100) {
                statusEl.innerHTML = '<span class="text-red-400">Amount must be between 1 and 100</span>';
                return;
            }
            
            statusEl.innerHTML = '<span class="text-white/60">Saving...</span>';
            
            try {
                const response = await fetch('/api/admin/claim/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ mintAmount })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusEl.innerHTML = '<span class="text-green-400">✓ Saved!</span>';
                    setTimeout(() => { statusEl.innerHTML = ''; }, 3000);
                } else {
                    statusEl.innerHTML = `<span class="text-red-400">${data.error || 'Failed to save'}</span>`;
                }
            } catch (error) {
                console.error('Error saving claim settings:', error);
                statusEl.innerHTML = '<span class="text-red-400">Network error</span>';
            }
        }
        
        // ==========================================
        // REFERRAL MANAGEMENT
        // ==========================================
        async function loadReferralData() {
            await Promise.all([
                loadReferralSettings(),
                loadReferralStats(),
                loadReferralCodes(),
                loadReferralsActivity()
            ]);
        }
        
        async function loadReferralSettings() {
            try {
                const response = await fetch('/api/referral/settings');
                const data = await response.json();
                referralSettings = data;
                
                // Update toggle
                const toggle = document.getElementById('referral-enabled-toggle');
                if (data.enabled) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
                
                // Update form fields
                document.getElementById('referral-bonus-type').value = data.bonusType || 'percentage';
                document.getElementById('referral-bonus-amount').value = data.bonusAmount || 5;
                document.getElementById('referral-presale-bonus-type').value = data.presaleBonusType || 'percentage';
                document.getElementById('referral-presale-bonus-amount').value = data.presaleBonusAmount || 5;
                document.getElementById('referral-min-purchase').value = data.minPurchaseForBonus || 10;
                
                updateBonusExplanations();
            } catch (error) {
                console.error('Error loading referral settings:', error);
            }
        }
        
        function updateBonusExplanations() {
            const bonusType = document.getElementById('referral-bonus-type').value;
            const bonusAmount = document.getElementById('referral-bonus-amount').value;
            const presaleBonusType = document.getElementById('referral-presale-bonus-type').value;
            const presaleBonusAmount = document.getElementById('referral-presale-bonus-amount').value;
            
            document.getElementById('referral-bonus-explanation').textContent = bonusType === 'percentage'
                ? `Referrer receives ${bonusAmount}% of referee's first purchase in VIP tokens`
                : `Referrer receives ${bonusAmount} VIP tokens when referee signs up`;
                
            document.getElementById('referral-presale-bonus-explanation').textContent = presaleBonusType === 'percentage'
                ? `Referrer receives ${presaleBonusAmount}% of referee's presale purchase in VIP tokens`
                : `Referrer receives ${presaleBonusAmount} VIP tokens per presale purchase by referee`;
        }
        
        // Add event listeners for real-time explanation updates
        document.getElementById('referral-bonus-type')?.addEventListener('change', updateBonusExplanations);
        document.getElementById('referral-bonus-amount')?.addEventListener('input', updateBonusExplanations);
        document.getElementById('referral-presale-bonus-type')?.addEventListener('change', updateBonusExplanations);
        document.getElementById('referral-presale-bonus-amount')?.addEventListener('input', updateBonusExplanations);
        
        async function loadReferralStats() {
            try {
                const response = await fetch('/api/admin/referral/stats', {
                    credentials: 'include'
                });
                const data = await response.json();
                console.log('Referral stats response:', data);
                
                // Use correct element IDs
                document.getElementById('referral-codes-total').textContent = data.total_codes || data.active_codes || 0;
                document.getElementById('referral-total').textContent = data.total_referrals || 0;
                document.getElementById('referral-signup-bonus').textContent = (parseFloat(data.total_bonus_earned) || 0).toFixed(2);
                document.getElementById('referral-presale-bonus').textContent = (parseFloat(data.total_presale_bonus) || 0).toFixed(2);
            } catch (error) {
                console.error('Error loading referral stats:', error);
            }
        }
        
        async function loadReferralCodes() {
            try {
                const response = await fetch('/api/admin/referral/codes', {
                    credentials: 'include'
                });
                const data = await response.json();
                console.log('Referral codes response:', data);
                
                // Handle all possible formats
                let codes = [];
                if (Array.isArray(data)) {
                    codes = data;
                } else if (data && Array.isArray(data.codes)) {
                    codes = data.codes;
                } else if (data && Array.isArray(data.rows)) {
                    codes = data.rows;
                }
                
                renderReferralCodes(codes);
            } catch (error) {
                console.error('Error loading referral codes:', error);
                renderReferralCodes([]);
            }
        }
        
        function filterReferralCodes(filter) {
            currentCodeFilter = filter;
            document.querySelectorAll('[data-code-filter]').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.codeFilter === filter) {
                    btn.classList.add('active');
                }
            });
            
            let filtered = referralCodesData;
            if (filter === 'active') {
                filtered = referralCodesData.filter(c => c.enabled);
            } else if (filter === 'disabled') {
                filtered = referralCodesData.filter(c => !c.enabled);
            }
            
            renderReferralCodes(filtered);
        }
        
        function renderReferralCodes(codes) {
            const tbody = document.getElementById('referral-codes-table');
            
            if (!codes || codes.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-white/40 py-8">No referral codes found</td></tr>`;
                return;
            }
            
            tbody.innerHTML = codes.map(c => {
                const wallet = c.owner_wallet || c.wallet_address || c.walletAddress || '--';
                const referralCount = c.total_referrals || c.referral_count || c.referralCount || 0;
                const totalBonus = parseFloat(c.total_bonus_earned || c.totalBonusEarned || 0);
                const createdAt = c.created_at || c.createdAt;
                
                return `
                    <tr>
                        <td>
                            <span class="referral-code-display">${c.code}</span>
                        </td>
                        <td>
                            <a href="${EXPLORER_URL}/address/${wallet}" target="_blank" class="text-blue-400 hover:underline font-mono text-sm">
                                ${wallet !== '--' ? wallet.substring(0, 6) + '...' + wallet.substring(wallet.length - 4) : '--'}
                            </a>
                        </td>
                        <td class="font-semibold">${referralCount}</td>
                        <td class="text-green-400">${totalBonus.toFixed(2)} VIP</td>
                        <td>
                            <span class="badge ${c.enabled ? 'badge-success' : 'badge-error'}">
                                ${c.enabled ? 'Active' : 'Disabled'}
                            </span>
                        </td>
                        <td class="text-white/60 text-sm">${createdAt ? new Date(createdAt).toLocaleDateString() : '--'}</td>
                        <td>
                            <button onclick="toggleReferralCode('${c.code}', ${!c.enabled})" class="${c.enabled ? 'btn-danger' : 'btn-success'} text-sm px-3 py-1">
                                ${c.enabled ? 'Disable' : 'Enable'}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        async function loadReferralsActivity() {
            try {
                const response = await fetch('/api/admin/referral/list', {
                    credentials: 'include'
                });
                const data = await response.json();
                console.log('Referrals activity response:', data);
                
                // Handle all possible formats
                let referrals = [];
                if (Array.isArray(data)) {
                    referrals = data;
                } else if (data && Array.isArray(data.referrals)) {
                    referrals = data.referrals;
                } else if (data && Array.isArray(data.rows)) {
                    referrals = data.rows;
                }
                
                renderReferralsActivity(referrals);
            } catch (error) {
                console.error('Error loading referrals activity:', error);
                renderReferralsActivity([]);
            }
        }

        
        function renderReferralsActivity(referrals) {
            const tbody = document.getElementById('referrals-activity-table');
            
            if (!referrals || referrals.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-white/40 py-8">No referrals yet</td></tr>`;
                return;
            }
            
            tbody.innerHTML = referrals.map(r => {
                const referrerWallet = r.referrer_wallet || r.referrerWallet || '--';
                const refereeWallet = r.referee_wallet || r.refereeWallet || '--';
                const code = r.referrer_code || r.referrerCode || '--';
                const signupBonus = parseFloat(r.signup_bonus_paid || r.bonus_earned || r.bonusEarned || 0);
                const presaleBonus = parseFloat(r.presale_bonus_paid || r.presale_bonus_earned || r.presaleBonusEarned || 0);
                const createdAt = r.created_at || r.createdAt;
                
                return `
                    <tr>
                        <td>
                            <a href="${EXPLORER_URL}/address/${referrerWallet}" target="_blank" class="text-blue-400 hover:underline font-mono text-sm">
                                ${referrerWallet !== '--' ? referrerWallet.substring(0, 6) + '...' + referrerWallet.substring(referrerWallet.length - 4) : '--'}
                            </a>
                        </td>
                        <td>
                            <span class="font-mono text-sm gold-text">${code}</span>
                        </td>
                        <td>
                            <a href="${EXPLORER_URL}/address/${refereeWallet}" target="_blank" class="text-blue-400 hover:underline font-mono text-sm">
                                ${refereeWallet !== '--' ? refereeWallet.substring(0, 6) + '...' + refereeWallet.substring(refereeWallet.length - 4) : '--'}
                            </a>
                        </td>
                        <td class="${signupBonus > 0 ? 'text-green-400' : 'text-white/40'}">${signupBonus.toFixed(4)} VIP</td>
                        <td class="${presaleBonus > 0 ? 'text-blue-400' : 'text-white/40'}">${presaleBonus.toFixed(4)} VIP</td>
                        <td class="text-white/60 text-sm">${createdAt ? new Date(createdAt).toLocaleDateString() : '--'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function toggleReferralEnabled() {
            const toggle = document.getElementById('referral-enabled-toggle');
            toggle.classList.toggle('active');
        }
        
        async function toggleReferralCode(code, enable) {
            try {
                const response = await fetch(`/api/admin/referral/code/${code}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ enabled: enable })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadReferralCodes();
                    loadReferralStats();
                } else {
                    alert(data.error || 'Failed to toggle referral code');
                }
            } catch (error) {
                console.error('Error toggling referral code:', error);
                alert('Error toggling referral code');
            }
        }
        
        async function saveReferralSettings() {
            const statusEl = document.getElementById('referral-settings-status');
            statusEl.innerHTML = '<span class="text-white/60">Saving...</span>';
            
            const settings = {
                enabled: document.getElementById('referral-enabled-toggle').classList.contains('active'),
                bonusType: document.getElementById('referral-bonus-type').value,
                bonusAmount: parseFloat(document.getElementById('referral-bonus-amount').value) || 5,
                presaleBonusType: document.getElementById('referral-presale-bonus-type').value,
                presaleBonusAmount: parseFloat(document.getElementById('referral-presale-bonus-amount').value) || 5,
                minPurchaseForBonus: parseFloat(document.getElementById('referral-min-purchase').value) || 10
            };
            
            console.log('Saving referral settings:', settings);
            
            try {
                const response = await fetch('/api/referral/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                console.log('Save response:', data);
                
                if (data.success) {
                    statusEl.innerHTML = '<span class="text-green-400">✓ Settings saved!</span>';
                    setTimeout(() => { statusEl.innerHTML = ''; }, 3000);
                } else {
                    statusEl.innerHTML = `<span class="text-red-400">Error: ${data.error || 'Failed to save'}</span>`;
                }
            } catch (error) {
                console.error('Error saving referral settings:', error);
                statusEl.innerHTML = '<span class="text-red-400">Network error</span>';
            }
        }

        function exportReferralCodesCSV() {
            if (!referralCodesData.length) {
                alert('No data to export');
                return;
            }
            
            const headers = ['Code', 'Wallet Address', 'Referrals', 'Total Bonus Earned', 'Status', 'Created'];
            const rows = referralCodesData.map(c => [
                c.code,
                c.wallet_address || c.walletAddress || '',
                c.referral_count || c.referralCount || 0,
                c.total_bonus_earned || c.totalBonusEarned || 0,
                c.enabled ? 'Active' : 'Disabled',
                c.created_at || c.createdAt || ''
            ]);
            
            const csv = [headers, ...rows].map(row => row.map(c => `"${c}"`).join(',')).join('\n');
            downloadCSV(csv, 'kea-valley-referral-codes.csv');
        }
        
        function exportReferralsCSV() {
            if (!referralsData.length) {
                alert('No data to export');
                return;
            }
            
            const headers = ['Referrer Wallet', 'Code', 'Referee Wallet', 'Signup Bonus', 'Presale Bonus', 'Date'];
            const rows = referralsData.map(r => [
                r.referrer_wallet || r.referrerWallet || '',
                r.referrer_code || r.referrerCode || '',
                r.referee_wallet || r.refereeWallet || '',
                r.bonus_earned || r.bonusEarned || 0,
                r.presale_bonus_earned || r.presaleBonusEarned || 0,
                r.created_at || r.createdAt || ''
            ]);
            
            const csv = [headers, ...rows].map(row => row.map(c => `"${c}"`).join(',')).join('\n');
            downloadCSV(csv, 'kea-valley-referrals.csv');
        }
        
        // ==========================================
        // ADMIN MANAGEMENT
        // ==========================================
        async function loadAdmins() {
            const listContainer = document.getElementById('admins-list');
            const addSection = document.getElementById('add-admin-section');
            const notSuperNotice = document.getElementById('not-super-admin-notice');
            
            // Show/hide add section based on role
            if (currentAdminRole === 'super_admin') {
                addSection.classList.remove('hidden');
                notSuperNotice.classList.add('hidden');
            } else {
                addSection.classList.add('hidden');
                notSuperNotice.classList.remove('hidden');
            }
            
            try {
                const response = await fetch('/api/admin/whitelist', { credentials: 'include' });
                
                if (response.status === 403) {
                    // Not a super admin, but can still see the list
                    listContainer.innerHTML = `
                        <div class="text-center text-white/40 py-8">
                            <p>Only super admins can view the full admin list.</p>
                        </div>
                    `;
                    return;
                }
                
                const data = await response.json();
                adminsData = data.admins || [];
                
                // Update stats
                const total = adminsData.length;
                const superAdmins = adminsData.filter(a => a.role === 'super_admin').length;
                const regularAdmins = total - superAdmins;
                
                document.getElementById('admins-total').textContent = total;
                document.getElementById('admins-super').textContent = superAdmins;
                document.getElementById('admins-regular').textContent = regularAdmins;
                
                renderAdmins(adminsData);
            } catch (error) {
                console.error('Error loading admins:', error);
                listContainer.innerHTML = `
                    <div class="text-center text-red-400 py-8">Error loading admins</div>
                `;
            }
        }
        
        function renderAdmins(admins) {
            const listContainer = document.getElementById('admins-list');
            
            if (!admins || admins.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center text-white/40 py-8">No admins found</div>
                `;
                return;
            }
            
            listContainer.innerHTML = admins.map(admin => {
                const isSuperAdmin = admin.role === 'super_admin';
                const isCurrentUser = admin.email.toLowerCase() === currentAdminEmail.toLowerCase();
                const lastLogin = admin.last_login ? new Date(admin.last_login).toLocaleDateString() : 'Never';
                const createdAt = admin.created_at ? new Date(admin.created_at).toLocaleDateString() : '--';
                
                return `
                    <div class="admin-card ${isSuperAdmin ? 'super-admin' : ''}">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-lg font-bold ${isSuperAdmin ? 'gold-text' : 'text-white/60'}">
                                ${(admin.name || admin.email).charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="font-semibold">${admin.name || admin.email.split('@')[0]}</span>
                                    ${isCurrentUser ? '<span class="badge badge-success text-xs">You</span>' : ''}
                                </div>
                                <p class="text-white/60 text-sm">${admin.email}</p>
                                <div class="flex items-center gap-4 mt-1 text-xs text-white/40">
                                    <span>Added: ${createdAt}</span>
                                    <span>Last login: ${lastLogin}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="badge ${isSuperAdmin ? 'badge-purple' : 'badge-pending'}">
                                ${isSuperAdmin ? 'Super Admin' : 'Admin'}
                            </span>
                            ${currentAdminRole === 'super_admin' && !isSuperAdmin && !isCurrentUser ? `
                                <button onclick="promptRemoveAdmin('${admin.email}')" class="btn-danger text-sm px-3 py-1">
                                    Remove
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function addAdmin() {
            const email = document.getElementById('new-admin-email').value.trim();
            const name = document.getElementById('new-admin-name').value.trim();
            const role = document.getElementById('new-admin-role').value;
            const statusEl = document.getElementById('add-admin-status');
            
            if (!email || !email.includes('@')) {
                statusEl.innerHTML = '<span class="text-red-400">Please enter a valid email</span>';
                return;
            }
            
            statusEl.innerHTML = '<span class="text-white/60">Adding admin...</span>';
            
            try {
                const response = await fetch('/api/admin/whitelist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, name, role })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusEl.innerHTML = '<span class="text-green-400">Admin added successfully!</span>';
                    document.getElementById('new-admin-email').value = '';
                    document.getElementById('new-admin-name').value = '';
                    document.getElementById('new-admin-role').value = 'admin';
                    loadAdmins();
                    
                    setTimeout(() => {
                        statusEl.innerHTML = '';
                    }, 3000);
                } else {
                    statusEl.innerHTML = `<span class="text-red-400">${data.error || 'Failed to add admin'}</span>`;
                }
            } catch (error) {
                console.error('Error adding admin:', error);
                statusEl.innerHTML = '<span class="text-red-400">Error adding admin</span>';
            }
        }
        
        function promptRemoveAdmin(email) {
            adminToRemove = email;
            document.getElementById('remove-admin-email').textContent = email;
            document.getElementById('confirm-remove-modal').classList.add('active');
        }
        
        function closeRemoveModal() {
            adminToRemove = null;
            document.getElementById('confirm-remove-modal').classList.remove('active');
        }
        
        async function confirmRemoveAdmin() {
            if (!adminToRemove) return;
            
            try {
                const response = await fetch(`/api/admin/whitelist/${encodeURIComponent(adminToRemove)}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeRemoveModal();
                    loadAdmins();
                } else {
                    alert(data.error || 'Failed to remove admin');
                }
            } catch (error) {
                console.error('Error removing admin:', error);
                alert('Error removing admin');
            }
        }
        
        // ==========================================
        // CLAIMS / REGISTRANTS
        // ==========================================
        async function loadRegistrants() {
            try {
                const response = await fetch('/api/registrants');
                const data = await response.json();
                registrantsData = data.registrants || data || [];
                renderRegistrants(registrantsData);
                updateClaimsStats(registrantsData);
            } catch (error) {
                console.error('Error loading registrants:', error);
                document.getElementById('registrants-table').innerHTML = `
                    <tr><td colspan="6" class="text-center text-red-400 py-8">Error loading data</td></tr>
                `;
            }
        }
        
        function renderRegistrants(registrants) {
            const tbody = document.getElementById('registrants-table');
            
            if (!registrants || registrants.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-white/40 py-8">No registrants found</td></tr>`;
                return;
            }
            
            tbody.innerHTML = registrants.map(r => {
                const email = r.email || r.metadata?.email || '--';
                const address = r.wallet_address || r.walletAddress || r.address || '--';
                const txHash = r.tx_hash || r.txHash || '';
                const minted = r.minted || r.status === 'minted';
                const date = r.created_at || r.createdAt || r.registered_at;
                
                return `
                    <tr>
                        <td>
                            ${email !== '--' ? `
                                <a href="mailto:${email}" class="text-blue-400 hover:underline flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                    ${email.length > 25 ? email.substring(0, 25) + '...' : email}
                                </a>
                            ` : '<span class="text-white/40">--</span>'}
                        </td>
                        <td>
                            <a href="${EXPLORER_URL}/address/${address}" target="_blank" class="text-blue-400 hover:underline font-mono text-sm">
                                ${address.substring(0, 6)}...${address.substring(address.length - 4)}
                            </a>
                        </td>
                        <td>
                            <span class="badge ${minted ? 'badge-success' : 'badge-warning'}">
                                ${minted ? 'Minted' : 'Pending'}
                            </span>
                        </td>
                        <td>
                            ${txHash ? `
                                <a href="${EXPLORER_URL}/tx/${txHash}" target="_blank" class="text-blue-400 hover:underline font-mono text-sm">
                                    ${txHash.substring(0, 8)}...
                                </a>
                            ` : '<span class="text-white/40">--</span>'}
                        </td>
                        <td class="text-white/60 text-sm">
                            ${date ? new Date(date).toLocaleDateString() : '--'}
                        </td>
                        <td>
                            <a href="${EXPLORER_URL}/address/${address}" target="_blank" class="text-white/40 hover:text-white text-sm">
                                View →
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateClaimsStats(registrants) {
            const total = registrants.length;
            const minted = registrants.filter(r => r.minted || r.status === 'minted').length;
            const pending = total - minted;
            const withBalance = registrants.filter(r => parseFloat(r.balance || 0) > 0).length;
            
            document.getElementById('claims-total').textContent = total.toLocaleString();
            document.getElementById('claims-minted').textContent = minted.toLocaleString();
            document.getElementById('claims-pending').textContent = pending.toLocaleString();
            document.getElementById('claims-balance').textContent = withBalance.toLocaleString();
        }
        
        // ==========================================
        // PRESALE
        // ==========================================
        async function loadPresaleStats() {
            try {
                const response = await fetch('/api/presale/admin/stats');
                const data = await response.json();
                
                document.getElementById('presale-total').textContent = (data.totalPurchases || 0).toLocaleString();
                document.getElementById('presale-tokens').textContent = (data.tokensSold || 0).toLocaleString();
                document.getElementById('presale-usd').textContent = '€' + (data.totalUsd || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('presale-buyers').textContent = (data.uniqueBuyers || 0).toLocaleString();
                document.getElementById('presale-pending').textContent = (data.pendingMint || 0).toLocaleString();
                
                const totalTokens = data.totalTokens || 1000000;
                const soldPct = ((data.tokensSold || 0) / totalTokens * 100).toFixed(2);
                document.getElementById('presale-progress-pct').textContent = soldPct + '%';
                document.getElementById('presale-progress-bar').style.width = soldPct + '%';
                document.getElementById('presale-progress-total').textContent = totalTokens.toLocaleString() + ' VIP';
            } catch (error) {
                console.error('Error loading presale stats:', error);
            }
        }
        
        async function loadPresalePurchases() {
            try {
                const response = await fetch('/api/presale/admin/purchases');
                const data = await response.json();
                presaleData = data.purchases || data || [];
                renderPresalePurchases(presaleData);
            } catch (error) {
                console.error('Error loading presale purchases:', error);
            }
        }
        
        function renderPresalePurchases(purchases) {
            const tbody = document.getElementById('presale-table');
            
            let filtered = purchases;
            if (currentFilter !== 'all') {
                filtered = purchases.filter(p => {
                    const status = (p.status || '').toLowerCase();
                    if (currentFilter === 'pending') return status === 'pending' || status === 'created';
                    if (currentFilter === 'paid') return status === 'paid' || status === 'paid_pending_mint';
                    if (currentFilter === 'minted') return status === 'minted' || status === 'completed';
                    return true;
                });
            }
            
            if (!filtered || filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center text-white/40 py-8">No purchases found</td></tr>`;
                return;
            }
            
            tbody.innerHTML = filtered.map(p => {
                const email = p.email || p.metadata?.email || '--';
                const wallet = p.wallet_address || p.walletAddress || '--';
                const tokens = p.token_amount || p.tokenAmount || 0;
                const amount = p.amount_usd || p.amountUsd || p.amount || 0;
                const payment = p.payment_method || p.paymentMethod || 'card';
                const status = p.status || 'pending';
                const referrer = p.referrer_wallet || p.referrerWallet || '';
                const date = p.created_at || p.createdAt;
                
                let statusClass = 'badge-warning';
                if (status === 'paid' || status === 'paid_pending_mint') statusClass = 'badge-pending';
                if (status === 'minted' || status === 'completed') statusClass = 'badge-success';
                if (status === 'failed' || status === 'cancelled') statusClass = 'badge-error';
                
                return `
                    <tr>
                        <td>
                            ${email !== '--' ? `
                                <a href="mailto:${email}" class="text-blue-400 hover:underline text-sm">
                                    ${email.length > 20 ? email.substring(0, 20) + '...' : email}
                                </a>
                            ` : '<span class="text-white/40">--</span>'}
                        </td>
                        <td>
                            <a href="${EXPLORER_URL}/address/${wallet}" target="_blank" class="text-blue-400 hover:underline font-mono text-sm">
                                ${wallet.substring(0, 6)}...${wallet.substring(wallet.length - 4)}
                            </a>
                        </td>
                        <td class="font-semibold">${tokens.toLocaleString()}</td>
                        <td class="text-green-400">€${parseFloat(amount).toFixed(2)}</td>
                        <td class="capitalize text-white/60">${payment}</td>
                        <td><span class="badge ${statusClass}">${status}</span></td>
                        <td>
                            ${referrer ? `
                                <a href="${EXPLORER_URL}/address/${referrer}" target="_blank" class="text-pink-400 hover:underline font-mono text-xs">
                                    ${referrer.substring(0, 6)}...${referrer.substring(referrer.length - 4)}
                                </a>
                            ` : '<span class="text-white/40">--</span>'}
                        </td>
                        <td class="text-white/60 text-sm">${date ? new Date(date).toLocaleDateString() : '--'}</td>
                        <td>
                            <button onclick="viewPurchase('${p.id}')" class="text-white/40 hover:text-white text-sm">View</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterPresale(filter) {
            currentFilter = filter;
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                }
            });
            renderPresalePurchases(presaleData);
        }
        
        function viewPurchase(id) {
            // TODO: Open purchase detail modal
            console.log('View purchase:', id);
        }
        
        async function fulfillOrders() {
            // TODO: Implement batch fulfillment
            alert('Batch fulfillment coming soon');
        }
        
        // ==========================================
        // SETTINGS
        // ==========================================
        async function loadSettings() {
            try {
                // Load presale config
                const configRes = await fetch('/api/presale/config');
                const config = await configRes.json();
                
                document.getElementById('setting-token-price').value = config.tokenPrice || 1.00;
                document.getElementById('setting-total-tokens').value = config.totalTokens || 1000000;
                document.getElementById('setting-min-purchase').value = config.minPurchase || 10;
                document.getElementById('setting-max-purchase').value = config.maxPurchase || 10000;
                document.getElementById('setting-presale-wallet').value = config.presaleWallet || '';
                
                const toggle = document.getElementById('presale-enabled-toggle');
                if (config.enabled) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }

                // Load claim settings
                try {
                    const claimRes = await fetch('/api/admin/claim/settings', { credentials: 'include' });
                    const claimData = await claimRes.json();
                    document.getElementById('setting-mint-amount').value = claimData.mintAmount || 2;
                } catch (e) {
                    console.log('Could not load claim settings');
                }
                
                // Check Stripe status
                document.getElementById('stripe-status').innerHTML = config.stripePublicKey ? 
                    '<span class="badge badge-success">Connected</span>' : 
                    '<span class="badge badge-warning">Not Configured</span>';
                
                // Load DB stats
                const statsRes = await fetch('/api/registrants');
                const stats = await statsRes.json();
                const regCount = (stats.registrants || stats || []).length;
                document.getElementById('db-registrants').textContent = regCount.toLocaleString();
                document.getElementById('db-status').innerHTML = '<span class="badge badge-success">Connected</span>';
                
                // Load presale purchase count
                const presaleStats = await fetch('/api/presale/admin/stats').then(r => r.json()).catch(() => ({}));
                document.getElementById('db-purchases').textContent = (presaleStats.totalPurchases || 0).toLocaleString();
                
            } catch (error) {
                console.error('Error loading settings:', error);
                document.getElementById('db-status').innerHTML = '<span class="badge badge-error">Error</span>';
            }
        }
        
        function togglePresaleEnabled() {
            const toggle = document.getElementById('presale-enabled-toggle');
            toggle.classList.toggle('active');
        }
        
        async function savePresaleSettings() {
            const settings = {
                enabled: document.getElementById('presale-enabled-toggle').classList.contains('active'),
                tokenPrice: parseFloat(document.getElementById('setting-token-price').value),
                totalTokens: parseInt(document.getElementById('setting-total-tokens').value),
                minPurchase: parseInt(document.getElementById('setting-min-purchase').value),
                maxPurchase: parseInt(document.getElementById('setting-max-purchase').value),
                presaleWallet: document.getElementById('setting-presale-wallet').value
            };
            
            try {
                const response = await fetch('/api/presale/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    alert('Settings saved successfully');
                } else {
                    throw new Error('Failed to save');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings');
            }
        }
        
        // ==========================================
        // FULL SYNC
        // ==========================================
        function openFullSyncModal() {
            document.getElementById('fullsync-modal').classList.add('active');
            performFullSync();
        }
        
        function closeFullSyncModal() {
            document.getElementById('fullsync-modal').classList.remove('active');
        }
        
        async function performFullSync() {
            const content = document.getElementById('fullsync-content');
            content.innerHTML = `
                <div class="text-center text-white/40 py-8">
                    <div class="animate-spin w-8 h-8 border-2 border-white/20 border-t-[#ee9d2b] rounded-full mx-auto mb-4"></div>
                    Running sync...
                </div>
            `;
            
            try {
                const response = await fetch('/api/full-sync', { method: 'POST' });
                const data = await response.json();
                
                const results = data.results || data;
                const registrants = results.registrants || [];
                
                content.innerHTML = `
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="text-center p-4 bg-white/5 rounded-lg">
                            <div class="text-2xl font-bold">${results.total || registrants.length || 0}</div>
                            <div class="text-white/40 text-sm">Total</div>
                        </div>
                        <div class="text-center p-4 bg-white/5 rounded-lg">
                            <div class="text-2xl font-bold text-green-400">${results.withBalance || 0}</div>
                            <div class="text-white/40 text-sm">With Balance</div>
                        </div>
                        <div class="text-center p-4 bg-white/5 rounded-lg">
                            <div class="text-2xl font-bold text-yellow-400">${results.updated || 0}</div>
                            <div class="text-white/40 text-sm">Updated</div>
                        </div>
                    </div>
                    
                    <div class="max-h-64 overflow-y-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Address</th>
                                    <th>Balance</th>
                                    <th>Status</th>
                                    <th>TX Hash</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${registrants.map(r => {
                                    const email = r.email || r.metadata?.email || '--';
                                    const addr = r.wallet_address || r.walletAddress || r.address || '--';
                                    const txHash = r.tx_hash || r.txHash || '';
                                    const balance = parseFloat(r.balance || 0);
                                    const minted = r.minted || balance > 0;
                                    
                                    return `
                                        <tr>
                                            <td class="text-sm">${email !== '--' ? email.substring(0, 20) + (email.length > 20 ? '...' : '') : '--'}</td>
                                            <td>
                                                <a href="${EXPLORER_URL}/address/${addr}" target="_blank" class="text-blue-400 hover:underline font-mono text-xs">
                                                    ${addr.substring(0, 6)}...${addr.substring(addr.length - 4)}
                                                </a>
                                            </td>
                                            <td class="${balance > 0 ? 'text-green-400' : 'text-white/40'}">${balance.toLocaleString()} VIP</td>
                                            <td><span class="badge ${minted ? 'badge-success' : 'badge-warning'}">${minted ? 'Minted' : 'Pending'}</span></td>
                                            <td>
                                                ${txHash ? `
                                                    <a href="${EXPLORER_URL}/tx/${txHash}" target="_blank" class="text-blue-400 hover:underline font-mono text-xs">
                                                        ${txHash.substring(0, 8)}...
                                                    </a>
                                                ` : '--'}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Full sync error:', error);
                content.innerHTML = `
                    <div class="text-center text-red-400 py-8">
                        <p class="mb-2">Error running sync</p>
                        <p class="text-sm text-white/40">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // ==========================================
        // EXPORT
        // ==========================================
        function exportClaimsCSV() {
            if (!registrantsData.length) {
                alert('No data to export');
                return;
            }
            
            const headers = ['Email', 'Wallet Address', 'Status', 'TX Hash', 'Balance', 'Registered'];
            const rows = registrantsData.map(r => [
                r.email || r.metadata?.email || '',
                r.wallet_address || r.walletAddress || r.address || '',
                (r.minted || r.status === 'minted') ? 'Minted' : 'Pending',
                r.tx_hash || r.txHash || '',
                r.balance || '0',
                r.created_at || r.createdAt || ''
            ]);
            
            const csv = [headers, ...rows].map(row => row.map(c => `"${c}"`).join(',')).join('\n');
            downloadCSV(csv, 'kea-valley-claims.csv');
        }
        
        function exportPresaleCSV() {
            if (!presaleData.length) {
                alert('No data to export');
                return;
            }
            
            const headers = ['Email', 'Wallet', 'Tokens', 'Amount EUR', 'Payment Method', 'Status', 'Referrer', 'Date'];
            const rows = presaleData.map(p => [
                p.email || p.metadata?.email || '',
                p.wallet_address || p.walletAddress || '',
                p.token_amount || p.tokenAmount || 0,
                p.amount_usd || p.amountUsd || p.amount || 0,
                p.payment_method || p.paymentMethod || 'card',
                p.status || 'pending',
                p.referrer_wallet || p.referrerWallet || '',
                p.created_at || p.createdAt || ''
            ]);
            
            const csv = [headers, ...rows].map(row => row.map(c => `"${c}"`).join(',')).join('\n');
            downloadCSV(csv, 'kea-valley-presale.csv');
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ==========================================
        // AUTH / LOGOUT
        // ==========================================
        async function logout() {
            try {
                await fetch('/api/admin/logout', { method: 'POST', credentials: 'include' });
                localStorage.removeItem('keavalley_admin');
                window.location.href = '/login';
            } catch (error) {
                window.location.href = '/login';
            }
        }

        async function checkAdminSession() {
            try {
                const response = await fetch('/api/admin/session', { credentials: 'include' });
                const data = await response.json();
                
                if (!data.authenticated) {
                    window.location.href = '/login';
                    return false;
                }
                
                // Store admin info
                if (data.admin) {
                    currentAdminRole = data.admin.role || 'admin';
                    currentAdminEmail = data.admin.email || '';
                    
                    const adminInfo = document.getElementById('adminInfo');
                    if (adminInfo) {
                        adminInfo.textContent = data.admin.email;
                    }
                }
                
                return data;
            } catch (error) {
                console.error('Session check failed:', error);
                window.location.href = '/login';
                return false;
            }
        }
        
        // Manual Mint Functions
        let manualMintTokenPrice = 1.00; // Will be loaded from config

        async function loadManualMintConfig() {
            try {
                const response = await fetch('/api/presale/config');
                const config = await response.json();
                manualMintTokenPrice = config.tokenPrice || 1.00;
                console.log('Manual mint token price loaded:', manualMintTokenPrice);
            } catch (error) {
                console.error('Error loading presale config for manual mint:', error);
            }
        }

        function updateMintSummary() {
            const eur = parseFloat(document.getElementById('mint-eur').value) || 0;
            const fee = eur * 0.01;
            const tokensToMint = eur / manualMintTokenPrice;
            
            document.getElementById('summary-eur').textContent = `€${eur.toFixed(2)}`;
            document.getElementById('summary-fee').textContent = `€${fee.toFixed(2)}`;
            document.getElementById('summary-tokens').textContent = `${tokensToMint.toFixed(2)} VIP`;
        }

        async function submitManualMint(event) {
            event.preventDefault();
            
            const wallet = document.getElementById('mint-wallet').value.trim();
            const eurAmount = parseFloat(document.getElementById('mint-eur').value);
            const tokenAmount = eurAmount / manualMintTokenPrice;
            
            const errorDiv = document.getElementById('mint-error');
            const successDiv = document.getElementById('mint-success');
            const submitBtn = document.getElementById('mint-submit-btn');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Minting...';
            
            try {
                const response = await fetch('/api/presale/admin/manual-mint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        walletAddress: wallet,
                        eurAmount: eurAmount
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Mint failed');
                }
                
                successDiv.innerHTML = `
                    ✅ Successfully minted ${data.tokenAmount.toFixed(2)} VIP to ${wallet.slice(0,6)}...${wallet.slice(-4)}<br>
                    <a href="${EXPLORER_URL}/tx/${data.txHash}" target="_blank" class="gold-text hover:underline">
                        View TX: ${data.txHash.slice(0,10)}...
                    </a>
                `;
                successDiv.classList.remove('hidden');
                
                document.getElementById('manual-mint-form').reset();
                updateMintSummary();
                loadManualMints();
                
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Mint Tokens';
            }
        }

        async function loadManualMints() {
            const container = document.getElementById('manual-mints-list');
            
            try {
                const response = await fetch('/api/presale/admin/manual-mints', { credentials: 'include' });
                const data = await response.json();
                
                if (!data.mints || data.mints.length === 0) {
                    container.innerHTML = '<p class="text-white/40 text-sm text-center py-4">No manual mints yet</p>';
                    return;
                }
                
                container.innerHTML = data.mints.map(mint => `
                    <div class="p-4 bg-white/5 rounded-lg border border-white/10">
                        <div class="flex justify-between items-start mb-2">
                            <span class="gold-text font-bold">${parseFloat(mint.token_amount).toFixed(2)} VIP</span>
                            <span class="text-xs text-white/40">${new Date(mint.created_at).toLocaleDateString()}</span>
                        </div>
                        <p class="text-sm text-white/80 font-mono truncate" title="${mint.wallet_address}">
                            To: ${mint.wallet_address.slice(0,8)}...${mint.wallet_address.slice(-6)}
                        </p>
                        <p class="text-sm text-white/60">€${parseFloat(mint.eur_amount).toFixed(2)} received</p>
                        ${mint.mint_tx_hash ? `
                            <a href="${EXPLORER_URL}/tx/${mint.mint_tx_hash}" target="_blank" 
                            class="text-xs gold-text hover:underline mt-2 block">
                                TX: ${mint.mint_tx_hash.slice(0,10)}...
                            </a>
                        ` : ''}
                    </div>
                `).join('');
                
            } catch (error) {
                container.innerHTML = `<p class="text-red-400 text-sm text-center py-4">Error: ${error.message}</p>`;
            }
        }
        // ==========================================
        // INIT
        // ==========================================
        document.addEventListener('DOMContentLoaded', async () => {
            const session = await checkAdminSession();
            if (session) {
                loadRegistrants();
            }
        });
    </script>
</body>
</html>
