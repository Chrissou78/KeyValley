<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Sale - Kea Valley</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#D4AF37',
                        'primary-dark': '#B8960C',
                        'primary-light': '#E5C76B',
                        'background-dark': '#0a0a0a',
                        'surface': '#121212',
                        'surface-light': '#1a1a1a'
                    },
                    fontFamily: {
                        'serif': ['Cormorant Garamond', 'serif'],
                        'sans': ['Montserrat', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0a0a0a; color: #ffffff; font-family: 'Montserrat', sans-serif; }
        .glass-card { background: rgba(18, 18, 18, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(212, 175, 55, 0.1); }
        .glass-nav { background-color: rgba(18, 18, 18, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(212, 175, 55, 0.1); }
        .gold-text { color: #D4AF37; }
        .tooltip-content { visibility: hidden; opacity: 0; transition: all 0.2s ease; }
        .tooltip:hover .tooltip-content { visibility: visible; opacity: 1; }
        .gold-gradient { background: linear-gradient(135deg, #D4AF37 0%, #F4E5B0 50%, #D4AF37 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .btn-primary { background: linear-gradient(135deg, #D4AF37 0%, #B8960C 100%); color: #0a0a0a; font-weight: 600; transition: all 0.3s ease; }
        .btn-primary:hover:not(:disabled) { background: linear-gradient(135deg, #E5C76B 0%, #D4AF37 100%); transform: translateY(-2px); box-shadow: 0 10px 40px rgba(212, 175, 55, 0.3); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .input-field { background-color: #1a1a1a !important; border: 1px solid rgba(255, 255, 255, 0.1); color: #ffffff !important; transition: all 0.3s ease; }
        .input-field:focus { border-color: #D4AF37; outline: none; box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2); }
        .payment-option { background: rgba(26, 26, 26, 0.6); border: 2px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; cursor: pointer; }
        .payment-option:hover { border-color: rgba(212, 175, 55, 0.5); }
        .payment-option.selected { border-color: #D4AF37; background: rgba(212, 175, 55, 0.1); }
        .progress-bar { background: linear-gradient(90deg, #D4AF37 0%, #E5C76B 100%); transition: width 0.5s ease; }
        .overlay { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fee-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; background: rgba(212, 175, 55, 0.2); color: #D4AF37; }
        #card-element, .StripeElement { background-color: #1a1a1a !important; }
    </style>
</head>
<body class="min-h-screen">
    <header class="glass-nav fixed top-0 left-0 right-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="/" class="flex items-center space-x-3">
                    <img src="/logo.png" alt="Kea Valley" class="h-10 w-auto">
                    <span class="font-serif text-xl font-semibold gold-text">Kea Valley</span>
                </a>
                <nav class="hidden md:flex items-center space-x-8">
                    <a href="/" class="text-gray-300 hover:text-primary transition-colors">Home</a>
                    <a href="/presale/" class="text-gray-300 hover:text-primary transition-colors">Presale</a>
                    <a href="/presale/token-sale/" class="gold-text font-semibold">Token Sale</a>
                    <a href="/presale/packages/" class="text-gray-300 hover:text-primary transition-colors">Packages</a>
                    <a href="/profile" class="text-gray-300 hover:text-primary transition-colors">Profile</a>
                </nav>
                <div id="wallet-section">
                    <button id="connect-wallet-btn" onclick="connectWallet()" class="btn-primary px-6 py-2 rounded-lg text-sm">Connect Wallet</button>
                    <div id="wallet-connected" class="hidden flex items-center space-x-3">
                        <span id="wallet-address" class="text-gray-300 text-sm"></span>
                        <button onclick="disconnectWallet()" class="text-gray-400 hover:text-primary transition-colors">
                            <span class="material-symbols-outlined">logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="pt-24 pb-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-4xl mx-auto">
            <div class="text-center mb-8">
                <a href="/presale/" class="inline-flex items-center text-gray-400 hover:text-primary mb-4 transition-colors">
                    <span class="material-symbols-outlined mr-1">arrow_back</span>
                    Back to Presale
                </a>
                <h1 class="font-serif text-4xl md:text-5xl font-bold gold-gradient mb-4">Token Sale</h1>
                <p class="text-gray-400 text-lg max-w-2xl mx-auto">Purchase VIP tokens at ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬1.00 each. Each token equals ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬1 in services on Kea Island.</p>
            </div>

            <!-- Progress Bar -->
            <div class="glass-card rounded-2xl p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-400">Presale Progress</span>
                    <span id="progress-pct" class="gold-text font-semibold">0%</span>
                </div>
                <div class="w-full bg-surface-light rounded-full h-3 overflow-hidden">
                    <div id="progress-bar" class="progress-bar h-full rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-4 text-sm">
                    <span id="progress-raised" class="text-white font-semibold">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬0.00</span>
                    <span id="progress-target" class="text-gray-500">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬500,000</span>
                </div>
                <div class="text-center mt-3 text-xs text-gray-500">
                    <span id="tokens-sold">0</span> VIP tokens minted - Token Price: <span class="gold-text">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬1.00</span>
                </div>
            </div>

            <!-- Investment Amount -->
            <div class="glass-card rounded-2xl p-8 mb-8">
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-3">
                        <label class="block text-gray-300 text-sm font-medium">Investment Amount</label>
                        <div class="flex items-center space-x-2">
                            <div id="bonus-badge" class="hidden"></div>
                            <div id="bonus-info-tooltip" class="tooltip relative hidden">
                                <span class="material-symbols-outlined text-primary cursor-help text-lg">info</span>
                                <div class="tooltip-content absolute z-50 bg-surface border border-primary/30 rounded-xl p-4 w-64 right-0 top-6">
                                    <h4 class="text-white font-semibold text-sm mb-2">Volume Bonuses</h4>
                                    <div id="bonus-tooltip-list" class="text-xs text-gray-300 space-y-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-white/60 font-semibold pointer-events-none">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬</span>
                        <input type="number" id="eur-amount" min="10" step="1" value="100" class="input-field w-full pl-10 pr-20 py-4 rounded-xl text-lg" oninput="updateTotals()">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-white/40 font-semibold pointer-events-none">EUR</span>
                    </div>
                    <div class="flex justify-between mt-2">
                        <p class="text-gray-500 text-sm">Min: ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬<span id="min-purchase-display">10</span></p>
                        <p class="gold-text text-sm font-medium">= <span id="token-amount-display">100</span> VIP</p>
                    </div>
                </div>
            </div>

            <!-- Payment Section -->
            <div class="glass-card rounded-2xl p-8">
                <h2 class="font-serif text-xl font-bold text-white mb-6">Payment</h2>

                <!-- Payment Method -->
                <div class="mb-8">
                    <label class="block text-gray-300 text-sm font-medium mb-3">Payment Method</label>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="payment-option rounded-xl p-4 text-center selected" data-method="POL" onclick="selectPayment('POL')">
                            <span class="material-symbols-outlined text-3xl text-purple-400">hexagon</span>
                            <div class="font-semibold text-white mt-2">POL</div>
                            <div class="text-gray-500 text-xs mt-1">Polygon Native</div>
                            <div class="fee-badge mt-2">1.5% fee</div>
                        </div>
                        <div class="payment-option rounded-xl p-4 text-center" data-method="USDC" onclick="selectPayment('USDC')">
                            <span class="material-symbols-outlined text-3xl text-green-400">paid</span>
                            <div class="font-semibold text-white mt-2">USDC</div>
                            <div class="text-gray-500 text-xs mt-1">Stablecoin</div>
                            <div class="fee-badge mt-2">1.5% fee</div>
                        </div>
                        <div class="payment-option rounded-xl p-4 text-center" data-method="Card" onclick="selectPayment('Card')">
                            <span class="material-symbols-outlined text-3xl text-blue-400">credit_card</span>
                            <div class="font-semibold text-white mt-2">Card</div>
                            <div class="text-gray-500 text-xs mt-1">Credit/Debit</div>
                            <div class="fee-badge mt-2">4% fee</div>
                        </div>
                    </div>
                </div>

                <!-- Balance -->
                <div id="balance-section" class="mb-8 hidden">
                    <div class="flex items-center justify-between p-4 bg-surface-light rounded-xl">
                        <span class="text-gray-400">Your Balance:</span>
                        <span id="balance-display" class="font-semibold text-white">--</span>
                    </div>
                </div>

                <!-- Summary -->
                <div class="border-t border-white/10 pt-6 mb-8">
                    <div class="space-y-3">
                        <div class="flex justify-between text-gray-400"><span>Tokens</span><span id="totalTokensDisplay" class="text-white">100 VIP</span></div>
                        <div class="flex justify-between text-gray-400"><span>Token Price</span><span class="text-white">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬1.00 / VIP</span></div>
                        <div class="flex justify-between text-gray-400"><span>Subtotal</span><span id="subtotalEUR" class="text-white">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬100.00</span></div>
                        <div class="flex justify-between text-gray-400"><span>Payment Fee (<span id="feePercent">1.5</span>%)</span><span id="feeAmountEUR" class="text-white">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬1.50</span></div>
                        <div class="flex justify-between text-lg font-semibold border-t border-white/10 pt-3">
                            <span class="gold-text">Total</span>
                            <span class="gold-text"><span id="totalEUR">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬101.50</span><span id="totalUSD" class="text-sm text-gray-400 ml-2">($120.79)</span></span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-500"><span>You Pay (approx)</span><span id="cryptoEquivalent">~846.5 POL</span></div>
                    </div>
                </div>

                <!-- Bank Transfer -->
                <div class="mb-8 p-4 bg-surface-light rounded-xl border border-white/5">
                    <div class="flex items-start space-x-3">
                        <span class="material-symbols-outlined text-primary">account_balance</span>
                        <div><p class="text-gray-300 text-sm"><strong>Prefer bank transfer?</strong> Direct SEPA transfers are available. <a href="mailto:julie.meyer@vivapartners.net?subject=VIP%20Token%20Sale%20-%20SEPA%20Transfer" class="gold-text hover:underline">Contact us</a> for bank details.</p></div>
                    </div>
                </div>

                <!-- Buy Button -->
                <button id="buy-button" onclick="executePurchase()" class="btn-primary w-full py-4 rounded-xl text-lg font-semibold" disabled>Connect Wallet to Purchase</button>

                <!-- Referral -->
                <div id="referral-section" class="mt-6 hidden">
                    <div class="flex items-center space-x-2 p-3 bg-surface-light rounded-xl">
                        <span class="material-symbols-outlined text-primary">card_giftcard</span>
                        <span class="text-gray-400 text-sm">Referral Code:</span>
                        <span id="referral-code" class="gold-text font-semibold"></span>
                    </div>
                </div>
            </div>

            <!-- Contract Link -->
            <div class="mt-8 text-center">
                <a href="https://polygonscan.com/token/0x6860c34db140DB7B589DaDA38859a1d3736bbE3F" target="_blank" class="inline-flex items-center space-x-2 text-gray-400 hover:text-primary transition-colors">
                    <span class="material-symbols-outlined">open_in_new</span>
                    <span>View Contract on Polygonscan</span>
                </a>
            </div>
        </div>
    </main>

    <footer class="bg-surface py-12 border-t border-white/5">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center space-x-3 mb-6 md:mb-0">
                    <img src="/logo.png" alt="Kea Valley" class="h-8 w-auto">
                    <span class="font-serif text-lg gold-text">Kea Valley</span>
                </div>
                <div class="text-gray-500 text-sm">Ãƒâ€šÃ‚Â© 2025 Kea Valley. All rights reserved.</div>
            </div>
        </div>
    </footer>

    <!-- Overlays -->
    <div id="connect-overlay" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <span class="material-symbols-outlined text-5xl gold-text mb-4">account_balance_wallet</span>
            <h3 class="text-2xl font-serif font-bold mb-4">Connect Your Wallet</h3>
            <p class="text-gray-400 mb-6">Connect your WalletTwo wallet to purchase tokens.</p>
            <button onclick="redirectToWalletTwo()" class="btn-primary w-full py-3 rounded-xl font-semibold mb-3">Connect with WalletTwo</button>
            <button onclick="hideConnectOverlay()" class="text-gray-400 hover:text-white transition-colors">Cancel</button>
        </div>
    </div>

    <div id="processing-overlay" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <div class="animate-spin w-16 h-16 border-4 border-primary border-t-transparent rounded-full mx-auto mb-6"></div>
            <h3 class="text-2xl font-serif font-bold mb-4">Processing Purchase</h3>
            <p id="processing-message" class="text-gray-400">Verifying your payment...</p>
        </div>
    </div>

    <div id="result-overlay" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <span id="result-icon" class="material-symbols-outlined text-5xl mb-4"></span>
            <h3 id="result-title" class="text-2xl font-serif font-bold mb-4"></h3>
            <p id="result-message" class="text-gray-400 mb-6"></p>
            <div id="result-details" class="text-left mb-6 hidden">
                <div class="bg-surface-light rounded-xl p-4 space-y-3">
                    <div class="flex justify-between"><span class="text-gray-400">Tokens:</span><span id="result-tokens" class="text-white font-semibold"></span></div>
                    <div class="flex justify-between"><span class="text-gray-400">TX:</span><a id="result-tx" href="#" target="_blank" class="gold-text hover:underline truncate ml-2"></a></div>
                </div>
            </div>
            <button onclick="hideResultOverlay()" class="btn-primary w-full py-3 rounded-xl font-semibold">Continue</button>
        </div>
    </div>

    <div id="stripe-modal" class="fixed inset-0 overlay z-50 hidden flex items-center justify-center">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-serif font-bold">Complete Payment</h3>
                <button onclick="closeStripeModal()" class="text-gray-400 hover:text-white"><span class="material-symbols-outlined">close</span></button>
            </div>
            <div class="bg-surface-light rounded-xl p-4 mb-6">
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between"><span class="text-gray-400">VIP Tokens</span><span id="stripe-tokens" class="text-white">100 VIP</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Subtotal</span><span id="stripe-subtotal" class="text-white">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬100.00</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Fee (4%)</span><span id="stripe-fee" class="text-white">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬4.00</span></div>
                    <div class="flex justify-between font-semibold border-t border-white/10 pt-2 mt-2"><span class="gold-text">Total</span><span id="stripe-total" class="gold-text">ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬104.00</span></div>
                </div>
            </div>
            <form id="stripe-form">
                <div id="card-element" class="input-field p-4 rounded-xl mb-4"></div>
                <div id="card-errors" class="text-red-500 text-sm mb-4 hidden"></div>
                <button type="submit" id="stripe-submit" class="btn-primary w-full py-3 rounded-xl font-semibold">Pay ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬<span id="stripe-amount">104.00</span></button>
            </form>
        </div>
    </div>

    <script>
    const CONFIG = {
        tokenAddress: '0x6860c34db140DB7B589DaDA38859a1d3736bbE3F',
        usdcAddress: '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359',
        usdtAddress: '0xc2132D05D31c914a87C6611C10748AEb04B58e8F',
        chainId: 137,
        explorer: 'https://polygonscan.com',
        walletTwoOrigin: 'https://wallet.wallettwo.com',
        minterWallet: '0xdD4104A780142EfB9566659f26d3317714a81510',
        tokenPriceEUR: 1.00,
        eurUsdRate: 1.19,
        polPrice: 0.12,
        presaleEnabled: true,
        presaleWallet: null,
        minPurchase: 10,
        cryptoFeePercent: 1.5,
        cardFeePercent: 4,
        bonusTiers: [],
        eurRaised: 0,
        saleTargetEUR: 500000,
        tokensSold: 0
    };

    let currentWallet = null;
    let selectedPayment = 'POL';
    let balances = { POL: 0, USDC: 0, USDT: 0 };
    let stripe = null;
    let cardElement = null;
    let sessionData = null;

    function safeEl(id) { return document.getElementById(id); }
    function safeText(id, text) { const e = safeEl(id); if (e) e.textContent = text; }
    function safeHtml(id, html) { const e = safeEl(id); if (e) e.innerHTML = html; }
    function safeStyle(id, prop, val) { const e = safeEl(id); if (e && e.style) e.style[prop] = val; }
    function safeClass(id, action, cls) { const e = safeEl(id); if (e) e.classList[action](cls); }

    document.addEventListener('DOMContentLoaded', async () => {
        await loadPresaleConfig();
        checkWalletConnection();
        checkUrlParams();
    });

    async function loadPresaleConfig() {
        try {
            const [configRes, tiersRes] = await Promise.all([
                fetch('/api/presale/config'),
                fetch('/api/presale/bonus-tiers').catch(() => ({ json: () => ({ tiers: [] }) }))
            ]);
            const config = await configRes.json();
            const tiersData = await tiersRes.json();
            
            Object.assign(CONFIG, {
                tokensSold: config.tokensSold || 0,
                tokenPriceEUR: config.tokenPrice || 1.00,
                eurUsdRate: config.eurUsdRate || 1.19,
                polPrice: config.polPrice || 0.12,
                presaleEnabled: config.presaleEnabled !== false,
                presaleWallet: config.presaleWallet || '',
                minPurchase: config.minPurchase || 10,
                stripePublicKey: config.stripePublicKey || '',
                eurRaised: config.eurRaised || 0,
                saleTargetEUR: config.saleTargetEUR || 500000,
                bonusTiers: tiersData.tiers || []
            });
            
            updateProgress();
            updateTotals();
            displayBonusTiers();
            initStripe();
        } catch (error) {
            console.error('Config load error:', error);
        }
    }

    function updateProgress() {
        const pct = CONFIG.saleTargetEUR > 0 ? (CONFIG.eurRaised / CONFIG.saleTargetEUR) * 100 : 0;
        safeStyle('progress-bar', 'width', Math.min(pct, 100) + '%');
        safeText('progress-pct', pct.toFixed(2) + '%');
        safeText('progress-raised', 'ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬' + CONFIG.eurRaised.toLocaleString(undefined, {minimumFractionDigits: 2}));
        safeText('progress-target', 'ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬' + CONFIG.saleTargetEUR.toLocaleString());
        safeText('tokens-sold', CONFIG.tokensSold.toLocaleString());
    }

    function displayBonusTiers() {
        if (CONFIG.bonusTiers?.length > 0) {
            safeClass('bonus-info-tooltip', 'remove', 'hidden');
            const html = CONFIG.bonusTiers.sort((a, b) => a.min_eur - b.min_eur)
                .map(t => '<div>ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬' + parseFloat(t.min_eur).toLocaleString() + '+ ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢ <span class="text-green-400">+' + t.bonus_percent + '%</span></div>').join('');
            safeHtml('bonus-tooltip-list', html);
        } else {
            safeClass('bonus-info-tooltip', 'add', 'hidden');
        }
    }

    function updateTotals() {
        const eurInput = safeEl('eur-amount');
        const eurAmount = eurInput ? parseFloat(eurInput.value) || 0 : 0;
        const baseTokens = Math.floor(eurAmount / CONFIG.tokenPriceEUR);
        
        let bonusPercent = 0, bonusTokens = 0;
        if (CONFIG.bonusTiers?.length > 0) {
            const tier = [...CONFIG.bonusTiers].filter(t => parseFloat(t.min_eur) <= eurAmount).sort((a,b) => b.min_eur - a.min_eur)[0];
            if (tier) { bonusPercent = parseFloat(tier.bonus_percent); bonusTokens = Math.floor(baseTokens * bonusPercent / 100); }
        }
        const totalTokens = baseTokens + bonusTokens;
        
        if (bonusTokens > 0) {
            safeHtml('token-amount-display', totalTokens.toLocaleString() + ' <span class="text-green-400 text-xs">(+' + bonusTokens + ' bonus)</span>');
            const badge = safeEl('bonus-badge');
            if (badge) { badge.innerHTML = '<span class="bg-green-500/20 text-green-400 px-2 py-1 rounded-full text-xs">+' + bonusPercent + '% BONUS</span>'; badge.classList.remove('hidden'); }
        } else {
            safeText('token-amount-display', totalTokens.toLocaleString());
            safeClass('bonus-badge', 'add', 'hidden');
        }
        
        const feePercent = selectedPayment === 'Card' ? CONFIG.cardFeePercent : CONFIG.cryptoFeePercent;
        const feeEUR = eurAmount * (feePercent / 100);
        const totalEUR = eurAmount + feeEUR;
        const totalUSD = totalEUR * CONFIG.eurUsdRate;
        const polAmount = totalUSD / CONFIG.polPrice;
        
        safeText('totalTokensDisplay', totalTokens.toLocaleString() + ' VIP');
        safeText('subtotalEUR', 'ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬' + eurAmount.toFixed(2));
        safeText('feePercent', feePercent.toString());
        safeText('feeAmountEUR', 'ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬' + feeEUR.toFixed(2));
        safeText('totalEUR', 'ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬' + totalEUR.toFixed(2));
        safeText('totalUSD', '($' + totalUSD.toFixed(2) + ')');
        
        if (selectedPayment === 'POL') safeText('cryptoEquivalent', '~' + polAmount.toFixed(2) + ' POL');
        else if (selectedPayment === 'USDC') safeText('cryptoEquivalent', '~' + totalUSD.toFixed(2) + ' USDC');
        else if (selectedPayment === 'USDT') safeText('cryptoEquivalent', '~' + totalUSD.toFixed(2) + ' USDT');
        else safeText('cryptoEquivalent', 'ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬' + totalEUR.toFixed(2));
        
        window.currentPurchase = { eurAmount, baseTokens, bonusTokens, totalTokens, feeEUR, totalEUR, totalUSD, polAmount };
        updateBuyButton();
    }

    function selectPayment(method) {
        selectedPayment = method;
        document.querySelectorAll('.payment-option').forEach(el => el.classList.toggle('selected', el.dataset.method === method));
        updateBalanceDisplay();
        updateTotals();
    }

    function updateBalanceDisplay() {
        if (selectedPayment === 'POL') safeText('balance-display', balances.POL.toFixed(4) + ' POL');
        else if (selectedPayment === 'USDC') safeText('balance-display', balances.USDC.toFixed(2) + ' USDC');
        else if (selectedPayment === 'USDT') safeText('balance-display', balances.USDT.toFixed(2) + ' USDT');
        else safeText('balance-display', '--');
    }

    function updateBuyButton() {
        const btn = safeEl('buy-button');
        if (!btn) return;
        const p = window.currentPurchase || {};
        
        if (!currentWallet) { btn.textContent = 'Connect Wallet to Purchase'; btn.disabled = true; return; }
        if (!CONFIG.presaleEnabled) { btn.textContent = 'Presale Not Active'; btn.disabled = true; return; }
        if (p.eurAmount < CONFIG.minPurchase) { btn.textContent = 'Minimum ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬' + CONFIG.minPurchase; btn.disabled = true; return; }
        
        if (selectedPayment === 'Card') { btn.textContent = 'Pay ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬' + p.totalEUR.toFixed(2); btn.disabled = false; }
        else if (selectedPayment === 'POL') {
            if (balances.POL >= p.polAmount) { btn.textContent = 'Pay ~' + p.polAmount.toFixed(2) + ' POL'; btn.disabled = false; }
            else { btn.textContent = 'Insufficient POL'; btn.disabled = true; }
        } else if (selectedPayment === 'USDC' || selectedPayment === 'USDT') {
            const tokenAddr = selectedPayment === 'USDC' ? CONFIG.usdcAddress : CONFIG.usdtAddress;
            if (balances.USDC >= p.totalUSD) { btn.textContent = 'Pay ~' + p.totalUSD.toFixed(2) + ' USDC'; btn.disabled = false; }
            else { btn.textContent = 'Insufficient USDC'; btn.disabled = true; }
        }
    }

    function checkWalletConnection() {
        const params = new URLSearchParams(window.location.search);
        const walletFromUrl = params.get('wlt') || params.get('wallet') || params.get('address');
        
        if (walletFromUrl) {
            currentWallet = walletFromUrl.toLowerCase();
            sessionData = { wallet: currentWallet, timestamp: Date.now() };
            localStorage.setItem('keavalley_profile', JSON.stringify(sessionData));
            window.history.replaceState({}, document.title, window.location.pathname);
            showWalletConnected();
            loadBalances();
            return;
        }
        
        const profileStr = localStorage.getItem('keavalley_profile') || sessionStorage.getItem('keavalley_profile');
        if (profileStr) {
            try {
                sessionData = JSON.parse(profileStr);
                const wallet = sessionData.wallet || sessionData.walletAddress || sessionData.address;
                if (wallet && Date.now() - (sessionData.timestamp || 0) < 86400000) {
                    currentWallet = wallet.toLowerCase();
                    showWalletConnected();
                    loadBalances();
                    return;
                }
            } catch (e) {}
        }
        updateBuyButton();
    }

    function connectWallet() { safeClass('connect-overlay', 'remove', 'hidden'); }
    function hideConnectOverlay() { safeClass('connect-overlay', 'add', 'hidden'); }
    
    function redirectToWalletTwo() {
        const uri = encodeURIComponent(window.location.origin + '/presale/token-sale/');
        window.location.href = CONFIG.walletTwoOrigin + '/auth/login?companyId=6a27c2f8-894c-46c7-bf9f-f5af11d4e092&action=signature&message=VIP_PRESALE&redirect_uri=' + uri;
    }

    function showWalletConnected() {
        if (!currentWallet) return;
        safeClass('connect-wallet-btn', 'add', 'hidden');
        safeClass('wallet-connected', 'remove', 'hidden');
        safeText('wallet-address', currentWallet.slice(0, 6) + '...' + currentWallet.slice(-4));
        safeClass('balance-section', 'remove', 'hidden');
        updateBuyButton();
    }

    function disconnectWallet() {
        localStorage.removeItem('keavalley_profile');
        sessionStorage.removeItem('keavalley_profile');
        currentWallet = null;
        safeClass('connect-wallet-btn', 'remove', 'hidden');
        safeClass('wallet-connected', 'add', 'hidden');
        safeClass('balance-section', 'add', 'hidden');
        updateBuyButton();
    }

    async function loadBalances() {
        if (!currentWallet) return;
        const rpcs = ['https://polygon-bor-rpc.publicnode.com', 'https://polygon.llamarpc.com', 'https://polygon-rpc.com'];
        for (const rpc of rpcs) {
            try {
                const provider = new ethers.JsonRpcProvider(rpc);
                balances.POL = parseFloat(ethers.formatEther(await provider.getBalance(currentWallet)));
                const usdc = new ethers.Contract(CONFIG.usdcAddress, ['function balanceOf(address) view returns (uint256)'], provider);
                balances.USDC = parseFloat(ethers.formatUnits(await usdc.balanceOf(currentWallet), 6));
                updateBalanceDisplay();
                updateBuyButton();
                return;
            } catch (e) {}
        }
    }

    async function executePurchase() {
        if (!currentWallet) { connectWallet(); return; }
        const p = window.currentPurchase || {};
        if (p.eurAmount < CONFIG.minPurchase) { showResult('error', 'Invalid Amount', 'Minimum ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬' + CONFIG.minPurchase); return; }
        
        localStorage.setItem('pendingPurchase', JSON.stringify({ ...p, walletAddress: currentWallet, paymentMethod: selectedPayment, timestamp: Date.now() }));
        
        if (selectedPayment === 'Card') {
            if (!stripe) { showResult('error', 'Error', 'Card payments not configured.'); return; }
            openStripeCheckout(p.baseTokens, p.eurAmount, p.feeEUR, p.totalEUR);
        } else {
            executeCryptoPurchase(p.baseTokens, p.totalUSD, p.eurAmount, p.feeEUR);
        }
    }

    function executeCryptoPurchase(tokenAmount, totalUSD, baseEUR, feeEUR) {
        if (!CONFIG.presaleWallet) { showResult('error', 'Error', 'Presale wallet not configured.'); return; }
        const baseUSD = baseEUR * CONFIG.eurUsdRate;
        const feeUSD = feeEUR * CONFIG.eurUsdRate;
        const redirectUri = encodeURIComponent(window.location.origin + '/presale/token-sale/?purchase=complete');
        let transactions;
        
        if (selectedPayment === 'USDC' || selectedPayment === 'USDT') {
            const tokenAddr = selectedPayment === 'USDC' ? CONFIG.usdcAddress : CONFIG.usdtAddress;
            transactions = [
                { type: 'erc20_transfer', token: tokenAddr, to: CONFIG.presaleWallet, amount: Math.floor(baseUSD * 1e6).toString(), description: 'VIP Presale' },
                { type: 'erc20_transfer', token: tokenAddr, to: CONFIG.minterWallet, amount: Math.ceil(feeUSD * 1e6).toString(), description: 'Fee' }
            ];
        } else {
            const basePOL = baseUSD / CONFIG.polPrice;
            const feePOL = feeUSD / CONFIG.polPrice;
            transactions = [
                { type: 'native_transfer', to: CONFIG.presaleWallet, amount: BigInt(Math.floor(basePOL * 1e18)).toString(), description: 'VIP Presale' },
                { type: 'native_transfer', to: CONFIG.minterWallet, amount: BigInt(Math.ceil(feePOL * 1e18)).toString(), description: 'Fee' }
            ];
        }
        
        const txData = encodeURIComponent(JSON.stringify({ chainId: CONFIG.chainId, transactions, metadata: { type: 'token_sale', tokenAmount, totalUSD, baseEUR, feeEUR } }));
        window.location.href = CONFIG.walletTwoOrigin + '/transaction/multi?data=' + txData + '&external_id=presale-' + Date.now() + '&redirect_uri=' + redirectUri;
    }

    function initStripe() {
        if (!CONFIG.stripePublicKey || typeof Stripe === 'undefined') return;
        stripe = Stripe(CONFIG.stripePublicKey);
        const elements = stripe.elements();
        cardElement = elements.create('card', { hidePostalCode: true, style: { base: { color: '#fff', fontFamily: 'Montserrat', fontSize: '16px', '::placeholder': { color: '#6b7280' } } } });
        cardElement.mount('#card-element');
        
        cardElement.on('change', (e) => {
            const btn = safeEl('stripe-submit');
            const err = safeEl('card-errors');
            if (e.error) { if (err) { err.textContent = e.error.message; err.classList.remove('hidden'); } if (btn) btn.disabled = true; }
            else { if (err) err.classList.add('hidden'); if (btn) btn.disabled = !e.complete; }
        });
        
        safeEl('stripe-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = safeEl('stripe-submit');
            if (btn) { btn.disabled = true; btn.textContent = 'Processing...'; }
            const paymentData = JSON.parse(localStorage.getItem('stripePaymentData') || '{}');
            if (!paymentData.clientSecret) { showResult('error', 'Error', 'Session expired.'); closeStripeModal(); return; }
            
            try {
                const { error, paymentIntent } = await stripe.confirmCardPayment(paymentData.clientSecret, { payment_method: { card: cardElement } });
                if (error) { safeEl('card-errors').textContent = error.message; safeEl('card-errors').classList.remove('hidden'); if (btn) { btn.disabled = false; btn.textContent = 'Pay ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬' + paymentData.totalEUR; } return; }
                if (paymentIntent.status === 'succeeded') { closeStripeModal(); showProcessing('Payment successful! Minting tokens...'); verifyStripePayment(paymentIntent.id, paymentData.tokenAmount); }
            } catch (err) { showResult('error', 'Error', err.message); closeStripeModal(); }
        });
    }

    function openStripeCheckout(tokenAmount, baseEUR, feeEUR, totalEUR) {
        safeText('stripe-tokens', tokenAmount + ' VIP');
        safeText('stripe-subtotal', 'ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬' + baseEUR.toFixed(2));
        safeText('stripe-fee', 'ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬' + feeEUR.toFixed(2));
        safeText('stripe-total', 'ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬' + totalEUR.toFixed(2));
        safeText('stripe-amount', totalEUR.toFixed(2));
        if (cardElement) cardElement.clear();
        safeClass('stripe-modal', 'remove', 'hidden');
        createPaymentIntent(tokenAmount, totalEUR);
    }

    async function createPaymentIntent(tokenAmount, totalEUR) {
        try {
            const res = await fetch('/api/presale/create-payment-intent', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ walletAddress: currentWallet, tokenAmount, totalEUR, purchaseType: 'token_sale' })
            });
            const data = await res.json();
            localStorage.setItem('stripePaymentData', JSON.stringify({ clientSecret: data.clientSecret, paymentIntentId: data.paymentIntentId, tokenAmount, totalEUR }));
        } catch (e) { showResult('error', 'Error', 'Failed to initialize payment.'); closeStripeModal(); }
    }

    function closeStripeModal() { safeClass('stripe-modal', 'add', 'hidden'); localStorage.removeItem('stripePaymentData'); if (cardElement) cardElement.clear(); }

    async function verifyStripePayment(paymentIntentId, tokenAmount) {
        for (let i = 0; i < 60; i++) {
            try {
                const res = await fetch('/api/presale/purchase-status/' + paymentIntentId);
                const data = await res.json();
                if (data.status === 'completed') { hideProcessing(); showResult('success', 'Purchase Complete!', data.totalTokens + ' VIP tokens purchased!', { tokens: data.totalTokens, tx: data.mintTxHash }); localStorage.removeItem('pendingPurchase'); loadPresaleConfig(); return; }
                if (data.status === 'failed') { hideProcessing(); showResult('error', 'Failed', data.error); return; }
            } catch (e) {}
            await new Promise(r => setTimeout(r, 1000));
        }
        hideProcessing();
        showResult('info', 'Processing', 'Payment received. Tokens will arrive shortly.');
    }

    function checkUrlParams() {
        const params = new URLSearchParams(window.location.search);
        if (params.get('purchase') === 'complete') {
            const txHash = params.get('tx_hash');
            if (txHash) { showProcessing('Verifying payment...'); verifyCryptoPayment(txHash); }
        }
        const ref = params.get('ref');
        if (ref) localStorage.setItem('referralCode', ref);
    }

    async function verifyCryptoPayment(txHash) {
        try {
            const pending = JSON.parse(localStorage.getItem('pendingPurchase') || '{}');
            const res = await fetch('/api/presale/verify-payment', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ txHash, walletAddress: currentWallet, tokenAmount: pending.baseTokens, totalEUR: pending.totalEUR, paymentMethod: pending.paymentMethod, purchaseType: 'token_sale' })
            });
            const data = await res.json();
            hideProcessing();
            if (data.success) { showResult('success', 'Complete!', data.message, { tokens: data.totalTokens, tx: data.mintTxHash || txHash }); localStorage.removeItem('pendingPurchase'); loadPresaleConfig(); }
            else showResult('error', 'Failed', data.error);
            window.history.replaceState({}, document.title, window.location.pathname);
        } catch (e) { hideProcessing(); showResult('error', 'Error', e.message); }
    }

    function showProcessing(msg) { safeText('processing-message', msg); safeClass('processing-overlay', 'remove', 'hidden'); }
    function hideProcessing() { safeClass('processing-overlay', 'add', 'hidden'); }
    function showResult(type, title, message, details) {
        const icon = safeEl('result-icon');
        if (icon) { icon.textContent = type === 'success' ? 'check_circle' : type === 'info' ? 'info' : 'error'; icon.className = 'material-symbols-outlined text-5xl mb-4 ' + (type === 'success' ? 'text-green-500' : type === 'info' ? 'text-blue-500' : 'text-red-500'); }
        safeText('result-title', title);
        safeText('result-message', message);
        if (details) { safeClass('result-details', 'remove', 'hidden'); safeText('result-tokens', details.tokens + ' VIP'); if (details.tx) { const el = safeEl('result-tx'); if (el) { el.href = CONFIG.explorer + '/tx/' + details.tx; el.textContent = details.tx.slice(0,10) + '...'; } } }
        else safeClass('result-details', 'add', 'hidden');
        safeClass('result-overlay', 'remove', 'hidden');
    }
    function hideResultOverlay() { safeClass('result-overlay', 'add', 'hidden'); }

    window.addEventListener('message', (e) => {
        if (!e.origin.includes('wallettwo.com')) return;
        const wallet = e.data?.wallet || e.data?.wlt || e.data?.address;
        if (wallet) { currentWallet = wallet.toLowerCase(); sessionData = { wallet: currentWallet, timestamp: Date.now() }; localStorage.setItem('keavalley_profile', JSON.stringify(sessionData)); showWalletConnected(); loadBalances(); }
    });
    </script>
</body>
</html>