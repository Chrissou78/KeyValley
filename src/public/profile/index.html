<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Kea Valley</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%); min-height: 100vh; }
        .glass-card {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .gold-gradient { background: linear-gradient(135deg, #ee9d2b 0%, #d4a543 100%); }
        .gold-text { color: #ee9d2b; }
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(26, 26, 26, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 0.75rem;
        }
        .loading-overlay.hidden { display: none; }
        .btn-gold {
            background: linear-gradient(135deg, #ee9d2b 0%, #d4a543 100%);
            color: #000 !important;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn-gold:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(238, 157, 43, 0.4);
        }
        .btn-outline {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn-outline:hover {
            border-color: #ee9d2b;
            color: #ee9d2b;
        }
        
        /* PRESALE BANNER - HIGHLY VISIBLE */
        .presale-banner {
            background: linear-gradient(135deg, rgba(238, 157, 43, 0.2) 0%, rgba(212, 165, 67, 0.15) 100%);
            border: 2px solid rgba(238, 157, 43, 0.5);
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0%, 100% { border-color: rgba(238, 157, 43, 0.5); }
            50% { border-color: rgba(238, 157, 43, 0.9); }
        }
        
        .wallet-info {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
        }
        #debug-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.95);
            color: #0f0;
            padding: 10px;
            font-size: 11px;
            max-width: 400px;
            max-height: 300px;
            overflow: auto;
            z-index: 9999;
            border-radius: 4px;
            display: none;
            font-family: monospace;
        }
        #debug-panel.visible { display: block; }
    </style>
</head>
<body class="text-white">
    <!-- Header -->
    <header class="glass-card border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <a href="/" class="text-xl font-bold gold-text">KEA VALLEY¬Æ</a>
            <nav class="flex items-center gap-4">
                <a href="/" class="text-white/60 hover:text-white transition">Home</a>
                <a href="/claim" class="text-white/60 hover:text-white transition">Claim</a>
                <a href="/presale" class="btn-gold text-sm">Join Presale</a>
            </nav>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-12">
        <!-- Page Title -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">My Profile</h1>
            <p class="text-white/60">View your WalletTwo balance and manage your VIP tokens</p>
        </div>

        <!-- ============================================ -->
        <!-- PRESALE BANNER - ALWAYS VISIBLE - NOT HIDDEN -->
        <!-- ============================================ -->
        <div class="presale-banner rounded-xl p-6 mb-8">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-2xl">üöÄ</span>
                        <h3 class="text-xl font-bold gold-text">VIP Token Presale Now Live!</h3>
                    </div>
                    <p class="text-white/70 text-sm mb-2">Get VIP tokens at the best price. Pay with Card, POL, or USDC.</p>
                    <ul class="text-white/60 text-xs space-y-1">
                        <li>‚úì $0.10 per VIP token</li>
                        <li>‚úì Min 10 tokens, Max 10,000 tokens</li>
                        <li>‚úì Instant delivery to your wallet</li>
                    </ul>
                    <div id="presaleWalletInfo" class="mt-3 hidden">
                        <span class="text-white/50 text-sm">Connected: </span>
                        <span id="presaleWalletAddress" class="wallet-info text-sm text-green-400"></span>
                    </div>
                </div>
                <div class="flex flex-col gap-2">
                    <a href="/presale" class="btn-gold whitespace-nowrap text-lg px-8 py-3">
                        üéØ Join Presale ‚Üí
                    </a>
                    <span class="text-center text-white/40 text-xs">Limited time offer</span>
                </div>
            </div>
        </div>

        <!-- Quick Links -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <a href="/" class="btn-outline text-center">‚Üê Home</a>
            <a href="/claim" class="btn-outline text-center">Claim Free</a>
            <a href="/presale" class="btn-outline text-center gold-text border-[#ee9d2b]/50">üí∞ Presale</a>
            <a href="https://wallet.wallettwo.com/wallet/dashboard?tab=Tokens&companyId=6a27c2f8-894c-46c7-bf9f-f5af11d4e092" target="_blank" class="btn-outline text-center">WalletTwo ‚Üí</a>
        </div>

        <!-- Info Banner -->
        <div class="glass-card rounded-xl p-4 mb-6 border-l-4 border-blue-500">
            <div class="flex items-start gap-3">
                <svg class="w-6 h-6 text-blue-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <p class="text-white/80">Log in to WalletTwo below to view your VIP token balance.</p>
                    <p class="text-white/60 text-sm mt-1">
                        Don't have an account? 
                        <a href="https://wallet.wallettwo.com/auth/register?companyId=6a27c2f8-894c-46c7-bf9f-f5af11d4e092" target="_blank" class="gold-text hover:underline">Register here ‚Üí</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Wallet Status Panel (shown when connected) -->
        <div id="walletStatusPanel" class="glass-card rounded-xl p-4 mb-6 hidden">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="text-white/80">Wallet Connected</span>
                </div>
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4">
                    <span id="connectedEmail" class="text-blue-400 text-sm"></span>
                    <span id="connectedAddress" class="wallet-info text-sm text-green-400"></span>
                </div>
            </div>
        </div>

        <!-- WalletTwo Dashboard Card -->
        <div class="glass-card rounded-xl overflow-hidden">
            <div class="p-4 border-b border-white/10 flex items-center justify-between">
                <h2 class="font-semibold flex items-center gap-2">
                    <svg class="w-5 h-5 gold-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                    WalletTwo Dashboard
                </h2>
                <a href="https://wallet.wallettwo.com/wallet/dashboard?tab=Tokens&companyId=6a27c2f8-894c-46c7-bf9f-f5af11d4e092" target="_blank" class="text-sm text-white/40 hover:text-white/80 transition">
                    Open in new tab ‚Üí
                </a>
            </div>
            <div class="relative" style="min-height: 500px;">
                <!-- Loading Overlay -->
                <div id="loadingOverlay" class="loading-overlay">
                    <div class="text-center">
                        <div class="animate-spin w-8 h-8 border-2 border-white/20 border-t-[#ee9d2b] rounded-full mx-auto mb-4"></div>
                        <p class="text-white/60">Loading WalletTwo...</p>
                    </div>
                </div>
                <!-- WalletTwo iframe -->
                <iframe 
                    id="walletTwoFrame"
                    src="https://wallet.wallettwo.com/wallet/dashboard?tab=Tokens&companyId=6a27c2f8-894c-46c7-bf9f-f5af11d4e092"
                    class="w-full border-0"
                    style="height: 500px;"
                    onload="hideLoading()"
                    allow="clipboard-write"
                ></iframe>
            </div>
        </div>
        
        <!-- Bottom CTA -->
        <div class="mt-8 text-center">
            <p class="text-white/50 mb-4">Ready to get more VIP tokens?</p>
            <a href="/presale" class="btn-gold text-lg px-10 py-4">
                üöÄ Join the Presale Now
            </a>
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-white/10 mt-16">
        <div class="max-w-7xl mx-auto px-4 py-6 text-center text-white/40 text-sm">
            &copy; 2025 KEA VALLEY¬Æ. All rights reserved.
        </div>
    </footer>

    <!-- Debug Panel -->
    <div id="debug-panel"></div>

    <script>
        // Configuration
        const WALLETTWO_ORIGIN = 'https://wallet.wallettwo.com';
        const STORAGE_KEYS = ['walletTwoSession', 'keavalley_profile', 'walletAddress', 'wallet_address', 'connectedWallet'];
        const DEBUG = new URLSearchParams(window.location.search).has('debug');
        let savedToDatabase = false;
        
        function debugLog(msg, data = null) {
            console.log(`[Profile] ${msg}`, data || '');
            if (!DEBUG) return;
            const panel = document.getElementById('debug-panel');
            panel.classList.add('visible');
            const line = document.createElement('div');
            line.style.borderBottom = '1px solid #333';
            line.style.padding = '4px 0';
            line.innerHTML = `<b>${msg}</b>${data ? ': ' + JSON.stringify(data).substring(0, 150) : ''}`;
            panel.appendChild(line);
            panel.scrollTop = panel.scrollHeight;
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.classList.add('hidden');
        }
        setTimeout(hideLoading, 5000);

        function isValidAddress(addr) {
            return addr && typeof addr === 'string' && /^0x[a-fA-F0-9]{40}$/i.test(addr);
        }

        function formatAddress(addr) {
            if (!addr || addr.length < 10) return addr || '';
            return `${addr.substring(0, 6)}...${addr.substring(addr.length - 4)}`;
        }

        function updateWalletUI(address, email = null) {
            if (!isValidAddress(address)) return;
            debugLog('Updating UI', { address, email });
            
            // Update presale wallet info
            const presaleWalletInfo = document.getElementById('presaleWalletInfo');
            const presaleWalletAddress = document.getElementById('presaleWalletAddress');
            if (presaleWalletInfo && presaleWalletAddress) {
                presaleWalletAddress.textContent = formatAddress(address);
                presaleWalletInfo.classList.remove('hidden');
            }

            // Update status panel
            const statusPanel = document.getElementById('walletStatusPanel');
            const connectedAddress = document.getElementById('connectedAddress');
            const connectedEmail = document.getElementById('connectedEmail');
            if (statusPanel && connectedAddress) {
                connectedAddress.textContent = formatAddress(address);
                if (connectedEmail && email) {
                    connectedEmail.textContent = email;
                }
                statusPanel.classList.remove('hidden');
            }
        }

        async function saveWalletToDatabase(walletAddress, email = null) {
            if (!isValidAddress(walletAddress) || savedToDatabase) return;
            debugLog('Saving to DB', { walletAddress, email });
            
            try {
                const response = await fetch('/api/wallet/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ walletAddress, email, source: 'wallettwo' })
                });
                const result = await response.json();
                debugLog('DB result', result);
                if (result.success) savedToDatabase = true;
            } catch (error) {
                debugLog('DB error', error.message);
            }
        }

        function storeWalletData(address, email = null) {
            const data = { address, wallet: address, walletAddress: address, email, timestamp: Date.now() };
            try {
                localStorage.setItem('walletTwoSession', JSON.stringify(data));
                localStorage.setItem('walletAddress', address);
                localStorage.setItem('keavalley_profile', JSON.stringify({ ...data, connectedAt: new Date().toISOString() }));
            } catch (e) {}
        }

        function extractWalletData(data) {
            if (!data) return { address: null, email: null };
            
            let address = data.wallet || data.address || data.walletAddress || data.wallet_address || data.publicAddress;
            let email = data.email || data.userEmail || data.user_email;

            // Check nested objects
            const nested = [data.user, data.payload, data.result, data.data];
            for (const obj of nested) {
                if (obj && typeof obj === 'object') {
                    address = address || obj.wallet || obj.address || obj.walletAddress || obj.publicAddress;
                    email = email || obj.email || obj.userEmail;
                    if (obj.user) {
                        address = address || obj.user.wallet || obj.user.walletAddress;
                        email = email || obj.user.email;
                    }
                }
            }
            return { address, email };
        }

        function handleWalletConnected(address, email) {
            if (!isValidAddress(address)) return;
            debugLog('Wallet connected', { address, email });
            storeWalletData(address, email);
            updateWalletUI(address, email);
            saveWalletToDatabase(address, email);
        }

        // Listen for WalletTwo messages
        window.addEventListener('message', function(event) {
            if (!event.origin.includes('wallettwo.com')) return;
            debugLog('postMessage', event.data);
            
            const data = event.data;
            if (!data) return;

            const msgType = (data.type || data.event || data.action || '').toLowerCase();
            const isSuccess = ['auth_success', 'wallet_connected', 'login_success', 'authenticated'].some(t => msgType.includes(t))
                || data.success === true || data.authenticated === true;

            const { address, email } = extractWalletData(data);
            if (isValidAddress(address)) {
                handleWalletConnected(address, email);
            }
        });

        // Check existing wallet on load
        function checkExistingWallet() {
            for (const key of STORAGE_KEYS) {
                try {
                    const stored = localStorage.getItem(key) || sessionStorage.getItem(key);
                    if (!stored) continue;
                    
                    if (isValidAddress(stored)) {
                        updateWalletUI(stored);
                        return true;
                    }
                    
                    const data = JSON.parse(stored);
                    const timestamp = data.timestamp || data.connectedAt;
                    if (timestamp && (Date.now() - new Date(timestamp).getTime()) > 86400000) continue;
                    
                    const { address, email } = extractWalletData(data);
                    if (isValidAddress(address)) {
                        updateWalletUI(address, email);
                        return true;
                    }
                } catch (e) {}
            }
            return false;
        }

        document.addEventListener('DOMContentLoaded', checkExistingWallet);
        setTimeout(checkExistingWallet, 2000);
    </script>
</body>
</html>
