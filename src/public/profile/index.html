<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>My Profile | Kea Valley</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ee9d2b",
                        "primary-light": "#fbdea6",
                        "background-dark": "#0a0a0a",
                        "surface": "#121212",
                    },
                    fontFamily: {
                        "sans": ["Manrope", "sans-serif"],
                        "serif": ["Playfair Display", "serif"],
                    },
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Manrope', sans-serif; }
        h1, h2, h3, h4, .font-serif { font-family: 'Playfair Display', serif; }
        .gold-glow:hover {
            box-shadow: 0 0 25px rgba(238, 157, 43, 0.3);
            border-color: #ee9d2b;
        }
        .glass-nav {
            backdrop-filter: blur(12px);
            background-color: rgba(10, 10, 10, 0.7);
        }
        .login-iframe {
            width: 100%;
            height: 550px;
            border: none;
            border-radius: 4px;
            background: #fff;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #ee9d2b; }
    </style>
</head>
<body class="bg-background-dark text-white selection:bg-primary selection:text-background-dark antialiased min-h-screen flex flex-col">

    <!-- Header -->
    <header class="fixed top-0 w-full z-50 glass-nav border-b border-white/5">
        <div class="max-w-7xl mx-auto px-6 lg:px-12 flex items-center justify-between h-20 lg:h-24">
            <a href="/" class="flex items-center gap-4 group cursor-pointer">
                <div class="size-10 text-primary transition-transform duration-500 group-hover:rotate-180">
                    <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M44 4H30.6666V17.3334H17.3334V30.6666H4V44H44V4Z" fill="currentColor"></path>
                    </svg>
                </div>
                <div>
                    <h2 class="text-xl font-serif font-bold tracking-widest uppercase text-white">Kea Valley</h2>
                    <p class="text-[0.6rem] text-primary uppercase tracking-[0.3em] font-sans">Estates</p>
                </div>
            </a>
            <nav class="hidden md:flex items-center gap-8 lg:gap-12">
                <a class="text-xs font-bold tracking-widest hover:text-primary transition-colors uppercase" href="/">Home</a>
                <a class="text-xs font-bold tracking-widest hover:text-primary transition-colors uppercase" href="/#residences">Residences</a>
                <a class="text-xs font-bold tracking-widest hover:text-primary transition-colors uppercase" href="/#lifestyle">Lifestyle</a>
            </nav>
            <a href="https://wallet.wallettwo.com/auth/login?companyId=6a27c2f8-894c-46c7-bf9f-f5af11d4e092&action=signature&message=FREE_BONUS_TOKENS_KEA_VALLEY&redirect_uri=https://kea-valley.com/claim" class="hidden md:block bg-transparent border border-primary/30 text-primary px-6 lg:px-8 py-3 rounded-sm text-xs font-bold uppercase tracking-widest gold-glow transition-all hover:bg-primary hover:text-background-dark">
                Free Tokens
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 pt-32 pb-20 px-6">
        <div class="max-w-lg mx-auto">
            
            <!-- Page Title -->
            <div class="text-center mb-12">
                <div class="flex items-center justify-center gap-4 mb-6">
                    <div class="h-[1px] w-8 bg-primary"></div>
                    <span class="text-primary tracking-[0.3em] uppercase text-xs font-bold">Member Area</span>
                    <div class="h-[1px] w-8 bg-primary"></div>
                </div>
                <h1 class="text-4xl md:text-5xl font-serif italic font-medium text-white">My Profile</h1>
            </div>

            <!-- Card -->
            <div class="bg-surface border border-white/5 rounded-sm overflow-hidden">
                
                <!-- Card Header -->
                <div class="px-8 py-5 border-b border-white/5 flex items-center justify-between">
                    <h3 class="text-xs font-bold uppercase tracking-widest text-primary">WalletTwo Account</h3>
                    <span class="material-symbols-outlined text-primary/50">account_circle</span>
                </div>

                <!-- Card Content -->
                <div class="p-8">
                    
                    <!-- Login State -->
                    <div id="loginContainer" class="login-container">
                        <p class="text-slate-400 font-light text-center mb-6 text-sm">
                            Connect with WalletTwo to view your profile and VIP token balance.
                        </p>
                        <iframe 
                            id="walletTwoFrame"
                            class="login-iframe"
                            src="https://wallet.wallettwo.com/auth/login?action=auth&iframe=true"
                            title="WalletTwo Login"
                            allow="clipboard-write"
                        ></iframe>
                    </div>

                    <!-- Profile State -->
                    <div id="profileContainer" class="profile-container hidden">
                        
                        <!-- User Info -->
                        <div class="text-center mb-10">
                            <div id="userAvatar" class="w-24 h-24 bg-gradient-to-br from-primary to-primary/50 rounded-full flex items-center justify-center text-3xl font-serif font-bold text-background-dark mx-auto mb-5">
                                ?
                            </div>
                            <h4 id="userName" class="text-2xl font-serif text-white mb-1">Loading...</h4>
                            <p id="userEmail" class="text-sm text-slate-500"></p>
                        </div>

                        <!-- Wallet Address -->
                        <div class="bg-white/5 border border-white/5 rounded-sm p-5 mb-6">
                            <p class="text-[10px] font-bold uppercase tracking-widest text-slate-500 mb-3">Wallet Address</p>
                            <div class="flex items-center justify-between gap-3">
                                <code id="walletAddress" class="text-sm text-slate-300 font-light truncate flex-1">-</code>
                                <button onclick="copyAddress()" class="text-primary hover:text-primary-light transition-colors p-2">
                                    <span class="material-symbols-outlined text-lg">content_copy</span>
                                </button>
                            </div>
                        </div>

                        <!-- Balance Card -->
                        <div class="bg-gradient-to-br from-primary/10 to-transparent border border-primary/20 rounded-sm p-8 mb-8 text-center relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-primary/5 blur-3xl rounded-full"></div>
                            <p class="text-[10px] font-bold uppercase tracking-widest text-primary mb-4 relative z-10">VIP Token Balance</p>
                            <div id="balanceDisplay" class="relative z-10">
                                <span class="text-slate-400">Loading...</span>
                            </div>
                            <a id="explorerLink" href="#" target="_blank" class="inline-flex items-center gap-1 text-xs text-primary/70 hover:text-primary mt-5 transition-colors relative z-10">
                                View on Polygonscan
                                <span class="material-symbols-outlined text-sm">open_in_new</span>
                            </a>
                        </div>

                        <!-- Actions -->
                        <div class="space-y-4">
                            <a id="claimBtn" href="/claim" class="hidden w-full bg-primary text-background-dark px-8 py-4 rounded-sm font-bold uppercase tracking-widest text-xs text-center gold-glow hover:translate-y-[-2px] transition-transform items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-lg">redeem</span>
                                Claim Free Tokens
                            </a>
                            <button onclick="logout()" class="w-full border border-white/10 text-slate-500 px-8 py-4 rounded-sm font-bold uppercase tracking-widest text-xs hover:border-red-500/50 hover:text-red-400 transition-all">
                                Disconnect
                            </button>
                        </div>

                    </div>

                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-background-dark py-8 border-t border-white/5">
        <div class="max-w-7xl mx-auto px-6 lg:px-12">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <a href="/" class="flex items-center gap-2">
                    <div class="size-6 text-primary">
                        <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M44 4H30.6666V17.3334H17.3334V30.6666H4V44H44V4Z" fill="currentColor"></path>
                        </svg>
                    </div>
                    <span class="text-xs font-serif font-bold tracking-widest uppercase text-white">Kea Valley</span>
                </a>
                <div class="flex gap-6 text-slate-600 text-[0.6rem] tracking-widest font-bold uppercase">
                    <a class="hover:text-primary transition-colors" href="#">Privacy</a>
                    <a class="hover:text-primary transition-colors" href="#">Terms</a>
                </div>
                <div class="text-slate-600 text-xs font-light">
                    Â© 2026 Kea Valley
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Config
        const CONFIG = {
            VIP_TOKEN_ADDRESS: '0x6860c34db140DB7B589DaDA38859a1d3736bbE3F',
            POLYGON_RPC: 'https://polygon-mainnet.g.alchemy.com/v2/IoufBRdGO6MKWC6pxqbZW',
            POLYGON_EXPLORER: 'https://polygonscan.com',
            WALLETTWO_ORIGIN: 'https://wallet.wallettwo.com',
            STORAGE_KEY: 'keavalley_profile',
            MIN_BALANCE_TO_HIDE_CLAIM: 2
        };

        const ERC20_ABI = ['function balanceOf(address owner) view returns (uint256)'];
        let currentUser = null;
        let acceptMessages = true;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const stored = localStorage.getItem(CONFIG.STORAGE_KEY);
            if (stored) {
                try {
                    const user = JSON.parse(stored);
                    if (user.timestamp && (Date.now() - user.timestamp) < 24 * 60 * 60 * 1000) {
                        acceptMessages = false;
                        showProfile(user);
                    } else {
                        localStorage.removeItem(CONFIG.STORAGE_KEY);
                    }
                } catch (e) {
                    localStorage.removeItem(CONFIG.STORAGE_KEY);
                }
            }
            window.addEventListener('message', handleWalletTwoMessage);
        });

        function handleWalletTwoMessage(event) {
            if (event.origin !== CONFIG.WALLETTWO_ORIGIN) return;
            if (!acceptMessages) return;
            const iframe = document.getElementById('walletTwoFrame');
            if (!iframe || event.source !== iframe.contentWindow) return;
            const data = event.data;
            if (data.type === 'wallet_login' && data.wallet) {
                handleAuthSuccess(data);
            }
        }

        async function handleAuthSuccess(data) {
            acceptMessages = false;
            document.getElementById('loginContainer').innerHTML = `
                <div class="text-center py-16">
                    <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                    <p class="text-slate-500 text-sm">Loading profile...</p>
                </div>
            `;

            try {
                const response = await fetch('/api/wallettwo/exchange', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: data.code })
                });

                if (response.ok) {
                    const result = await response.json();
                    const user = {
                        wallet: result.user?.metadata?.wallet || result.user?.profile?.wallet || data.wallet,
                        email: result.user?.email,
                        name: result.user?.name || result.user?.given_name,
                        nickname: result.user?.nickname,
                        userId: result.user?.sub || data.user,
                        accessToken: result.access_token,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(user));
                    showProfile(user);
                } else {
                    const user = { wallet: data.wallet, userId: data.user, timestamp: Date.now() };
                    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(user));
                    showProfile(user);
                }
            } catch (error) {
                const user = { wallet: data.wallet, userId: data.user, timestamp: Date.now() };
                localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(user));
                showProfile(user);
            }
        }

        function showProfile(user) {
            currentUser = user;
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('profileContainer').classList.remove('hidden');

            const initials = user.name 
                ? user.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)
                : user.wallet.slice(2, 4).toUpperCase();
            
            const displayName = user.name || user.nickname || `User ${user.wallet.slice(2, 4).toUpperCase()}`;
            
            document.getElementById('userAvatar').textContent = initials;
            document.getElementById('userName').textContent = displayName;
            document.getElementById('userEmail').textContent = user.email || '';
            document.getElementById('walletAddress').textContent = user.wallet;
            document.getElementById('explorerLink').href = `${CONFIG.POLYGON_EXPLORER}/token/${CONFIG.VIP_TOKEN_ADDRESS}?a=${user.wallet}`;

            fetchBalance(user.wallet);
        }

        async function fetchBalance(address) {
            const display = document.getElementById('balanceDisplay');
            const claimBtn = document.getElementById('claimBtn');
            const NETWORK_ID = 137;
            const apiUrl = `https://api.wallettwo.com/blockchain/balance/${NETWORK_ID}/${address}/${CONFIG.VIP_TOKEN_ADDRESS}`;
            
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.success && data.balance !== undefined) {
                    const balanceNumber = parseFloat(data.balance);
                    display.innerHTML = `
                        <span class="text-5xl font-serif font-light text-white">${balanceNumber.toFixed(2)}</span>
                        <span class="text-xl text-primary ml-2">VIP</span>
                    `;
                    if (balanceNumber < CONFIG.MIN_BALANCE_TO_HIDE_CLAIM) {
                        claimBtn.classList.remove('hidden');
                        claimBtn.classList.add('flex');
                    }
                } else {
                    fetchBalanceFromRPC(address);
                }
            } catch (error) {
                fetchBalanceFromRPC(address);
            }
        }

        async function fetchBalanceFromRPC(address) {
            const display = document.getElementById('balanceDisplay');
            const claimBtn = document.getElementById('claimBtn');
            try {
                const provider = new ethers.JsonRpcProvider(CONFIG.POLYGON_RPC);
                const contract = new ethers.Contract(CONFIG.VIP_TOKEN_ADDRESS, ERC20_ABI, provider);
                const balance = await contract.balanceOf(address);
                const balanceNumber = parseFloat(ethers.formatUnits(balance, 18));
                display.innerHTML = `
                    <span class="text-5xl font-serif font-light text-white">${balanceNumber.toFixed(2)}</span>
                    <span class="text-xl text-primary ml-2">VIP</span>
                `;
                if (balanceNumber < CONFIG.MIN_BALANCE_TO_HIDE_CLAIM) {
                    claimBtn.classList.remove('hidden');
                    claimBtn.classList.add('flex');
                }
            } catch (error) {
                display.innerHTML = `
                    <span class="text-5xl font-serif font-light text-white">0</span>
                    <span class="text-xl text-primary ml-2">VIP</span>
                `;
                claimBtn.classList.remove('hidden');
                claimBtn.classList.add('flex');
            }
        }

        function copyAddress() {
            if (currentUser?.wallet) {
                navigator.clipboard.writeText(currentUser.wallet);
                const btn = event.target.closest('button');
                const icon = btn.querySelector('.material-symbols-outlined');
                icon.textContent = 'check';
                setTimeout(() => icon.textContent = 'content_copy', 2000);
            }
        }

        function logout() {
            localStorage.removeItem(CONFIG.STORAGE_KEY);
            currentUser = null;
            document.getElementById('profileContainer').innerHTML = `
                <div class="text-center py-16">
                    <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                    <p class="text-slate-500 text-sm">Logging out...</p>
                </div>
            `;
            const logoutIframe = document.createElement('iframe');
            logoutIframe.style.display = 'none';
            logoutIframe.src = 'https://wallet.wallettwo.com/action/logout?iframe=true';
            document.body.appendChild(logoutIframe);
            setTimeout(() => { window.location.href = '/'; }, 1500);
        }
    </script>
</body>
</html>
