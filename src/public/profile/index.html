<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Kea Valley</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%); min-height: 100vh; }
        .glass-card {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .gold-gradient { background: linear-gradient(135deg, #ee9d2b 0%, #d4a543 100%); }
        .gold-text { color: #ee9d2b; }
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(26, 26, 26, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 0.75rem;
        }
        .loading-overlay.hidden { display: none; }
        .btn-gold {
            background: linear-gradient(135deg, #ee9d2b 0%, #d4a543 100%);
            color: #000;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn-gold:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(238, 157, 43, 0.4);
        }
        .btn-outline {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn-outline:hover {
            border-color: #ee9d2b;
            color: #ee9d2b;
        }
        .presale-banner {
            background: linear-gradient(135deg, rgba(238, 157, 43, 0.15) 0%, rgba(212, 165, 67, 0.1) 100%);
            border: 1px solid rgba(238, 157, 43, 0.3);
        }
        .wallet-info {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
        }
        #debug-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: #0f0;
            padding: 10px;
            font-size: 10px;
            max-width: 400px;
            max-height: 300px;
            overflow: auto;
            z-index: 9999;
            border-radius: 4px;
            display: none;
            font-family: monospace;
        }
        #debug-panel.visible { display: block; }
    </style>
</head>
<body class="text-white">
    <!-- Header -->
    <header class="glass-card border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <a href="/" class="text-xl font-bold gold-text">KEA VALLEY¬Æ</a>
            <nav class="flex items-center gap-4">
                <a href="/" class="text-white/60 hover:text-white transition">Home</a>
                <a href="/claim" class="text-white/60 hover:text-white transition">Claim</a>
                <a href="/presale" class="btn-gold text-sm">Join Presale</a>
            </nav>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-12">
        <!-- Page Title -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">My Profile</h1>
            <p class="text-white/60">View your WalletTwo balance and manage your VIP tokens</p>
        </div>

        <!-- Presale Banner - Always Visible -->
        <div id="presaleBanner" class="presale-banner rounded-xl p-6 mb-8">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-2xl">üöÄ</span>
                        <h3 class="text-xl font-bold gold-text">VIP Token Presale Now Live!</h3>
                    </div>
                    <p class="text-white/70 text-sm">Get VIP tokens at the best price. Pay with Card, POL, or USDC.</p>
                    <div id="presaleWalletInfo" class="mt-2 hidden">
                        <span class="text-white/50 text-sm">Connected: </span>
                        <span id="presaleWalletAddress" class="wallet-info text-sm text-green-400"></span>
                    </div>
                </div>
                <a href="/presale" class="btn-gold whitespace-nowrap">Join Presale ‚Üí</a>
            </div>
        </div>

        <!-- Quick Links -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <a href="/" class="btn-outline text-center">‚Üê Back to Home</a>
            <a href="/claim" class="btn-outline text-center">Claim Free Tokens</a>
            <a href="https://wallet.wallettwo.com/wallet/dashboard?tab=Tokens&companyId=6a27c2f8-894c-46c7-bf9f-f5af11d4e092" target="_blank" class="btn-outline text-center">Full WalletTwo ‚Üí</a>
        </div>

        <!-- Info Banner -->
        <div class="glass-card rounded-xl p-4 mb-6 border-l-4 border-blue-500">
            <div class="flex items-start gap-3">
                <svg class="w-6 h-6 text-blue-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <p class="text-white/80">Log in to WalletTwo below to view your VIP token balance.</p>
                    <p class="text-white/60 text-sm mt-1">
                        Don't have an account? 
                        <a href="https://wallet.wallettwo.com/auth/register?companyId=6a27c2f8-894c-46c7-bf9f-f5af11d4e092" target="_blank" class="gold-text hover:underline">Register here ‚Üí</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Wallet Status Panel -->
        <div id="walletStatusPanel" class="glass-card rounded-xl p-4 mb-6 hidden">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="text-white/80">Wallet Connected</span>
                </div>
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4">
                    <span id="connectedEmail" class="text-blue-400 text-sm"></span>
                    <span id="connectedAddress" class="wallet-info text-sm text-green-400"></span>
                </div>
            </div>
        </div>

        <!-- WalletTwo Dashboard Card -->
        <div class="glass-card rounded-xl overflow-hidden">
            <div class="p-4 border-b border-white/10 flex items-center justify-between">
                <h2 class="font-semibold flex items-center gap-2">
                    <svg class="w-5 h-5 gold-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                    WalletTwo Dashboard
                </h2>
                <a href="https://wallet.wallettwo.com/wallet/dashboard?tab=Tokens&companyId=6a27c2f8-894c-46c7-bf9f-f5af11d4e092" target="_blank" class="text-sm text-white/40 hover:text-white/80 transition">
                    Open in new tab ‚Üí
                </a>
            </div>
            <div class="relative" style="min-height: 500px;">
                <!-- Loading Overlay -->
                <div id="loadingOverlay" class="loading-overlay">
                    <div class="text-center">
                        <div class="animate-spin w-8 h-8 border-2 border-white/20 border-t-[#ee9d2b] rounded-full mx-auto mb-4"></div>
                        <p class="text-white/60">Loading WalletTwo...</p>
                    </div>
                </div>
                <!-- WalletTwo iframe -->
                <iframe 
                    id="walletTwoFrame"
                    src="https://wallet.wallettwo.com/wallet/dashboard?tab=Tokens&companyId=6a27c2f8-894c-46c7-bf9f-f5af11d4e092"
                    class="w-full border-0"
                    style="height: 500px;"
                    onload="hideLoading()"
                    allow="clipboard-write"
                ></iframe>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-white/10 mt-16">
        <div class="max-w-7xl mx-auto px-4 py-6 text-center text-white/40 text-sm">
            &copy; 2025 KEA VALLEY¬Æ. All rights reserved.
        </div>
    </footer>

    <!-- Debug Panel -->
    <div id="debug-panel"></div>

    <script>
        // Configuration
        const WALLETTWO_ORIGIN = 'https://wallet.wallettwo.com';
        const STORAGE_KEYS = ['walletTwoSession', 'keavalley_profile', 'walletAddress', 'wallet_address', 'connectedWallet'];
        const DEBUG = new URLSearchParams(window.location.search).has('debug');
        
        // Track if we've already saved this session
        let savedToDatabase = false;
        
        // Debug logging
        function debugLog(msg, data = null) {
            const logMsg = `[${new Date().toLocaleTimeString()}] ${msg}`;
            console.log(logMsg, data || '');
            
            if (!DEBUG) return;
            const panel = document.getElementById('debug-panel');
            panel.classList.add('visible');
            const line = document.createElement('div');
            line.style.borderBottom = '1px solid #333';
            line.style.paddingBottom = '4px';
            line.style.marginBottom = '4px';
            line.innerHTML = `<strong>${msg}</strong>${data ? '<br><span style="color:#aaa">' + JSON.stringify(data, null, 2).substring(0, 200) + '</span>' : ''}`;
            panel.appendChild(line);
            panel.scrollTop = panel.scrollHeight;
        }

        // Hide loading overlay
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
                debugLog('Loading hidden');
            }
        }

        // Fallback to hide loading after 5 seconds
        setTimeout(hideLoading, 5000);

        // Validate wallet address
        function isValidAddress(addr) {
            return addr && typeof addr === 'string' && /^0x[a-fA-F0-9]{40}$/i.test(addr);
        }

        // Format address for display
        function formatAddress(addr) {
            if (!addr || addr.length < 10) return addr || '';
            return `${addr.substring(0, 6)}...${addr.substring(addr.length - 4)}`;
        }

        // Update UI with connected wallet and email
        function updateWalletUI(address, email = null) {
            debugLog('Updating UI', { address, email });
            
            if (!isValidAddress(address)) {
                debugLog('Invalid address for UI update');
                return;
            }
            
            // Update presale banner
            const presaleWalletInfo = document.getElementById('presaleWalletInfo');
            const presaleWalletAddress = document.getElementById('presaleWalletAddress');
            if (presaleWalletInfo && presaleWalletAddress) {
                presaleWalletAddress.textContent = formatAddress(address);
                presaleWalletInfo.classList.remove('hidden');
            }

            // Update wallet status panel
            const statusPanel = document.getElementById('walletStatusPanel');
            const connectedAddress = document.getElementById('connectedAddress');
            const connectedEmail = document.getElementById('connectedEmail');
            
            if (statusPanel && connectedAddress) {
                connectedAddress.textContent = formatAddress(address);
                if (connectedEmail) {
                    if (email) {
                        connectedEmail.textContent = email;
                        connectedEmail.classList.remove('hidden');
                    } else {
                        connectedEmail.classList.add('hidden');
                    }
                }
                statusPanel.classList.remove('hidden');
            }
        }

        // Save wallet and email to database
        async function saveWalletToDatabase(walletAddress, email = null) {
            if (!isValidAddress(walletAddress)) {
                debugLog('Invalid address, not saving');
                return;
            }

            if (savedToDatabase) {
                debugLog('Already saved this session');
                return;
            }

            debugLog('Saving to database', { walletAddress, email });

            try {
                const response = await fetch('/api/wallet/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        walletAddress: walletAddress,
                        email: email || null,
                        source: 'wallettwo'
                    })
                });

                const result = await response.json();
                debugLog('Save result', result);

                if (result.success) {
                    savedToDatabase = true;
                    console.log('‚úÖ Wallet saved to database:', walletAddress, email ? `(${email})` : '');
                }
            } catch (error) {
                console.error('Error saving wallet to database:', error);
                debugLog('Save error', { message: error.message });
            }
        }

        // Store wallet data locally
        function storeWalletData(address, email = null) {
            const data = {
                address: address,
                wallet: address,
                walletAddress: address,
                email: email,
                timestamp: Date.now()
            };
            
            try {
                localStorage.setItem('walletTwoSession', JSON.stringify(data));
                localStorage.setItem('walletAddress', address);
                localStorage.setItem('keavalley_profile', JSON.stringify({
                    wallet: address,
                    walletAddress: address,
                    email: email,
                    connectedAt: new Date().toISOString()
                }));
                debugLog('Stored wallet data locally');
            } catch (e) {
                debugLog('Error storing locally', { error: e.message });
            }
        }

        // Extract wallet and email from message data (handles various WalletTwo formats)
        function extractWalletData(data) {
            let address = null;
            let email = null;

            if (!data) return { address, email };

            debugLog('Extracting from data', data);

            // Direct properties
            address = data.wallet || data.address || data.walletAddress || data.wallet_address || data.publicAddress;
            email = data.email || data.userEmail || data.user_email || data.mail;

            // Nested in user object
            if (data.user && typeof data.user === 'object') {
                address = address || data.user.wallet || data.user.address || data.user.walletAddress || data.user.publicAddress;
                email = email || data.user.email || data.user.userEmail || data.user.mail;
            }

            // Nested in payload
            if (data.payload && typeof data.payload === 'object') {
                address = address || data.payload.wallet || data.payload.address || data.payload.walletAddress;
                email = email || data.payload.email || data.payload.userEmail;
            }

            // Nested in result
            if (data.result && typeof data.result === 'object') {
                address = address || data.result.wallet || data.result.address || data.result.walletAddress;
                email = email || data.result.email || data.result.userEmail;
            }

            // Nested in data property
            if (data.data && typeof data.data === 'object') {
                address = address || data.data.wallet || data.data.address || data.data.walletAddress;
                email = email || data.data.email || data.data.userEmail;
                
                if (data.data.user && typeof data.data.user === 'object') {
                    address = address || data.data.user.wallet || data.data.user.walletAddress;
                    email = email || data.data.user.email;
                }
            }

            debugLog('Extracted', { address, email });
            return { address, email };
        }

        // Handle successful wallet connection
        function handleWalletConnected(address, email) {
            if (!isValidAddress(address)) {
                debugLog('Invalid address in handleWalletConnected');
                return;
            }

            debugLog('Wallet connected!', { address, email });
            
            // Store locally
            storeWalletData(address, email);
            
            // Update UI
            updateWalletUI(address, email);
            
            // Save to database (async)
            saveWalletToDatabase(address, email);
        }

        // Listen for postMessage from WalletTwo iframe
        window.addEventListener('message', function(event) {
            // Accept messages from WalletTwo
            if (!event.origin.includes('wallettwo.com')) {
                return;
            }

            debugLog('postMessage received', { origin: event.origin, data: event.data });

            const data = event.data;
            if (!data) return;

            // Check message type
            const messageType = data.type || data.event || data.action || data.message || '';
            const successTypes = [
                'AUTH_SUCCESS', 'WALLET_CONNECTED', 'LOGIN_SUCCESS', 
                'wallet_login', 'authenticated', 'user_authenticated',
                'AUTHENTICATION_SUCCESS', 'auth_complete', 'login_complete'
            ];

            const isSuccess = successTypes.some(t => 
                messageType.toLowerCase().includes(t.toLowerCase())
            ) || data.success === true || data.authenticated === true || data.loggedIn === true;

            if (isSuccess) {
                debugLog('Auth success detected', messageType);
                const { address, email } = extractWalletData(data);
                
                if (isValidAddress(address)) {
                    handleWalletConnected(address, email);
                } else {
                    debugLog('No valid address in auth success message');
                }
            }
            
            // Also check if data itself contains wallet info (some auth flows)
            const { address, email } = extractWalletData(data);
            if (isValidAddress(address) && !savedToDatabase) {
                handleWalletConnected(address, email);
            }
        });

        // Check for existing wallet on page load
        function checkExistingWallet() {
            debugLog('Checking for existing wallet in storage');

            for (const key of STORAGE_KEYS) {
                try {
                    const stored = localStorage.getItem(key) || sessionStorage.getItem(key);
                    if (!stored) continue;

                    debugLog(`Found: ${key}`);

                    // Try to parse as JSON
                    let data;
                    try {
                        data = JSON.parse(stored);
                    } catch {
                        // Raw address string
                        if (isValidAddress(stored)) {
                            debugLog('Raw address found', stored);
                            updateWalletUI(stored);
                            return true;
                        }
                        continue;
                    }

                    // Check session validity (24 hour window)
                    const timestamp = data.timestamp || data.connectedAt;
                    if (timestamp) {
                        const age = Date.now() - new Date(timestamp).getTime();
                        if (age > 24 * 60 * 60 * 1000) {
                            debugLog('Session expired', key);
                            localStorage.removeItem(key);
                            continue;
                        }
                    }

                    const { address, email } = extractWalletData(data);
                    if (isValidAddress(address)) {
                        debugLog('Restored wallet from storage', { address, email, key });
                        updateWalletUI(address, email);
                        return true;
                    }
                } catch (error) {
                    debugLog(`Error reading ${key}`, { error: error.message });
                }
            }

            debugLog('No existing wallet found');
            return false;
        }

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Page loaded, checking for existing wallet');
            checkExistingWallet();
        });

        // Additional checks for slow iframe loads
        setTimeout(checkExistingWallet, 2000);
        setTimeout(checkExistingWallet, 5000);
    </script>
</body>
</html>