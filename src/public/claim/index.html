<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Claim Tokens | Kea Valley</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ee9d2b", 
                        "primary-light": "#fbdea6",
                        "background-dark": "#0a0a0a",
                        "surface": "#121212",
                    },
                    fontFamily: {
                        "sans": ["Manrope", "sans-serif"],
                        "serif": ["Playfair Display", "serif"],
                    },
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Manrope', sans-serif; }
        h1, h2, h3, h4, .font-serif { font-family: 'Playfair Display', serif; }
        .gold-glow:hover {
            box-shadow: 0 0 25px rgba(238, 157, 43, 0.3);
            border-color: #ee9d2b;
        }
        .glass-nav {
            backdrop-filter: blur(12px);
            background-color: rgba(10, 10, 10, 0.7);
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #ee9d2b; }
    </style>
</head>
<body class="bg-background-dark text-white selection:bg-primary selection:text-background-dark antialiased min-h-screen flex flex-col">

    <!-- Header -->
    <header class="fixed top-0 w-full z-50 glass-nav border-b border-white/5">
        <div class="max-w-7xl mx-auto px-6 lg:px-12 flex items-center justify-between h-20 lg:h-24">
            <a href="/" class="flex items-center gap-4 group cursor-pointer">
                <img src="/images/logo.png" alt="Kea Valley" class="h-12 w-auto"/>
                <div>
                    <h2 class="text-xl font-serif font-bold tracking-widest uppercase text-white">Kea Valley</h2>
                </div>
            </a>
            <nav class="hidden md:flex items-center gap-8 lg:gap-12">
                <a class="text-xs font-bold tracking-widest hover:text-primary transition-colors uppercase" href="/">Home</a>
                <a class="text-xs font-bold tracking-widest hover:text-primary transition-colors uppercase" href="/profile">My Profile</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 pt-32 pb-20 px-6 flex items-center justify-center">
        <div class="max-w-lg mx-auto w-full">
            
            <!-- Page Title -->
            <div class="text-center mb-12">
                <div class="flex items-center justify-center gap-4 mb-6">
                    <div class="h-[1px] w-8 bg-primary"></div>
                    <span class="text-primary tracking-[0.3em] uppercase text-xs font-bold">Token Claim</span>
                    <div class="h-[1px] w-8 bg-primary"></div>
                </div>
                <h1 class="text-4xl md:text-5xl font-serif italic font-medium text-white mb-4">Claim Your Tokens</h1>
                <p class="text-slate-400 font-light">Receive your free VIP tokens to join the Kea Valley community.</p>
            </div>

            <!-- Card -->
            <div class="bg-surface border border-white/5 rounded-sm overflow-hidden">
                <div class="px-8 py-5 border-b border-white/5 flex items-center justify-between">
                    <h3 id="cardTitle" class="text-xs font-bold uppercase tracking-widest text-primary">Claim Status</h3>
                    <span class="material-symbols-outlined text-primary/50">redeem</span>
                </div>
                <div class="p-8">
                    <div id="claimStatus" class="text-center py-8">
                        <div class="w-12 h-12 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
                        <p class="text-slate-400 text-sm">Initializing...</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-background-dark py-8 border-t border-white/5">
        <div class="max-w-7xl mx-auto px-6 lg:px-12">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <a href="/" class="flex items-center gap-2">
                    <img src="/images/logo.png" alt="Kea Valley" class="h-6 w-auto"/>
                    <span class="text-xs font-serif font-bold tracking-widest uppercase text-white">Kea Valley</span>
                </a>
                <div class="text-slate-600 text-xs font-light">
                    ¬© 2026 Kea Valley
                </div>
            </div>
        </div>
    </footer>

    <script>
        // ============================================
        // Configuration
        // ============================================
        const CONFIG = {
            STORAGE_KEY: 'keavalley_profile',
            WALLETTWO_LOGIN_URL: 'https://wallet.wallettwo.com/auth/login?companyId=6a27c2f8-894c-46c7-bf9f-f5af11d4e092&action=signature&message=FREE_BONUS_TOKENS_KEA_VALLEY&redirect_uri=' + encodeURIComponent(window.location.origin + '/claim')
        };

        const statusEl = document.getElementById('claimStatus');
        const cardTitle = document.getElementById('cardTitle');
        
        // Store current wallet globally for use in UI functions
        let currentWallet = null;
        let currentSignature = null;
        let currentUserId = null;

        // ============================================
        // Parse URL Parameters
        // ============================================
        function getWalletFromURL() {
            const params = new URLSearchParams(window.location.search);
            return {
                wallet: params.get('wlt') || params.get('wallet') || params.get('address'),
                signature: params.get('signature') || params.get('sig'),
                userId: params.get('usr') || params.get('user'),
                registered: params.get('registered') === 'true'
            };
        }

        // ============================================
        // Referral Handling
        // ============================================
        let referrerCode = null;
        let referrerWallet = null;

        function checkReferralCode() {
            const params = new URLSearchParams(window.location.search);
            const ref = params.get('ref') || params.get('referrer') || params.get('r');
            
            if (ref) {
                // Store referral code for later use
                sessionStorage.setItem('referralCode', ref);
                validateReferralCode(ref);
            } else {
                // Check if we have a stored referral code
                const storedRef = sessionStorage.getItem('referralCode');
                if (storedRef) {
                    validateReferralCode(storedRef);
                }
            }
        }

        async function validateReferralCode(code) {
            try {
                const response = await fetch(`/api/referral/validate/${code}`);
                const data = await response.json();
                
                if (data.valid) {
                    referrerCode = code;
                    referrerWallet = data.referrerWallet;
                    showReferralBadge(code);
                    console.log('Valid referral code:', code);
                }
            } catch (error) {
                console.error('Failed to validate referral code:', error);
            }
        }

        function showReferralBadge(code) {
            // Check if badge already exists
            if (document.getElementById('referralBadge')) return;
            
            const badge = document.createElement('div');
            badge.id = 'referralBadge';
            badge.className = 'fixed top-24 right-4 bg-primary/20 border border-primary/30 rounded-full px-4 py-2 text-xs text-primary font-bold z-40';
            badge.innerHTML = `üéÅ Referral: ${code}`;
            document.body.appendChild(badge);
        }

        async function trackReferral(walletAddress) {
            if (referrerCode && walletAddress) {
                try {
                    await fetch('/api/referral/track', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            referralCode: referrerCode,
                            referredWallet: walletAddress,
                            referredEmail: null,
                            source: 'claim'
                        })
                    });
                    console.log('Referral tracked');
                    // Clear stored referral code after successful tracking
                    sessionStorage.removeItem('referralCode');
                } catch (e) {
                    console.error('Failed to track referral:', e);
                }
            }
        }

        // ============================================
        // LocalStorage Functions
        // ============================================
        function getWalletFromStorage() {
            try {
                const stored = localStorage.getItem(CONFIG.STORAGE_KEY);
                if (stored) {
                    const data = JSON.parse(stored);
                    const age = Date.now() - (data.timestamp || 0);
                    if (data.wallet && age < 24 * 60 * 60 * 1000) {
                        return data;
                    }
                }
            } catch (e) {}
            return null;
        }

        function saveToStorage(wallet, userId, signature) {
            try {
                localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({
                    wallet,
                    userId,
                    signature,
                    timestamp: Date.now()
                }));
            } catch (e) {}
        }

        // ============================================
        // Get Profile URL with wallet
        // ============================================
        function getProfileURL() {
            if (currentWallet) {
                return `/profile?wlt=${encodeURIComponent(currentWallet)}${currentSignature ? '&signature=' + encodeURIComponent(currentSignature) : ''}${currentUserId ? '&usr=' + encodeURIComponent(currentUserId) : ''}`;
            }
            return '/profile';
        }

        // ============================================
        // Questionnaire Check (uses registrants table)
        // ============================================
        async function checkRegistrationStatus(wallet) {
            try {
                const response = await fetch(`/api/questionnaire/status/${wallet}`);
                const result = await response.json();
                
                console.log('Registration status:', result);
                
                if (result.success) {
                    return {
                        exists: result.exists,
                        registrationComplete: result.registration_complete,
                        hasQuestionnaire: result.has_questionnaire,
                        alreadyMinted: result.already_minted || false
                    };
                }
            } catch (error) {
                console.error('Error checking registration status:', error);
            }
            
            // Default: new user, needs questionnaire
            return {
                exists: false,
                registrationComplete: false,
                hasQuestionnaire: false,
                alreadyMinted: false
            };
        }

        function redirectToQuestionnaire(wallet, signature, userId) {
            // Build URL with all params
            let url = `/claim/questionnaire.html?wallet=${encodeURIComponent(wallet)}`;
            if (signature) url += `&signature=${encodeURIComponent(signature)}`;
            if (userId) url += `&usr=${encodeURIComponent(userId)}`;
            
            // Preserve referral code
            const storedRef = sessionStorage.getItem('referralCode');
            if (storedRef) url += `&ref=${encodeURIComponent(storedRef)}`;
            
            console.log('Redirecting to questionnaire:', url);
            window.location.href = url;
        }

        // ============================================
        // UI Functions
        // ============================================
        function showConnectWallet() {
            cardTitle.textContent = 'Connect Wallet';
            statusEl.innerHTML = `
                <div class="size-16 mx-auto rounded-full bg-primary/10 border border-primary/20 flex items-center justify-center mb-6">
                    <span class="material-symbols-outlined text-primary text-3xl">account_balance_wallet</span>
                </div>
                <h3 class="text-xl font-serif text-white mb-2">Connect Your Wallet</h3>
                <p class="text-slate-500 text-sm mb-8">Please connect your wallet to claim your free VIP tokens.</p>
                <a href="${CONFIG.WALLETTWO_LOGIN_URL}" class="inline-block bg-primary text-background-dark px-8 py-4 rounded-sm font-bold uppercase tracking-widest text-xs gold-glow hover:translate-y-[-2px] transition-transform">
                    Connect Wallet
                </a>
            `;
        }

        function showProcessing(wallet) {
            cardTitle.textContent = 'Processing';
            statusEl.innerHTML = `
                <div class="w-12 h-12 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
                <p class="text-slate-400 text-sm">Processing your claim...</p>
                <p class="text-slate-600 text-xs mt-2 font-mono">${wallet.slice(0, 10)}...${wallet.slice(-8)}</p>
            `;
        }

        function showCheckingRegistration(wallet) {
            cardTitle.textContent = 'Verifying';
            statusEl.innerHTML = `
                <div class="w-12 h-12 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
                <p class="text-slate-400 text-sm">Checking registration status...</p>
                <p class="text-slate-600 text-xs mt-2 font-mono">${wallet.slice(0, 10)}...${wallet.slice(-8)}</p>
            `;
        }

        function showSuccess(data) {
            cardTitle.textContent = data.tx_status === 'pending' ? 'Processing' : 'Success';
            
            const isPending = data.tx_status === 'pending';
            
            statusEl.innerHTML = `
                <div class="size-16 mx-auto rounded-full ${isPending ? 'bg-yellow-500/10 border-yellow-500/20' : 'bg-green-500/10 border-green-500/20'} border flex items-center justify-center mb-6">
                    <span class="material-symbols-outlined ${isPending ? 'text-yellow-400' : 'text-green-400'} text-3xl">
                        ${isPending ? 'schedule' : 'check_circle'}
                    </span>
                </div>
                <h3 class="text-xl font-serif text-white mb-2">
                    ${isPending ? 'Tokens Being Minted' : 'Tokens Claimed!'}
                </h3>
                <p class="text-slate-400 text-sm mb-4">
                    ${data.message || (isPending 
                        ? 'Your transaction is being processed. This may take a few minutes.' 
                        : 'Your VIP tokens have been minted successfully.')}
                </p>
                ${data.tx_hash ? `
                    <a href="${data.explorer_url || `https://polygonscan.com/tx/${data.tx_hash}`}" target="_blank" class="inline-flex items-center gap-2 text-primary text-xs hover:underline mb-6">
                        ${isPending ? 'Track Transaction' : 'View Transaction'} <span class="material-symbols-outlined text-sm">open_in_new</span>
                    </a>
                ` : '<p class="text-slate-500 text-xs mb-6">Transaction hash will appear shortly...</p>'}
                <div>
                    <a href="${getProfileURL()}" class="inline-block bg-primary text-background-dark px-8 py-4 rounded-sm font-bold uppercase tracking-widest text-xs gold-glow hover:translate-y-[-2px] transition-transform">
                        View My Profile
                    </a>
                </div>
            `;
        }

        function showAlreadyClaimed(data) {
            cardTitle.textContent = 'Already Claimed';
            statusEl.innerHTML = `
                <div class="size-16 mx-auto rounded-full bg-primary/10 border border-primary/20 flex items-center justify-center mb-6">
                    <span class="material-symbols-outlined text-primary text-3xl">info</span>
                </div>
                <h3 class="text-xl font-serif text-white mb-2">Already Claimed</h3>
                <p class="text-slate-400 text-sm mb-2">${data.message || 'This wallet has already claimed tokens.'}</p>
                ${data.balance ? `<p class="text-primary text-lg font-semibold mb-6">Balance: ${parseFloat(data.balance).toFixed(2)} VIP</p>` : '<div class="mb-6"></div>'}
                <a href="${getProfileURL()}" class="inline-block bg-primary text-background-dark px-8 py-4 rounded-sm font-bold uppercase tracking-widest text-xs gold-glow hover:translate-y-[-2px] transition-transform">
                    View My Profile
                </a>
            `;
        }

        function showError(message) {
            cardTitle.textContent = 'Error';
            statusEl.innerHTML = `
                <div class="size-16 mx-auto rounded-full bg-red-500/10 border border-red-500/20 flex items-center justify-center mb-6">
                    <span class="material-symbols-outlined text-red-400 text-3xl">error</span>
                </div>
                <h3 class="text-xl font-serif text-white mb-2">Claim Failed</h3>
                <p class="text-slate-500 text-sm mb-8">${message}</p>
                <a href="${CONFIG.WALLETTWO_LOGIN_URL}" class="inline-block border border-primary/30 text-primary px-8 py-4 rounded-sm font-bold uppercase tracking-widest text-xs hover:bg-primary hover:text-background-dark transition-all">
                    Try Again
                </a>
            `;
        }

        // ============================================
// Register Wallet (creates registrant in DB)
// ============================================
        async function registerWallet(wallet, email, name) {
            try {
                const response = await fetch('/api/wallet/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        walletAddress: wallet,
                        email: email || null,
                        name: name || null,
                        source: 'claim-page'
                    })
                });
                const data = await response.json();
                console.log('[Wallet Connect] Response:', data);
                return data.success;
            } catch (error) {
                console.error('[Wallet Connect] Error:', error);
                return false;
            }
        }

        // ============================================
        // Claim Processing
        // ============================================
        async function processClaim(wallet, signature, userId, skipQuestionnaireCheck = false) {
            // Store globally
            currentWallet = wallet;
            currentSignature = signature;
            currentUserId = userId;
            
            // Save to storage
            saveToStorage(wallet, userId, signature);

            // FIRST: Register the wallet (creates registrant if not exists)
            showCheckingRegistration(wallet);
            await registerWallet(wallet, null, null);

            // Check registration status (questionnaire completion)
            if (!skipQuestionnaireCheck) {
                const status = await checkRegistrationStatus(wallet);
                
                console.log('Status check result:', status);

                // If user hasn't completed questionnaire, redirect
                if (!status.registrationComplete) {
                    console.log('Questionnaire not complete, redirecting...');
                    redirectToQuestionnaire(wallet, signature, userId);
                    return;
                }
                
                // If already minted AND registration complete, show already claimed
                if (status.alreadyMinted && status.registrationComplete) {
                    showAlreadyClaimed({ message: 'This wallet has already claimed tokens.' });
                    return;
                }
            }

            // User has completed registration, proceed with claim
            showProcessing(wallet);

            try {
                const response = await fetch('/api/claim/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        wallet_address: wallet,
                        signature: signature,
                        message: 'FREE_BONUS_TOKENS_KEA_VALLEY'
                    })
                });

                const data = await response.json();

                if (response.status === 201) {
                    await trackReferral(wallet);
                    showSuccess(data);
                } else if (response.status === 409) {
                    showAlreadyClaimed(data);
                } else {
                    showError(data.message || data.error || 'An error occurred. Please try again.');
                }
            } catch (error) {
                console.error('Claim error:', error);
                showError('Connection error. Please try again.');
            }
        }
        // ============================================
        // Initialize
        // ============================================
        function init() {
            // Check for referral code first
            checkReferralCode();
            
            const { wallet, signature, userId, registered } = getWalletFromURL();
            
            console.log('Init - URL params:', { wallet, signature, userId, registered });
            
            if (wallet) {
                // If registered=true, user is coming back from questionnaire
                processClaim(wallet, signature, userId, registered);
                return;
            }

            const stored = getWalletFromStorage();
            if (stored && stored.wallet) {
                console.log('Init - Found stored wallet:', stored.wallet);
                processClaim(stored.wallet, stored.signature, stored.userId, false);
                return;
            }

            showConnectWallet();
        }

        init();
    </script>
</body>
</html>
